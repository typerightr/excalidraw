var su=Object.create;var oa=Object.defineProperty;var au=Object.getOwnPropertyDescriptor;var lu=Object.getOwnPropertyNames;var du=Object.getPrototypeOf,cu=Object.prototype.hasOwnProperty;var uu=(e,t)=>()=>(e&&(t=e(e=0)),t);var mu=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var pu=(e,t,n,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of lu(t))!cu.call(e,o)&&o!==n&&oa(e,o,{get:()=>t[o],enumerable:!(i=au(t,o))||i.enumerable});return e};var fu=(e,t,n)=>(n=e!=null?su(du(e)):{},pu(t||!e||!e.__esModule?oa(n,"default",{value:e,enumerable:!0}):n,e));var v,P=uu(()=>{v={PROD:!0}});var dc=mu((jP,lc)=>{P();var ac="Expected a function",rc=NaN,kh="[object Symbol]",Fh=/^\s+|\s+$/g,Rh=/^[-+]0x[0-9a-f]+$/i,Nh=/^0b[01]+$/i,zh=/^0o[0-7]+$/i,Hh=parseInt,_h=typeof global=="object"&&global&&global.Object===Object&&global,Uh=typeof self=="object"&&self&&self.Object===Object&&self,Yh=_h||Uh||Function("return this")(),Wh=Object.prototype,jh=Wh.toString,Xh=Math.max,Vh=Math.min,Fs=function(){return Yh.Date.now()};function $h(e,t,n){var i,o,r,s,a,l,d=0,c=!1,u=!1,m=!0;if(typeof e!="function")throw new TypeError(ac);t=sc(t)||0,Zo(n)&&(c=!!n.leading,u="maxWait"in n,r=u?Xh(sc(n.maxWait)||0,t):r,m="trailing"in n?!!n.trailing:m);function p(I){var S=i,T=o;return i=o=void 0,d=I,s=e.apply(T,S),s}function f(I){return d=I,a=setTimeout(g,t),c?p(I):s}function h(I){var S=I-l,T=I-d,A=t-S;return u?Vh(A,r-T):A}function E(I){var S=I-l,T=I-d;return l===void 0||S>=t||S<0||u&&T>=r}function g(){var I=Fs();if(E(I))return x(I);a=setTimeout(g,h(I))}function x(I){return a=void 0,m&&i?p(I):(i=o=void 0,s)}function w(){a!==void 0&&clearTimeout(a),d=0,i=l=o=a=void 0}function y(){return a===void 0?s:x(Fs())}function b(){var I=Fs(),S=E(I);if(i=arguments,o=this,l=I,S){if(a===void 0)return f(l);if(u)return a=setTimeout(g,t),p(l)}return a===void 0&&(a=setTimeout(g,t)),s}return b.cancel=w,b.flush=y,b}function Zh(e,t,n){var i=!0,o=!0;if(typeof e!="function")throw new TypeError(ac);return Zo(n)&&(i="leading"in n?!!n.leading:i,o="trailing"in n?!!n.trailing:o),$h(e,t,{leading:i,maxWait:t,trailing:o})}function Zo(e){var t=typeof e;return!!e&&(t=="object"||t=="function")}function qh(e){return!!e&&typeof e=="object"}function Kh(e){return typeof e=="symbol"||qh(e)&&jh.call(e)==kh}function sc(e){if(typeof e=="number")return e;if(Kh(e))return rc;if(Zo(e)){var t=typeof e.valueOf=="function"?e.valueOf():e;e=Zo(t)?t+"":t}if(typeof e!="string")return e===0?e:+e;e=e.replace(Fh,"");var n=Nh.test(e);return n||zh.test(e)?Hh(e.slice(2),n?2:8):Rh.test(e)?rc:+e}lc.exports=Zh});P();import{toIterable as Ig}from"@excalidraw/common";P();import{SHIFT_LOCKING_ANGLE as jt,viewportCoordsToSceneCoords as jo}from"@excalidraw/common";import{normalizeRadians as Hd,radiansBetweenAngles as uh,radiansDifference as mh}from"@excalidraw/math";import{pointsEqual as ph}from"@excalidraw/math";P();P();P();P();P();P();P();P();P();function ur(e,t,n){if(e&&e.length){let[i,o]=t,r=Math.PI/180*n,s=Math.cos(r),a=Math.sin(r);for(let l of e){let[d,c]=l;l[0]=(d-i)*s-(c-o)*a+i,l[1]=(d-i)*a+(c-o)*s+o}}}function Eu(e,t,n){let i=[];e.forEach(o=>i.push(...o)),ur(i,t,n)}function gu(e,t){return e[0]===t[0]&&e[1]===t[1]}function ra(e,t,n,i=1){let o=n,r=Math.max(t,.1),s=e[0]&&e[0][0]&&typeof e[0][0]=="number"?[e]:e,a=[0,0];if(o)for(let d of s)ur(d,a,o);let l=xu(s,r,i);if(o){for(let d of s)ur(d,a,-o);Eu(l,a,-o)}return l}function xu(e,t,n){let i=[];for(let d of e){let c=[...d];gu(c[0],c[c.length-1])||c.push([c[0][0],c[0][1]]),c.length>2&&i.push(c)}let o=[];t=Math.max(t,.1);let r=[];for(let d of i)for(let c=0;c<d.length-1;c++){let u=d[c],m=d[c+1];if(u[1]!==m[1]){let p=Math.min(u[1],m[1]);r.push({ymin:p,ymax:Math.max(u[1],m[1]),x:p===u[1]?u[0]:m[0],islope:(m[0]-u[0])/(m[1]-u[1])})}}if(r.sort((d,c)=>d.ymin<c.ymin?-1:d.ymin>c.ymin?1:d.x<c.x?-1:d.x>c.x?1:d.ymax===c.ymax?0:(d.ymax-c.ymax)/Math.abs(d.ymax-c.ymax)),!r.length)return o;let s=[],a=r[0].ymin,l=0;for(;s.length||r.length;){if(r.length){let d=-1;for(let u=0;u<r.length&&!(r[u].ymin>a);u++)d=u;r.splice(0,d+1).forEach(u=>{s.push({s:a,edge:u})})}if(s=s.filter(d=>!(d.edge.ymax<=a)),s.sort((d,c)=>d.edge.x===c.edge.x?0:(d.edge.x-c.edge.x)/Math.abs(d.edge.x-c.edge.x)),(n!==1||l%t===0)&&s.length>1)for(let d=0;d<s.length;d=d+2){let c=d+1;if(c>=s.length)break;let u=s[d].edge,m=s[c].edge;o.push([[Math.round(u.x),a],[Math.round(m.x),a]])}a+=n,s.forEach(d=>{d.edge.x=d.edge.x+n*d.edge.islope}),l++}return o}function ft(e,t){var n;let i=t.hachureAngle+90,o=t.hachureGap;o<0&&(o=t.strokeWidth*4),o=Math.max(o,.1);let r=1;return t.roughness>=1&&(((n=t.randomizer)===null||n===void 0?void 0:n.next())||Math.random())>.7&&(r=o),ra(e,o,i,r||1)}var Zt=class{constructor(t){this.helper=t}fillPolygons(t,n){return this._fillPolygons(t,n)}_fillPolygons(t,n){let i=ft(t,n);return{type:"fillSketch",ops:this.renderLines(i,n)}}renderLines(t,n){let i=[];for(let o of t)i.push(...this.helper.doubleLineOps(o[0][0],o[0][1],o[1][0],o[1][1],n));return i}};P();P();function qt(e){let t=e[0],n=e[1];return Math.sqrt(Math.pow(t[0]-n[0],2)+Math.pow(t[1]-n[1],2))}var Wi=class extends Zt{fillPolygons(t,n){let i=n.hachureGap;i<0&&(i=n.strokeWidth*4),i=Math.max(i,.1);let o=Object.assign({},n,{hachureGap:i}),r=ft(t,o),s=Math.PI/180*n.hachureAngle,a=[],l=i*.5*Math.cos(s),d=i*.5*Math.sin(s);for(let[u,m]of r)qt([u,m])&&a.push([[u[0]-l,u[1]+d],[...m]],[[u[0]+l,u[1]-d],[...m]]);return{type:"fillSketch",ops:this.renderLines(a,n)}}};P();var ji=class extends Zt{fillPolygons(t,n){let i=this._fillPolygons(t,n),o=Object.assign({},n,{hachureAngle:n.hachureAngle+90}),r=this._fillPolygons(t,o);return i.ops=i.ops.concat(r.ops),i}};P();var Xi=class{constructor(t){this.helper=t}fillPolygons(t,n){n=Object.assign({},n,{hachureAngle:0});let i=ft(t,n);return this.dotsOnLines(i,n)}dotsOnLines(t,n){let i=[],o=n.hachureGap;o<0&&(o=n.strokeWidth*4),o=Math.max(o,.1);let r=n.fillWeight;r<0&&(r=n.strokeWidth/2);let s=o/4;for(let a of t){let l=qt(a),d=l/o,c=Math.ceil(d)-1,u=l-c*o,m=(a[0][0]+a[1][0])/2-o/4,p=Math.min(a[0][1],a[1][1]);for(let f=0;f<c;f++){let h=p+u+f*o,E=m-s+Math.random()*2*s,g=h-s+Math.random()*2*s,x=this.helper.ellipse(E,g,r,r,n);i.push(...x.ops)}}return{type:"fillSketch",ops:i}}};P();var Vi=class{constructor(t){this.helper=t}fillPolygons(t,n){let i=ft(t,n);return{type:"fillSketch",ops:this.dashedLine(i,n)}}dashedLine(t,n){let i=n.dashOffset<0?n.hachureGap<0?n.strokeWidth*4:n.hachureGap:n.dashOffset,o=n.dashGap<0?n.hachureGap<0?n.strokeWidth*4:n.hachureGap:n.dashGap,r=[];return t.forEach(s=>{let a=qt(s),l=Math.floor(a/(i+o)),d=(a+o-l*(i+o))/2,c=s[0],u=s[1];c[0]>u[0]&&(c=s[1],u=s[0]);let m=Math.atan((u[1]-c[1])/(u[0]-c[0]));for(let p=0;p<l;p++){let f=p*(i+o),h=f+i,E=[c[0]+f*Math.cos(m)+d*Math.cos(m),c[1]+f*Math.sin(m)+d*Math.sin(m)],g=[c[0]+h*Math.cos(m)+d*Math.cos(m),c[1]+h*Math.sin(m)+d*Math.sin(m)];r.push(...this.helper.doubleLineOps(E[0],E[1],g[0],g[1],n))}}),r}};P();var $i=class{constructor(t){this.helper=t}fillPolygons(t,n){let i=n.hachureGap<0?n.strokeWidth*4:n.hachureGap,o=n.zigzagOffset<0?i:n.zigzagOffset;n=Object.assign({},n,{hachureGap:i+o});let r=ft(t,n);return{type:"fillSketch",ops:this.zigzagLines(r,o,n)}}zigzagLines(t,n,i){let o=[];return t.forEach(r=>{let s=qt(r),a=Math.round(s/(2*n)),l=r[0],d=r[1];l[0]>d[0]&&(l=r[1],d=r[0]);let c=Math.atan((d[1]-l[1])/(d[0]-l[0]));for(let u=0;u<a;u++){let m=u*2*n,p=(u+1)*2*n,f=Math.sqrt(2*Math.pow(n,2)),h=[l[0]+m*Math.cos(c),l[1]+m*Math.sin(c)],E=[l[0]+p*Math.cos(c),l[1]+p*Math.sin(c)],g=[h[0]+f*Math.cos(c+Math.PI/4),h[1]+f*Math.sin(c+Math.PI/4)];o.push(...this.helper.doubleLineOps(h[0],h[1],g[0],g[1],i),...this.helper.doubleLineOps(g[0],g[1],E[0],E[1],i))}}),o}};var Oe={};function sa(e,t){let n=e.fillStyle||"hachure";if(!Oe[n])switch(n){case"zigzag":Oe[n]||(Oe[n]=new Wi(t));break;case"cross-hatch":Oe[n]||(Oe[n]=new ji(t));break;case"dots":Oe[n]||(Oe[n]=new Xi(t));break;case"dashed":Oe[n]||(Oe[n]=new Vi(t));break;case"zigzag-line":Oe[n]||(Oe[n]=new $i(t));break;case"hachure":default:n="hachure",Oe[n]||(Oe[n]=new Zt(t));break}return Oe[n]}P();function aa(){return Math.floor(Math.random()*2**31)}var Zi=class{constructor(t){this.seed=t}next(){return this.seed?(2**31-1&(this.seed=Math.imul(48271,this.seed)))/2**31:Math.random()}};P();P();var qi={A:7,a:7,C:6,c:6,H:1,h:1,L:2,l:2,M:2,m:2,Q:4,q:4,S:4,s:4,T:2,t:2,V:1,v:1,Z:0,z:0};function wu(e){let t=new Array;for(;e!=="";)if(e.match(/^([ \t\r\n,]+)/))e=e.substr(RegExp.$1.length);else if(e.match(/^([aAcChHlLmMqQsStTvVzZ])/))t[t.length]={type:0,text:RegExp.$1},e=e.substr(RegExp.$1.length);else if(e.match(/^(([-+]?[0-9]+(\.[0-9]*)?|[-+]?\.[0-9]+)([eE][-+]?[0-9]+)?)/))t[t.length]={type:1,text:`${parseFloat(RegExp.$1)}`},e=e.substr(RegExp.$1.length);else return[];return t[t.length]={type:2,text:""},t}function mr(e,t){return e.type===t}function zn(e){let t=[],n=wu(e),i="BOD",o=0,r=n[o];for(;!mr(r,2);){let s=0,a=[];if(i==="BOD")if(r.text==="M"||r.text==="m")o++,s=qi[r.text],i=r.text;else return zn("M0,0"+e);else mr(r,1)?s=qi[i]:(o++,s=qi[r.text],i=r.text);if(o+s<n.length){for(let l=o;l<o+s;l++){let d=n[l];if(mr(d,1))a[a.length]=+d.text;else throw new Error("Param not a number: "+i+","+d.text)}if(typeof qi[i]=="number"){let l={key:i,data:a};t.push(l),o+=s,r=n[o],i==="M"&&(i="L"),i==="m"&&(i="l")}else throw new Error("Bad segment: "+i)}else throw new Error("Path data ended short")}return t}P();function ri(e){let t=0,n=0,i=0,o=0,r=[];for(let{key:s,data:a}of e)switch(s){case"M":r.push({key:"M",data:[...a]}),[t,n]=a,[i,o]=a;break;case"m":t+=a[0],n+=a[1],r.push({key:"M",data:[t,n]}),i=t,o=n;break;case"L":r.push({key:"L",data:[...a]}),[t,n]=a;break;case"l":t+=a[0],n+=a[1],r.push({key:"L",data:[t,n]});break;case"C":r.push({key:"C",data:[...a]}),t=a[4],n=a[5];break;case"c":{let l=a.map((d,c)=>c%2?d+n:d+t);r.push({key:"C",data:l}),t=l[4],n=l[5];break}case"Q":r.push({key:"Q",data:[...a]}),t=a[2],n=a[3];break;case"q":{let l=a.map((d,c)=>c%2?d+n:d+t);r.push({key:"Q",data:l}),t=l[2],n=l[3];break}case"A":r.push({key:"A",data:[...a]}),t=a[5],n=a[6];break;case"a":t+=a[5],n+=a[6],r.push({key:"A",data:[a[0],a[1],a[2],a[3],a[4],t,n]});break;case"H":r.push({key:"H",data:[...a]}),t=a[0];break;case"h":t+=a[0],r.push({key:"H",data:[t]});break;case"V":r.push({key:"V",data:[...a]}),n=a[0];break;case"v":n+=a[0],r.push({key:"V",data:[n]});break;case"S":r.push({key:"S",data:[...a]}),t=a[2],n=a[3];break;case"s":{let l=a.map((d,c)=>c%2?d+n:d+t);r.push({key:"S",data:l}),t=l[2],n=l[3];break}case"T":r.push({key:"T",data:[...a]}),t=a[0],n=a[1];break;case"t":t+=a[0],n+=a[1],r.push({key:"T",data:[t,n]});break;case"Z":case"z":r.push({key:"Z",data:[]}),t=i,n=o;break}return r}P();function ai(e){let t=[],n="",i=0,o=0,r=0,s=0,a=0,l=0;for(let{key:d,data:c}of e){switch(d){case"M":t.push({key:"M",data:[...c]}),[i,o]=c,[r,s]=c;break;case"C":t.push({key:"C",data:[...c]}),i=c[4],o=c[5],a=c[2],l=c[3];break;case"L":t.push({key:"L",data:[...c]}),[i,o]=c;break;case"H":i=c[0],t.push({key:"L",data:[i,o]});break;case"V":o=c[0],t.push({key:"L",data:[i,o]});break;case"S":{let u=0,m=0;n==="C"||n==="S"?(u=i+(i-a),m=o+(o-l)):(u=i,m=o),t.push({key:"C",data:[u,m,...c]}),a=c[0],l=c[1],i=c[2],o=c[3];break}case"T":{let[u,m]=c,p=0,f=0;n==="Q"||n==="T"?(p=i+(i-a),f=o+(o-l)):(p=i,f=o);let h=i+2*(p-i)/3,E=o+2*(f-o)/3,g=u+2*(p-u)/3,x=m+2*(f-m)/3;t.push({key:"C",data:[h,E,g,x,u,m]}),a=p,l=f,i=u,o=m;break}case"Q":{let[u,m,p,f]=c,h=i+2*(u-i)/3,E=o+2*(m-o)/3,g=p+2*(u-p)/3,x=f+2*(m-f)/3;t.push({key:"C",data:[h,E,g,x,p,f]}),a=u,l=m,i=p,o=f;break}case"A":{let u=Math.abs(c[0]),m=Math.abs(c[1]),p=c[2],f=c[3],h=c[4],E=c[5],g=c[6];u===0||m===0?(t.push({key:"C",data:[i,o,E,g,E,g]}),i=E,o=g):(i!==E||o!==g)&&(la(i,o,E,g,u,m,p,f,h).forEach(function(w){t.push({key:"C",data:w})}),i=E,o=g);break}case"Z":t.push({key:"Z",data:[]}),i=r,o=s;break}n=d}return t}function bu(e){return Math.PI*e/180}function si(e,t,n){let i=e*Math.cos(n)-t*Math.sin(n),o=e*Math.sin(n)+t*Math.cos(n);return[i,o]}function la(e,t,n,i,o,r,s,a,l,d){let c=bu(s),u=[],m=0,p=0,f=0,h=0;if(d)[m,p,f,h]=d;else{[e,t]=si(e,t,-c),[n,i]=si(n,i,-c);let k=(e-n)/2,C=(t-i)/2,X=k*k/(o*o)+C*C/(r*r);X>1&&(X=Math.sqrt(X),o=X*o,r=X*r);let N=a===l?-1:1,Z=o*o,L=r*r,M=Z*L-Z*C*C-L*k*k,U=Z*C*C+L*k*k,Y=N*Math.sqrt(Math.abs(M/U));f=Y*o*C/r+(e+n)/2,h=Y*-r*k/o+(t+i)/2,m=Math.asin(parseFloat(((t-h)/r).toFixed(9))),p=Math.asin(parseFloat(((i-h)/r).toFixed(9))),e<f&&(m=Math.PI-m),n<f&&(p=Math.PI-p),m<0&&(m=Math.PI*2+m),p<0&&(p=Math.PI*2+p),l&&m>p&&(m=m-Math.PI*2),!l&&p>m&&(p=p-Math.PI*2)}let E=p-m;if(Math.abs(E)>Math.PI*120/180){let k=p,C=n,X=i;l&&p>m?p=m+Math.PI*120/180*1:p=m+Math.PI*120/180*-1,n=f+o*Math.cos(p),i=h+r*Math.sin(p),u=la(n,i,C,X,o,r,s,0,l,[p,k,f,h])}E=p-m;let g=Math.cos(m),x=Math.sin(m),w=Math.cos(p),y=Math.sin(p),b=Math.tan(E/4),I=4/3*o*b,S=4/3*r*b,T=[e,t],A=[e+I*x,t-S*g],F=[n+I*y,i-S*w],B=[n,i];if(A[0]=2*T[0]-A[0],A[1]=2*T[1]-A[1],d)return[A,F,B].concat(u);{u=[A,F,B].concat(u);let k=[];for(let C=0;C<u.length;C+=3){let X=si(u[C][0],u[C][1],c),N=si(u[C+1][0],u[C+1][1],c),Z=si(u[C+2][0],u[C+2][1],c);k.push([X[0],X[1],N[0],N[1],Z[0],Z[1]])}return k}}var yu={randOffset:Su,randOffsetWithRange:Au,ellipse:Iu,doubleLineOps:Mu};function pr(e,t,n,i,o){return{type:"path",ops:Mt(e,t,n,i,o)}}function li(e,t,n){let i=(e||[]).length;if(i>2){let o=[];for(let r=0;r<i-1;r++)o.push(...Mt(e[r][0],e[r][1],e[r+1][0],e[r+1][1],n));return t&&o.push(...Mt(e[i-1][0],e[i-1][1],e[0][0],e[0][1],n)),{type:"path",ops:o}}else if(i===2)return pr(e[0][0],e[0][1],e[1][0],e[1][1],n);return{type:"path",ops:[]}}function Pu(e,t){return li(e,!0,t)}function pa(e,t,n,i,o){let r=[[e,t],[e+n,t],[e+n,t+i],[e,t+i]];return Pu(r,o)}function fr(e,t){let n=ca(e,1*(1+t.roughness*.2),t);if(!t.disableMultiStroke){let i=ca(e,1.5*(1+t.roughness*.22),Tu(t));n=n.concat(i)}return{type:"path",ops:n}}function Iu(e,t,n,i,o){let r=hr(n,i,o);return Ji(e,t,o,r).opset}function hr(e,t,n){let i=Math.sqrt(Math.PI*2*Math.sqrt((Math.pow(e/2,2)+Math.pow(t/2,2))/2)),o=Math.ceil(Math.max(n.curveStepCount,n.curveStepCount/Math.sqrt(200)*i)),r=Math.PI*2/o,s=Math.abs(e/2),a=Math.abs(t/2),l=1-n.curveFitting;return s+=R(s*l,n),a+=R(a*l,n),{increment:r,rx:s,ry:a}}function Ji(e,t,n,i){let[o,r]=ua(i.increment,e,t,i.rx,i.ry,1,i.increment*Ki(.1,Ki(.4,1,n),n),n),s=Qi(o,null,n);if(!n.disableMultiStroke&&n.roughness!==0){let[a]=ua(i.increment,e,t,i.rx,i.ry,1.5,0,n),l=Qi(a,null,n);s=s.concat(l)}return{estimatedPoints:r,opset:{type:"path",ops:s}}}function Er(e,t,n,i,o,r,s,a,l){let d=e,c=t,u=Math.abs(n/2),m=Math.abs(i/2);u+=R(u*.01,l),m+=R(m*.01,l);let p=o,f=r;for(;p<0;)p+=Math.PI*2,f+=Math.PI*2;f-p>Math.PI*2&&(p=0,f=Math.PI*2);let h=Math.PI*2/l.curveStepCount,E=Math.min(h/2,(f-p)/2),g=ma(E,d,c,u,m,p,f,1,l);if(!l.disableMultiStroke){let x=ma(E,d,c,u,m,p,f,1.5,l);g.push(...x)}return s&&(a?g.push(...Mt(d,c,d+u*Math.cos(p),c+m*Math.sin(p),l),...Mt(d,c,d+u*Math.cos(f),c+m*Math.sin(f),l)):g.push({op:"lineTo",data:[d,c]},{op:"lineTo",data:[d+u*Math.cos(p),c+m*Math.sin(p)]})),{type:"path",ops:g}}function gr(e,t){let n=ai(ri(zn(e))),i=[],o=[0,0],r=[0,0];for(let{key:s,data:a}of n)switch(s){case"M":{r=[a[0],a[1]],o=[a[0],a[1]];break}case"L":i.push(...Mt(r[0],r[1],a[0],a[1],t)),r=[a[0],a[1]];break;case"C":{let[l,d,c,u,m,p]=a;i.push(...vu(l,d,c,u,m,p,r,t)),r=[m,p];break}case"Z":i.push(...Mt(r[0],r[1],o[0],o[1],t)),r=[o[0],o[1]];break}return{type:"path",ops:i}}function eo(e,t){let n=[];for(let i of e)if(i.length){let o=t.maxRandomnessOffset||0,r=i.length;if(r>2){n.push({op:"move",data:[i[0][0]+R(o,t),i[0][1]+R(o,t)]});for(let s=1;s<r;s++)n.push({op:"lineTo",data:[i[s][0]+R(o,t),i[s][1]+R(o,t)]})}}return{type:"fillPath",ops:n}}function In(e,t){return sa(t,yu).fillPolygons(e,t)}function fa(e,t,n,i,o,r,s){let a=e,l=t,d=Math.abs(n/2),c=Math.abs(i/2);d+=R(d*.01,s),c+=R(c*.01,s);let u=o,m=r;for(;u<0;)u+=Math.PI*2,m+=Math.PI*2;m-u>Math.PI*2&&(u=0,m=Math.PI*2);let p=(m-u)/s.curveStepCount,f=[];for(let h=u;h<=m;h=h+p)f.push([a+d*Math.cos(h),l+c*Math.sin(h)]);return f.push([a+d*Math.cos(m),l+c*Math.sin(m)]),f.push([a,l]),In([f],s)}function Su(e,t){return R(e,t)}function Au(e,t,n){return Ki(e,t,n)}function Mu(e,t,n,i,o){return Mt(e,t,n,i,o,!0)}function Tu(e){let t=Object.assign({},e);return t.randomizer=void 0,e.seed&&(t.seed=e.seed+1),t}function ha(e){return e.randomizer||(e.randomizer=new Zi(e.seed||0)),e.randomizer.next()}function Ki(e,t,n,i=1){return n.roughness*i*(ha(n)*(t-e)+e)}function R(e,t,n=1){return Ki(-e,e,t,n)}function Mt(e,t,n,i,o,r=!1){let s=r?o.disableMultiStrokeFill:o.disableMultiStroke,a=da(e,t,n,i,o,!0,!1);if(s)return a;let l=da(e,t,n,i,o,!0,!0);return a.concat(l)}function da(e,t,n,i,o,r,s){let a=Math.pow(e-n,2)+Math.pow(t-i,2),l=Math.sqrt(a),d=1;l<200?d=1:l>500?d=.4:d=-.0016668*l+1.233334;let c=o.maxRandomnessOffset||0;c*c*100>a&&(c=l/10);let u=c/2,m=.2+ha(o)*.2,p=o.bowing*o.maxRandomnessOffset*(i-t)/200,f=o.bowing*o.maxRandomnessOffset*(e-n)/200;p=R(p,o,d),f=R(f,o,d);let h=[],E=()=>R(u,o,d),g=()=>R(c,o,d),x=o.preserveVertices;return r&&(s?h.push({op:"move",data:[e+(x?0:E()),t+(x?0:E())]}):h.push({op:"move",data:[e+(x?0:R(c,o,d)),t+(x?0:R(c,o,d))]})),s?h.push({op:"bcurveTo",data:[p+e+(n-e)*m+E(),f+t+(i-t)*m+E(),p+e+2*(n-e)*m+E(),f+t+2*(i-t)*m+E(),n+(x?0:E()),i+(x?0:E())]}):h.push({op:"bcurveTo",data:[p+e+(n-e)*m+g(),f+t+(i-t)*m+g(),p+e+2*(n-e)*m+g(),f+t+2*(i-t)*m+g(),n+(x?0:g()),i+(x?0:g())]}),h}function ca(e,t,n){let i=[];i.push([e[0][0]+R(t,n),e[0][1]+R(t,n)]),i.push([e[0][0]+R(t,n),e[0][1]+R(t,n)]);for(let o=1;o<e.length;o++)i.push([e[o][0]+R(t,n),e[o][1]+R(t,n)]),o===e.length-1&&i.push([e[o][0]+R(t,n),e[o][1]+R(t,n)]);return Qi(i,null,n)}function Qi(e,t,n){let i=e.length,o=[];if(i>3){let r=[],s=1-n.curveTightness;o.push({op:"move",data:[e[1][0],e[1][1]]});for(let a=1;a+2<i;a++){let l=e[a];r[0]=[l[0],l[1]],r[1]=[l[0]+(s*e[a+1][0]-s*e[a-1][0])/6,l[1]+(s*e[a+1][1]-s*e[a-1][1])/6],r[2]=[e[a+1][0]+(s*e[a][0]-s*e[a+2][0])/6,e[a+1][1]+(s*e[a][1]-s*e[a+2][1])/6],r[3]=[e[a+1][0],e[a+1][1]],o.push({op:"bcurveTo",data:[r[1][0],r[1][1],r[2][0],r[2][1],r[3][0],r[3][1]]})}if(t&&t.length===2){let a=n.maxRandomnessOffset;o.push({op:"lineTo",data:[t[0]+R(a,n),t[1]+R(a,n)]})}}else i===3?(o.push({op:"move",data:[e[1][0],e[1][1]]}),o.push({op:"bcurveTo",data:[e[1][0],e[1][1],e[2][0],e[2][1],e[2][0],e[2][1]]})):i===2&&o.push(...Mt(e[0][0],e[0][1],e[1][0],e[1][1],n));return o}function ua(e,t,n,i,o,r,s,a){let l=a.roughness===0,d=[],c=[];if(l){e=e/4,c.push([t+i*Math.cos(-e),n+o*Math.sin(-e)]);for(let u=0;u<=Math.PI*2;u=u+e){let m=[t+i*Math.cos(u),n+o*Math.sin(u)];d.push(m),c.push(m)}c.push([t+i*Math.cos(0),n+o*Math.sin(0)]),c.push([t+i*Math.cos(e),n+o*Math.sin(e)])}else{let u=R(.5,a)-Math.PI/2;c.push([R(r,a)+t+.9*i*Math.cos(u-e),R(r,a)+n+.9*o*Math.sin(u-e)]);let m=Math.PI*2+u-.01;for(let p=u;p<m;p=p+e){let f=[R(r,a)+t+i*Math.cos(p),R(r,a)+n+o*Math.sin(p)];d.push(f),c.push(f)}c.push([R(r,a)+t+i*Math.cos(u+Math.PI*2+s*.5),R(r,a)+n+o*Math.sin(u+Math.PI*2+s*.5)]),c.push([R(r,a)+t+.98*i*Math.cos(u+s),R(r,a)+n+.98*o*Math.sin(u+s)]),c.push([R(r,a)+t+.9*i*Math.cos(u+s*.5),R(r,a)+n+.9*o*Math.sin(u+s*.5)])}return[c,d]}function ma(e,t,n,i,o,r,s,a,l){let d=r+R(.1,l),c=[];c.push([R(a,l)+t+.9*i*Math.cos(d-e),R(a,l)+n+.9*o*Math.sin(d-e)]);for(let u=d;u<=s;u=u+e)c.push([R(a,l)+t+i*Math.cos(u),R(a,l)+n+o*Math.sin(u)]);return c.push([t+i*Math.cos(s),n+o*Math.sin(s)]),c.push([t+i*Math.cos(s),n+o*Math.sin(s)]),Qi(c,null,l)}function vu(e,t,n,i,o,r,s,a){let l=[],d=[a.maxRandomnessOffset||1,(a.maxRandomnessOffset||1)+.3],c=[0,0],u=a.disableMultiStroke?1:2,m=a.preserveVertices;for(let p=0;p<u;p++)p===0?l.push({op:"move",data:[s[0],s[1]]}):l.push({op:"move",data:[s[0]+(m?0:R(d[0],a)),s[1]+(m?0:R(d[0],a))]}),c=m?[o,r]:[o+R(d[p],a),r+R(d[p],a)],l.push({op:"bcurveTo",data:[e+R(d[p],a),t+R(d[p],a),n+R(d[p],a),i+R(d[p],a),c[0],c[1]]});return l}P();function di(e){return[...e]}function Ea(e,t=0){let n=e.length;if(n<3)throw new Error("A curve must have at least three points.");let i=[];if(n===3)i.push(di(e[0]),di(e[1]),di(e[2]),di(e[2]));else{let o=[];o.push(e[0],e[0]);for(let a=1;a<e.length;a++)o.push(e[a]),a===e.length-1&&o.push(e[a]);let r=[],s=1-t;i.push(di(o[0]));for(let a=1;a+2<o.length;a++){let l=o[a];r[0]=[l[0],l[1]],r[1]=[l[0]+(s*o[a+1][0]-s*o[a-1][0])/6,l[1]+(s*o[a+1][1]-s*o[a-1][1])/6],r[2]=[o[a+1][0]+(s*o[a][0]-s*o[a+2][0])/6,o[a+1][1]+(s*o[a][1]-s*o[a+2][1])/6],r[3]=[o[a+1][0],o[a+1][1]],i.push(r[1],r[2],r[3])}}return i}P();function Du(e,t){return Math.sqrt(to(e,t))}function to(e,t){return Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)}function Bu(e,t,n){let i=to(t,n);if(i===0)return to(e,t);let o=((e[0]-t[0])*(n[0]-t[0])+(e[1]-t[1])*(n[1]-t[1]))/i;return o=Math.max(0,Math.min(1,o)),to(e,Sn(t,n,o))}function Sn(e,t,n){return[e[0]+(t[0]-e[0])*n,e[1]+(t[1]-e[1])*n]}function Lu(e,t){let n=e[t+0],i=e[t+1],o=e[t+2],r=e[t+3],s=3*i[0]-2*n[0]-r[0];s*=s;let a=3*i[1]-2*n[1]-r[1];a*=a;let l=3*o[0]-2*r[0]-n[0];l*=l;let d=3*o[1]-2*r[1]-n[1];return d*=d,s<l&&(s=l),a<d&&(a=d),s+a}function xr(e,t,n,i){let o=i||[];if(Lu(e,t)<n){let r=e[t+0];o.length?Du(o[o.length-1],r)>1&&o.push(r):o.push(r),o.push(e[t+3])}else{let s=e[t+0],a=e[t+1],l=e[t+2],d=e[t+3],c=Sn(s,a,.5),u=Sn(a,l,.5),m=Sn(l,d,.5),p=Sn(c,u,.5),f=Sn(u,m,.5),h=Sn(p,f,.5);xr([s,c,p,h],0,n,o),xr([h,f,m,d],0,n,o)}return o}function ci(e,t){return no(e,0,e.length,t)}function no(e,t,n,i,o){let r=o||[],s=e[t],a=e[n-1],l=0,d=1;for(let c=t+1;c<n-1;++c){let u=Bu(e[c],s,a);u>l&&(l=u,d=c)}return Math.sqrt(l)>i?(no(e,t,d+1,i,r),no(e,d,n,i,r)):(r.length||r.push(s),r.push(a)),r}function Tt(e,t=.15,n){let i=[],o=(e.length-1)/3;for(let r=0;r<o;r++){let s=r*3;xr(e,s,t,i)}return n&&n>0?no(i,0,i.length,n):i}P();function ga(e,t,n){let i=zn(e),o=ai(ri(i)),r=[],s=[],a=[0,0],l=[],d=()=>{l.length>=4&&s.push(...Tt(l,t)),l=[]},c=()=>{d(),s.length&&(r.push(s),s=[])};for(let{key:m,data:p}of o)switch(m){case"M":c(),a=[p[0],p[1]],s.push(a);break;case"L":d(),s.push([p[0],p[1]]);break;case"C":if(!l.length){let f=s.length?s[s.length-1]:a;l.push([f[0],f[1]])}l.push([p[0],p[1]]),l.push([p[2],p[3]]),l.push([p[4],p[5]]);break;case"Z":d(),s.push([a[0],a[1]]);break}if(c(),!n)return r;let u=[];for(let m of r){let p=ci(m,n);p.length&&u.push(p)}return u}var Ue="none",Ke=class{constructor(t){this.defaultOptions={maxRandomnessOffset:2,roughness:1,bowing:1,stroke:"#000",strokeWidth:1,curveTightness:0,curveFitting:.95,curveStepCount:9,fillStyle:"hachure",fillWeight:-1,hachureAngle:-41,hachureGap:-1,dashOffset:-1,dashGap:-1,zigzagOffset:-1,seed:0,disableMultiStroke:!1,disableMultiStrokeFill:!1,preserveVertices:!1,fillShapeRoughnessGain:.8},this.config=t||{},this.config.options&&(this.defaultOptions=this._o(this.config.options))}static newSeed(){return aa()}_o(t){return t?Object.assign({},this.defaultOptions,t):this.defaultOptions}_d(t,n,i){return{shape:t,sets:n||[],options:i||this.defaultOptions}}line(t,n,i,o,r){let s=this._o(r);return this._d("line",[pr(t,n,i,o,s)],s)}rectangle(t,n,i,o,r){let s=this._o(r),a=[],l=pa(t,n,i,o,s);if(s.fill){let d=[[t,n],[t+i,n],[t+i,n+o],[t,n+o]];s.fillStyle==="solid"?a.push(eo([d],s)):a.push(In([d],s))}return s.stroke!==Ue&&a.push(l),this._d("rectangle",a,s)}ellipse(t,n,i,o,r){let s=this._o(r),a=[],l=hr(i,o,s),d=Ji(t,n,s,l);if(s.fill)if(s.fillStyle==="solid"){let c=Ji(t,n,s,l).opset;c.type="fillPath",a.push(c)}else a.push(In([d.estimatedPoints],s));return s.stroke!==Ue&&a.push(d.opset),this._d("ellipse",a,s)}circle(t,n,i,o){let r=this.ellipse(t,n,i,i,o);return r.shape="circle",r}linearPath(t,n){let i=this._o(n);return this._d("linearPath",[li(t,!1,i)],i)}arc(t,n,i,o,r,s,a=!1,l){let d=this._o(l),c=[],u=Er(t,n,i,o,r,s,a,!0,d);if(a&&d.fill)if(d.fillStyle==="solid"){let m=Object.assign({},d);m.disableMultiStroke=!0;let p=Er(t,n,i,o,r,s,!0,!1,m);p.type="fillPath",c.push(p)}else c.push(fa(t,n,i,o,r,s,d));return d.stroke!==Ue&&c.push(u),this._d("arc",c,d)}curve(t,n){let i=this._o(n),o=[],r=fr(t,i);if(i.fill&&i.fill!==Ue&&t.length>=3)if(i.fillStyle==="solid"){let s=fr(t,Object.assign(Object.assign({},i),{disableMultiStroke:!0,roughness:i.roughness?i.roughness+i.fillShapeRoughnessGain:0}));o.push({type:"fillPath",ops:this._mergedShape(s.ops)})}else{let s=Ea(t),a=Tt(s,10,(1+i.roughness)/2);o.push(In([a],i))}return i.stroke!==Ue&&o.push(r),this._d("curve",o,i)}polygon(t,n){let i=this._o(n),o=[],r=li(t,!0,i);return i.fill&&(i.fillStyle==="solid"?o.push(eo([t],i)):o.push(In([t],i))),i.stroke!==Ue&&o.push(r),this._d("polygon",o,i)}path(t,n){let i=this._o(n),o=[];if(!t)return this._d("path",o,i);t=(t||"").replace(/\n/g," ").replace(/(-\s)/g,"-").replace("/(ss)/g"," ");let r=i.fill&&i.fill!=="transparent"&&i.fill!==Ue,s=i.stroke!==Ue,a=!!(i.simplification&&i.simplification<1),l=a?4-4*(i.simplification||1):(1+i.roughness)/2,d=ga(t,1,l),c=gr(t,i);if(r)if(i.fillStyle==="solid")if(d.length===1){let u=gr(t,Object.assign(Object.assign({},i),{disableMultiStroke:!0,roughness:i.roughness?i.roughness+i.fillShapeRoughnessGain:0}));o.push({type:"fillPath",ops:this._mergedShape(u.ops)})}else o.push(eo(d,i));else o.push(In(d,i));return s&&(a?d.forEach(u=>{o.push(li(u,!1,i))}):o.push(c)),this._d("path",o,i)}opsToPath(t,n){let i="";for(let o of t.ops){let r=typeof n=="number"&&n>=0?o.data.map(s=>+s.toFixed(n)):o.data;switch(o.op){case"move":i+=`M${r[0]} ${r[1]} `;break;case"bcurveTo":i+=`C${r[0]} ${r[1]}, ${r[2]} ${r[3]}, ${r[4]} ${r[5]} `;break;case"lineTo":i+=`L${r[0]} ${r[1]} `;break}}return i.trim()}toPaths(t){let n=t.sets||[],i=t.options||this.defaultOptions,o=[];for(let r of n){let s=null;switch(r.type){case"path":s={d:this.opsToPath(r),stroke:i.stroke,strokeWidth:i.strokeWidth,fill:Ue};break;case"fillPath":s={d:this.opsToPath(r),stroke:Ue,strokeWidth:0,fill:i.fill||Ue};break;case"fillSketch":s=this.fillSketch(r,i);break}s&&o.push(s)}return o}fillSketch(t,n){let i=n.fillWeight;return i<0&&(i=n.strokeWidth/2),{d:this.opsToPath(t),stroke:n.fill||Ue,strokeWidth:i,fill:Ue}}_mergedShape(t){return t.filter((n,i)=>i===0?!0:n.op!=="move")}};var io=class{constructor(t,n){this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.gen=new Ke(n)}draw(t){let n=t.sets||[],i=t.options||this.getDefaultOptions(),o=this.ctx,r=t.options.fixedDecimalPlaceDigits;for(let s of n)switch(s.type){case"path":o.save(),o.strokeStyle=i.stroke==="none"?"transparent":i.stroke,o.lineWidth=i.strokeWidth,i.strokeLineDash&&o.setLineDash(i.strokeLineDash),i.strokeLineDashOffset&&(o.lineDashOffset=i.strokeLineDashOffset),this._drawToContext(o,s,r),o.restore();break;case"fillPath":{o.save(),o.fillStyle=i.fill||"";let a=t.shape==="curve"||t.shape==="polygon"||t.shape==="path"?"evenodd":"nonzero";this._drawToContext(o,s,r,a),o.restore();break}case"fillSketch":this.fillSketch(o,s,i);break}}fillSketch(t,n,i){let o=i.fillWeight;o<0&&(o=i.strokeWidth/2),t.save(),i.fillLineDash&&t.setLineDash(i.fillLineDash),i.fillLineDashOffset&&(t.lineDashOffset=i.fillLineDashOffset),t.strokeStyle=i.fill||"",t.lineWidth=o,this._drawToContext(t,n,i.fixedDecimalPlaceDigits),t.restore()}_drawToContext(t,n,i,o="nonzero"){t.beginPath();for(let r of n.ops){let s=typeof i=="number"&&i>=0?r.data.map(a=>+a.toFixed(i)):r.data;switch(r.op){case"move":t.moveTo(s[0],s[1]);break;case"bcurveTo":t.bezierCurveTo(s[0],s[1],s[2],s[3],s[4],s[5]);break;case"lineTo":t.lineTo(s[0],s[1]);break}}n.type==="fillPath"?t.fill(o):t.stroke()}get generator(){return this.gen}getDefaultOptions(){return this.gen.defaultOptions}line(t,n,i,o,r){let s=this.gen.line(t,n,i,o,r);return this.draw(s),s}rectangle(t,n,i,o,r){let s=this.gen.rectangle(t,n,i,o,r);return this.draw(s),s}ellipse(t,n,i,o,r){let s=this.gen.ellipse(t,n,i,o,r);return this.draw(s),s}circle(t,n,i,o){let r=this.gen.circle(t,n,i,o);return this.draw(r),r}linearPath(t,n){let i=this.gen.linearPath(t,n);return this.draw(i),i}polygon(t,n){let i=this.gen.polygon(t,n);return this.draw(i),i}arc(t,n,i,o,r,s,a=!1,l){let d=this.gen.arc(t,n,i,o,r,s,a,l);return this.draw(d),d}curve(t,n){let i=this.gen.curve(t,n);return this.draw(i),i}path(t,n){let i=this.gen.path(t,n);return this.draw(i),i}};P();P();var ui="http://www.w3.org/2000/svg";var oo=class{constructor(t,n){this.svg=t,this.gen=new Ke(n)}draw(t){let n=t.sets||[],i=t.options||this.getDefaultOptions(),o=this.svg.ownerDocument||window.document,r=o.createElementNS(ui,"g"),s=t.options.fixedDecimalPlaceDigits;for(let a of n){let l=null;switch(a.type){case"path":{l=o.createElementNS(ui,"path"),l.setAttribute("d",this.opsToPath(a,s)),l.setAttribute("stroke",i.stroke),l.setAttribute("stroke-width",i.strokeWidth+""),l.setAttribute("fill","none"),i.strokeLineDash&&l.setAttribute("stroke-dasharray",i.strokeLineDash.join(" ").trim()),i.strokeLineDashOffset&&l.setAttribute("stroke-dashoffset",`${i.strokeLineDashOffset}`);break}case"fillPath":{l=o.createElementNS(ui,"path"),l.setAttribute("d",this.opsToPath(a,s)),l.setAttribute("stroke","none"),l.setAttribute("stroke-width","0"),l.setAttribute("fill",i.fill||""),(t.shape==="curve"||t.shape==="polygon")&&l.setAttribute("fill-rule","evenodd");break}case"fillSketch":{l=this.fillSketch(o,a,i);break}}l&&r.appendChild(l)}return r}fillSketch(t,n,i){let o=i.fillWeight;o<0&&(o=i.strokeWidth/2);let r=t.createElementNS(ui,"path");return r.setAttribute("d",this.opsToPath(n,i.fixedDecimalPlaceDigits)),r.setAttribute("stroke",i.fill||""),r.setAttribute("stroke-width",o+""),r.setAttribute("fill","none"),i.fillLineDash&&r.setAttribute("stroke-dasharray",i.fillLineDash.join(" ").trim()),i.fillLineDashOffset&&r.setAttribute("stroke-dashoffset",`${i.fillLineDashOffset}`),r}get generator(){return this.gen}getDefaultOptions(){return this.gen.defaultOptions}opsToPath(t,n){return this.gen.opsToPath(t,n)}line(t,n,i,o,r){let s=this.gen.line(t,n,i,o,r);return this.draw(s)}rectangle(t,n,i,o,r){let s=this.gen.rectangle(t,n,i,o,r);return this.draw(s)}ellipse(t,n,i,o,r){let s=this.gen.ellipse(t,n,i,o,r);return this.draw(s)}circle(t,n,i,o){let r=this.gen.circle(t,n,i,o);return this.draw(r)}linearPath(t,n){let i=this.gen.linearPath(t,n);return this.draw(i)}polygon(t,n){let i=this.gen.polygon(t,n);return this.draw(i)}arc(t,n,i,o,r,s,a=!1,l){let d=this.gen.arc(t,n,i,o,r,s,a,l);return this.draw(d)}curve(t,n){let i=this.gen.curve(t,n);return this.draw(i)}path(t,n){let i=this.gen.path(t,n);return this.draw(i)}};var An={canvas(e,t){return new io(e,t)},svg(e,t){return new oo(e,t)},generator(e){return new Ke(e)},newSeed(){return Ke.newSeed()}};import{arrayToMap as Nd,invariant as Ps,rescalePoints as Gd,sizeOf as nh}from"@excalidraw/common";import{degreesToRadians as ys,lineSegment as ge,pointDistance as ih,pointFrom as D,pointFromArray as zd,pointRotateRads as oe}from"@excalidraw/math";P();import{invariant as Cu}from"@excalidraw/common";import{curve as Gu,lineSegment as Ou,pointFrom as ae,pointDistance as aw,pointFromArray as ku,pointFromVector as Fu,pointRotateRads as it,polygon as xa,polygonFromPoints as wr,PRECISION as lw,segmentsIntersectAt as dw,vector as Ru,vectorAdd as Nu,vectorFromPoint as zu,vectorScale as cw}from"@excalidraw/math";import{getElementAbsoluteCoords as mw}from"@excalidraw/element";var wa=e=>{let{angle:t,width:n,height:i,x:o,y:r}=e,s=o+n/2,a=r+i/2,l=ae(s,a),d;return e.type==="diamond"?d=xa(it(ae(s,r),l,t),it(ae(o+n,a),l,t),it(ae(s,r+i),l,t),it(ae(o,a),l,t)):d=xa(it(ae(o,r),l,t),it(ae(o+n,r),l,t),it(ae(o+n,r+i),l,t),it(ae(o,r+i),l,t)),{type:"polygon",data:d}};var ba=e=>{let{width:t,height:n,angle:i,x:o,y:r}=e;return{type:"ellipse",data:{center:ae(o+t/2,r+n/2),angle:i,halfWidth:t/2,halfHeight:n/2}}},vt=e=>{if(!e)return[];for(let t of e.sets)if(t.type==="path")return t.ops;return e.sets[0].ops},ya=(e,t=ae(0,0),n,i)=>{let o=l=>it(ae(l[0]+t[0],l[1]+t[1]),i,n),r=vt(e),s=[],a=ae(0,0);for(let l of r){if(l.op==="move"){let d=ku(l.data);Cu(d!=null,"Ops data is not a point"),a=o(d)}if(l.op==="bcurveTo"){let d=o(ae(l.data[0],l.data[1])),c=o(ae(l.data[2],l.data[3])),u=o(ae(l.data[4],l.data[5]));s.push(Gu(a,d,c,u)),a=u}}return{type:"polycurve",data:s}},Hu=e=>{let t=e[0],n=[];for(let i=1;i<e.length;i++){let o=e[i];n.push(Ou(t,o)),t=o}return n},Pa=(e,t,n=!1)=>{let i=r=>it(Fu(Nu(zu(r),Ru(e.x,e.y))),t,e.angle),o=Hu(e.points.map(r=>i(r)));return n?{type:"polygon",data:wr(o.flat())}:{type:"polyline",data:o}},Ia=(e,t,n=ae(0,0),i,o)=>{let r=c=>it(ae(c[0]+n[0],c[1]+n[1]),o,i);if(e.roundness===null)return{type:"polygon",data:wr(e.points.map(c=>r(c)))};let s=vt(t),a=[],l=!1;for(let c of s)c.op==="move"?(l=!l,l&&a.push(ae(c.data[0],c.data[1]))):c.op==="bcurveTo"?l&&(a.push(ae(c.data[0],c.data[1])),a.push(ae(c.data[2],c.data[3])),a.push(ae(c.data[4],c.data[5]))):c.op==="lineTo"&&l&&a.push(ae(c.data[0],c.data[1]));let d=Tt(a,10,5).map(c=>r(c));return{type:"polygon",data:wr(d)}};P();P();function Sa(e,t,n,i=o=>o){return e*i(.5-t*(.5-n))}function _u(e){return[-e[0],-e[1]]}function rt(e,t){return[e[0]+t[0],e[1]+t[1]]}function Qe(e,t){return[e[0]-t[0],e[1]-t[1]]}function ot(e,t){return[e[0]*t,e[1]*t]}function Uu(e,t){return[e[0]/t,e[1]/t]}function mi(e){return[e[1],-e[0]]}function Aa(e,t){return e[0]*t[0]+e[1]*t[1]}function Yu(e,t){return e[0]===t[0]&&e[1]===t[1]}function Wu(e){return Math.hypot(e[0],e[1])}function ju(e){return e[0]*e[0]+e[1]*e[1]}function Ma(e,t){return ju(Qe(e,t))}function Da(e){return Uu(e,Wu(e))}function Xu(e,t){return Math.hypot(e[1]-t[1],e[0]-t[0])}function pi(e,t,n){let i=Math.sin(n),o=Math.cos(n),r=e[0]-t[0],s=e[1]-t[1],a=r*o-s*i,l=r*i+s*o;return[a+t[0],l+t[1]]}function br(e,t,n){return rt(e,ot(Qe(t,e),n))}function Ta(e,t,n){return rt(e,ot(t,n))}var{min:Hn,PI:Vu}=Math,va=.275,fi=Vu+1e-4;function $u(e,t={}){let{size:n=16,smoothing:i=.5,thinning:o=.5,simulatePressure:r=!0,easing:s=L=>L,start:a={},end:l={},last:d=!1}=t,{cap:c=!0,easing:u=L=>L*(2-L)}=a,{cap:m=!0,easing:p=L=>--L*L*L+1}=l;if(e.length===0||n<=0)return[];let f=e[e.length-1].runningLength,h=a.taper===!1?0:a.taper===!0?Math.max(n,f):a.taper,E=l.taper===!1?0:l.taper===!0?Math.max(n,f):l.taper,g=Math.pow(n*i,2),x=[],w=[],y=e.slice(0,10).reduce((L,M)=>{let U=M.pressure;if(r){let Y=Hn(1,M.distance/n),St=Hn(1,1-Y);U=Hn(1,L+(St-L)*(Y*va))}return(L+U)/2},e[0].pressure),b=Sa(n,o,e[e.length-1].pressure,s),I,S=e[0].vector,T=e[0].point,A=T,F=T,B=A,k=!1;for(let L=0;L<e.length;L++){let{pressure:M}=e[L],{point:U,vector:Y,distance:St,runningLength:pt}=e[L];if(L<e.length-1&&f-pt<3)continue;if(o){if(r){let _e=Hn(1,St/n),qe=Hn(1,1-_e);M=Hn(1,y+(qe-y)*(_e*va))}b=Sa(n,o,M,s)}else b=n/2;I===void 0&&(I=b);let Hi=pt<h?u(pt/h):1,dr=f-pt<E?p((f-pt)/E):1;b=Math.max(.01,b*Math.min(Hi,dr));let _i=(L<e.length-1?e[L+1]:e[L]).vector,oi=L<e.length-1?Aa(Y,_i):1,cr=Aa(Y,S)<0&&!k,Ui=oi!==null&&oi<0;if(cr||Ui){let _e=ot(mi(S),b);for(let qe=1/13,$t=0;$t<=1;$t+=qe)F=pi(Qe(U,_e),U,fi*$t),x.push(F),B=pi(rt(U,_e),U,fi*-$t),w.push(B);T=F,A=B,Ui&&(k=!0);continue}if(k=!1,L===e.length-1){let _e=ot(mi(Y),b);x.push(Qe(U,_e)),w.push(rt(U,_e));continue}let Yi=ot(mi(br(_i,Y,oi)),b);F=Qe(U,Yi),(L<=1||Ma(T,F)>g)&&(x.push(F),T=F),B=rt(U,Yi),(L<=1||Ma(A,B)>g)&&(w.push(B),A=B),y=M,S=Y}let C=e[0].point.slice(0,2),X=e.length>1?e[e.length-1].point.slice(0,2):rt(e[0].point,[1,1]),N=[],Z=[];if(e.length===1){if(!(h||E)||d){let L=Ta(C,Da(mi(Qe(C,X))),-(I||b)),M=[];for(let U=1/13,Y=U;Y<=1;Y+=U)M.push(pi(L,C,fi*2*Y));return M}}else{if(!(h||E&&e.length===1))if(c)for(let M=1/13,U=M;U<=1;U+=M){let Y=pi(w[0],C,fi*U);N.push(Y)}else{let M=Qe(x[0],w[0]),U=ot(M,.5),Y=ot(M,.51);N.push(Qe(C,U),Qe(C,Y),rt(C,Y),rt(C,U))}let L=mi(_u(e[e.length-1].vector));if(E||h&&e.length===1)Z.push(X);else if(m){let M=Ta(X,L,b);for(let U=1/29,Y=U;Y<1;Y+=U)Z.push(pi(M,X,fi*3*Y))}else Z.push(rt(X,ot(L,b)),rt(X,ot(L,b*.99)),Qe(X,ot(L,b*.99)),Qe(X,ot(L,b)))}return x.concat(Z,w.reverse(),N)}function Zu(e,t={}){var n;let{streamline:i=.5,size:o=16,last:r=!1}=t;if(e.length===0)return[];let s=.15+(1-i)*.85,a=Array.isArray(e[0])?e:e.map(({x:p,y:f,pressure:h=.5})=>[p,f,h]);if(a.length===2){let p=a[1];a=a.slice(0,-1);for(let f=1;f<5;f++)a.push(br(a[0],p,f/4))}a.length===1&&(a=[...a,[...rt(a[0],[1,1]),...a[0].slice(2)]]);let l=[{point:[a[0][0],a[0][1]],pressure:a[0][2]>=0?a[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],d=!1,c=0,u=l[0],m=a.length-1;for(let p=1;p<a.length;p++){let f=r&&p===m?a[p].slice(0,2):br(u.point,a[p],s);if(Yu(u.point,f))continue;let h=Xu(f,u.point);if(c+=h,p<m&&!d){if(c<o)continue;d=!0}u={point:f,pressure:a[p][2]>=0?a[p][2]:.5,vector:Da(Qe(u.point,f)),distance:h,runningLength:c},l.push(u)}return l[0].vector=((n=l[1])==null?void 0:n.vector)||[0,0],l}function Ba(e,t={}){return $u(Zu(e,t),t)}import{pointFrom as de,pointDistance as Md,pointRotateRads as Yt}from"@excalidraw/math";import{ROUGHNESS as jf,THEME as ws,isTransparent as Oi,assertNever as Xf,COLOR_PALETTE as Vf,LINE_POLYGON_POINT_MERGE_DISTANCE as $f,applyDarkModeFilter as Wo}from"@excalidraw/common";P();import{isRightAngleRads as Lf,lineSegment as wd,pointFrom as Ho,pointRotateRads as hs}from"@excalidraw/math";import{BOUND_TEXT_PADDING as _o,DEFAULT_FONT_FAMILY as Cf,DEFAULT_FONT_SIZE as Gf,DEFAULT_REDUCED_GLOBAL_ALPHA as Of,ELEMENT_READY_TO_ERASE_OPACITY as kf,FRAME_STYLE as ct,DARK_THEME_FILTER as Ff,MIME_TYPES as xs,STICKY_NOTE_PADDING as bd,THEME as kn,distance as hn,getFontString as Es,isRTL as Rf,getVerticalOffset as Nf,invariant as zf,applyDarkModeFilter as Ci,isSafari as Hf}from"@excalidraw/common";P();import{pointFrom as Dt,pointCenter as qu,pointRotateRads as Kt,vectorFromPoint as yr,vectorNormalize as La,vectorSubtract as Ca,vectorAdd as ro,vectorScale as so,pointFromVector as Ga,clamp as ye,isCloseTo as Oa}from"@excalidraw/math";var Pe=10,ww=(e,t,n,i,o,r,s,a)=>{let{width:l,height:d}=Pr(e),c=i/l,u=o/d,m=(e.crop?.x??0)/c,p=(e.crop?.y??0)/u,f=Kt(Dt(r,s),se(e,t),-e.angle);r=f[0],s=f[1];let h=e.width,E=e.height,g=e.crop??{x:0,y:0,width:i,height:o,naturalWidth:i,naturalHeight:o},x=g.height,w=g.width,y=e.scale[0]===-1,b=e.scale[1]===-1,I=s-e.y,S=r-e.x;n.includes("n")&&(E=ye(e.height-I,Pe,b?d-p:e.height+p)),n.includes("s")&&(I=s-e.y-e.height,E=ye(e.height+I,Pe,b?e.height+p:d-p)),n.includes("e")&&(S=r-e.x-e.width,h=ye(e.width+S,Pe,y?e.width+m:l-m)),n.includes("w")&&(h=ye(e.width-S,Pe,y?l-m:e.width+m));let T=B=>{B.height=E*u,B.width=h*c};T(g);let A=(B,k)=>{T(k),B.includes("n")&&(b||(k.y+=x-k.height)),B.includes("s")&&b&&(k.y+=x-k.height),B.includes("e")&&y&&(k.x+=w-k.width),B.includes("w")&&(y||(k.x+=w-k.width))};switch(n){case"n":{if(a){let B=m+e.width/2,k=l-m-e.width/2,C=Math.min(B,k)*2;h=ye(E*a,Pe,C),E=h/a}A(n,g),a&&(g.x+=(w-g.width)/2);break}case"s":{if(a){let B=m+e.width/2,k=l-m-e.width/2,C=Math.min(B,k)*2;h=ye(E*a,Pe,C),E=h/a}A(n,g),a&&(g.x+=(w-g.width)/2);break}case"w":{if(a){let B=p+e.height/2,k=d-p-e.height/2,C=Math.min(B,k)*2;E=ye(h/a,Pe,C),h=E*a}A(n,g),a&&(g.y+=(x-g.height)/2);break}case"e":{if(a){let B=p+e.height/2,k=d-p-e.height/2,C=Math.min(B,k)*2;E=ye(h/a,Pe,C),h=E*a}A(n,g),a&&(g.y+=(x-g.height)/2);break}case"ne":{if(a)if(S>-I){let B=b?d-p:p+e.height;E=ye(h/a,Pe,B),h=E*a}else{let B=y?m+e.width:l-m;h=ye(E*a,Pe,B),E=h/a}A(n,g);break}case"nw":{if(a)if(S<I){let B=b?d-p:p+e.height;E=ye(h/a,Pe,B),h=E*a}else{let B=y?l-m:m+e.width;h=ye(E*a,Pe,B),E=h/a}A(n,g);break}case"se":{if(a)if(S>I){let B=b?p+e.height:d-p;E=ye(h/a,Pe,B),h=E*a}else{let B=y?m+e.width:l-m;h=ye(E*a,Pe,B),E=h/a}A(n,g);break}case"sw":{if(a)if(-S>I){let B=b?p+e.height:d-p;E=ye(h/a,Pe,B),h=E*a}else{let B=y?l-m:m+e.width;h=ye(E*a,Pe,B),E=h/a}A(n,g);break}default:break}let F=Ku(e,n,h,E,!!a);return Oa(g.width,g.naturalWidth)&&Oa(g.height,g.naturalHeight)&&(g=null),{x:F[0],y:F[1],width:h,height:E,crop:g}},Ku=(e,t,n,i,o)=>{let[r,s,a,l]=Qt(e,e.width,e.height,!0),d=Dt(r,s),c=Dt(a,l),u=qu(d,c),[m,p,f,h]=Qt(e,n,i,!0),E=f-m,g=h-p,x=[...d];if(["n","w","nw"].includes(t)&&(x=[c[0]-Math.abs(E),c[1]-Math.abs(g)]),t==="ne"){let T=[d[0],c[1]];x=[T[0],T[1]-Math.abs(g)]}if(t==="sw"){let T=[c[0],d[1]];x=[T[0]-Math.abs(E),T[1]]}o&&(["s","n"].includes(t)&&(x[0]=u[0]-E/2),["e","w"].includes(t)&&(x[1]=u[1]-g/2));let w=e.angle,y=Kt(x,u,w),b=[x[0]+Math.abs(E)/2,x[1]+Math.abs(g)/2],I=Kt(b,u,w);x=Kt(y,I,-w);let S=[...x];return S[0]+=e.x-m,S[1]+=e.y-p,S},ka=(e,t)=>{if(e.crop){let{width:n,height:i}=Pr(e),[o,r,s,a,l,d]=V(e,t),c=yr(Kt(Dt(o,r),Dt(l,d),e.angle)),u=yr(Kt(Dt(s,r),Dt(l,d),e.angle)),m=La(Ca(u,c)),p=yr(Kt(Dt(o,a),Dt(l,d),e.angle)),f=Ca(p,c),h=La(f),{cropX:E,cropY:g}=Qu(e.crop,e.scale),x=ro(ro(c,so(m,-E*n/e.crop.naturalWidth)),so(h,-g*i/e.crop.naturalHeight)),w=Ga(ro(ro(x,so(m,n/2)),so(h,i/2))),y=Kt(Ga(x),w,-e.angle);return{...e,x:y[0],y:y[1],width:n,height:i,crop:null}}return e},Pr=e=>{if(e.crop){let t=e.width/(e.crop.width/e.crop.naturalWidth),n=e.height/(e.crop.height/e.crop.naturalHeight);return{width:t,height:n}}return{width:e.width,height:e.height}},Qu=(e,t)=>{let n=e.x,i=e.y,o=t[0]===-1,r=t[1]===-1;return o&&(n=e.naturalWidth-Math.abs(n)-e.width),r&&(i=e.naturalHeight-Math.abs(i)-e.height),{cropX:n,cropY:i}},bw=(e,t=!1)=>{let n=e.crop;if(!n)return null;let i=e.scale[0]===-1,o=e.scale[1]===-1,r=n.x,s=n.y;if(i&&(r=n.naturalWidth-n.width-n.x),o&&(s=n.naturalHeight-n.height-n.y),t)return{x:r,y:s};let{width:a,height:l}=Pr(e);return{x:r/(n.naturalWidth/a),y:s/(n.naturalHeight/l)}};P();import{pointCenter as Hl,pointFrom as G,pointRotateRads as Be,pointsEqual as _l,pointDistance as On,vectorFromPoint as Vp,curveLength as $p,curvePointAtLength as Zp,lineSegment as Ul}from"@excalidraw/math";import{DRAGGING_THRESHOLD as qp,KEYS as Gn,shouldRotateWithDiscreteAngle as Bi,getGridPoint as Yl,invariant as Le,isShallowEqual as Kp,getFeatureFlag as qn}from"@excalidraw/common";import{deconstructLinearOrFreeDrawElement as Wl,getSnapOutlineMidPoint as jl,isPathALoop as Qp,moveArrowAboveBindable as Xl,projectFixedPointOntoDiagonal as Vl}from"@excalidraw/element";P();import{KEYS as vp,arrayToMap as Gl,getFeatureFlag as Dp,invariant as tt,isTransparent as Bp}from"@excalidraw/common";import{PRECISION as Lp,clamp as is,lineSegment as Ti,pointDistance as Ht,pointDistanceSq as Mi,pointFrom as J,pointFromVector as jn,pointRotateRads as re,pointsEqual as Cp,vectorFromPoint as Vn,vectorNormalize as Co,vectorScale as Xn}from"@excalidraw/math";P();import{invariant as cl,isTransparent as ul}from"@excalidraw/common";import{curveIntersectLineSegment as ml,isPointWithinBounds as wo,lineSegment as Pi,lineSegmentIntersectionPoints as pl,pointFrom as pe,pointFromVector as $m,pointRotateRads as je,pointsEqual as fl,vectorFromPoint as Zm,vectorNormalize as qm,vectorScale as Km}from"@excalidraw/math";import{ellipse as Qm,ellipseSegmentInterceptPoints as Jm}from"@excalidraw/math/ellipse";P();import{DEFAULT_ADAPTIVE_RADIUS as sm,DEFAULT_PROPORTIONAL_RADIUS as Sr,invariant as am,LINE_CONFIRM_THRESHOLD as lm,ROUNDNESS as Ar}from"@excalidraw/common";import{bezierEquation as dm,curve as Lt,curveCatmullRomCubicApproxPoints as ja,curveOffsetPoints as Xa,lineSegment as Ee,lineSegmentIntersectionPoints as Ya,pointDistance as Tn,pointFrom as z,pointFromArray as cm,pointFromVector as um,pointRotateRads as Ye,pointTranslate as Wa,rectangle as mm,vectorFromPoint as Va,vectorNormalize as pm,vectorScale as Mr}from"@excalidraw/math";P();import{ROUNDNESS as hi,assertNever as Ju}from"@excalidraw/common";import{pointsEqual as Fa}from"@excalidraw/math";var Mn=e=>!!e&&e.type==="image"&&!!e.fileId,xe=e=>!!e&&e.type==="image",Ra=e=>!!e&&e.type==="embeddable",ao=e=>!!e&&e.type==="iframe",lo=e=>!!e&&(e.type==="iframe"||e.type==="embeddable"),ee=e=>e!=null&&e.type==="text",co=e=>e!=null&&e.type==="frame",Na=e=>e!=null&&e.type==="magicframe",q=e=>e!=null&&(e.type==="frame"||e.type==="magicframe"),Ie=e=>e!=null&&em(e.type),em=e=>e==="freedraw",K=e=>e!=null&&im(e.type),Bt=e=>e!=null&&e.type==="line",H=e=>e!=null&&e.type==="arrow",_=e=>H(e)&&e.elbowed,Aw=e=>H(e)&&!e.elbowed,tm=e=>H(e)&&!e.elbowed&&!e.roundness,nm=e=>H(e)&&!e.elbowed&&e.roundness!==null,im=e=>e==="arrow"||e==="line",Se=(e,t=!0)=>e!=null&&(!e.locked||t===!0)&&om(e.type),om=e=>e==="arrow",ce=(e,t=!0)=>e!=null&&(!e.locked||t===!0)&&(e.type==="rectangle"||e.type==="diamond"||e.type==="ellipse"||e.type==="image"||e.type==="iframe"||e.type==="embeddable"||e.type==="frame"||e.type==="magicframe"||e.type==="text"&&!e.containerId),za=e=>e!=null&&(e.type==="rectangle"||e.type==="diamond"||e.type==="image"||e.type==="iframe"||e.type==="embeddable"||e.type==="frame"||e.type==="magicframe"||e.type==="text"&&!e.containerId),Ei=e=>e!=null&&(e.type==="rectangle"||e.type==="image"||e.type==="text"||e.type==="iframe"||e.type==="embeddable"||e.type==="frame"||e.type==="magicframe"||e.type==="freedraw"),rm=(e,t=!0)=>e!=null&&(!e.locked||t===!0)&&(e.type==="rectangle"||e.type==="diamond"||e.type==="ellipse"||H(e)),Mw=e=>{let t=e?.type;if(!t)return!1;switch(t){case"text":case"diamond":case"rectangle":case"iframe":case"embeddable":case"ellipse":case"arrow":case"freedraw":case"line":case"frame":case"magicframe":case"image":case"selection":return!0;default:return Ju(t,null),!1}},Ir=e=>e.type==="rectangle"||e.type==="ellipse"||e.type==="diamond",ht=e=>rm(e)&&!!e.boundElements?.some(({type:t})=>t==="text"),ue=e=>e!==null&&"containerId"in e&&e.containerId!==null&&ee(e),Tw=e=>!!e.startBinding||!!e.endBinding,Ha=e=>e==="rectangle"||e==="embeddable"||e==="iframe"||e==="image",_a=e=>e==="line"||e==="arrow"||e==="diamond",vw=(e,t)=>!!((e===hi.ADAPTIVE_RADIUS||e===hi.LEGACY)&&Ha(t.type)||e===hi.PROPORTIONAL_RADIUS&&_a(t.type)),Dw=e=>_a(e.type)?{type:hi.PROPORTIONAL_RADIUS}:Ha(e.type)?{type:hi.ADAPTIVE_RADIUS}:null,Bw=e=>tm(e)?"sharpArrow":nm(e)?"curvedArrow":_(e)?"elbowArrow":"line",Lw=e=>e.length>3&&Fa(e[0],e[e.length-1]),Ua=e=>e.length>3||e.length===3&&!Fa(e[0],e[e.length-1]);var gi=new WeakMap,Tr=(e,t)=>{let n=gi.get(e);if(!n)return;let{version:i,shapes:o}=n;if(i!==e.version){gi.delete(e);return}return o.get(t)},vr=(e,t,n)=>{let i=gi.get(e);if(!i){gi.set(e,{version:e.version,shapes:new Map([[n,t]])});return}let{version:o,shapes:r}=i;if(o!==e.version){gi.set(e,{version:e.version,shapes:new Map([[n,t]])});return}r.set(n,t)};function uo(e){let t=Tr(e,0);if(t)return t;let n=Za(e),i=[],o=[];for(let s=0;s<n.length;s+=1){let a=n[s],l=n[s-1]&&cm(n[s-1].data.slice(-2));switch(a.op){case"move":continue;case"lineTo":if(!l)throw new Error("prevPoint is undefined");i.push(Ee(z(e.x+l[0],e.y+l[1]),z(e.x+a.data[0],e.y+a.data[1])));continue;case"bcurveTo":if(!l)throw new Error("prevPoint is undefined");o.push(Lt(z(e.x+l[0],e.y+l[1]),z(e.x+a.data[0],e.y+a.data[1]),z(e.x+a.data[2],e.y+a.data[3]),z(e.x+a.data[4],e.y+a.data[5])));continue;default:console.error("Unknown op type",a.op)}}let r=[i,o];return vr(e,r,0),r}function Jt(e,t=0){let n=Tr(e,t);if(n)return n;let i=Ct(Math.min(e.width,e.height),e);i===0&&(i=.01);let o=mm(z(e.x,e.y),z(e.x+e.width,e.y+e.height)),r=Ee(z(o[0][0]+i,o[0][1]),z(o[1][0]-i,o[0][1])),s=Ee(z(o[1][0],o[0][1]+i),z(o[1][0],o[1][1]-i)),a=Ee(z(o[0][0]+i,o[1][1]),z(o[1][0]-i,o[1][1])),l=Ee(z(o[0][0],o[1][1]-i),z(o[0][0],o[0][1]+i)),d=[Lt(l[1],z(l[1][0]+2/3*(o[0][0]-l[1][0]),l[1][1]+2/3*(o[0][1]-l[1][1])),z(r[0][0]+2/3*(o[0][0]-r[0][0]),r[0][1]+2/3*(o[0][1]-r[0][1])),r[0]),Lt(r[1],z(r[1][0]+2/3*(o[1][0]-r[1][0]),r[1][1]+2/3*(o[0][1]-r[1][1])),z(s[0][0]+2/3*(o[1][0]-s[0][0]),s[0][1]+2/3*(o[0][1]-s[0][1])),s[0]),Lt(s[1],z(s[1][0]+2/3*(o[1][0]-s[1][0]),s[1][1]+2/3*(o[1][1]-s[1][1])),z(a[1][0]+2/3*(o[1][0]-a[1][0]),a[1][1]+2/3*(o[1][1]-a[1][1])),a[1]),Lt(a[0],z(a[0][0]+2/3*(o[0][0]-a[0][0]),a[0][1]+2/3*(o[1][1]-a[0][1])),z(l[0][0]+2/3*(o[0][0]-l[0][0]),l[0][1]+2/3*(o[1][1]-l[0][1])),l[0])],c=t>0?d.map(p=>ja(Xa(p,t))):[[d[0]],[d[1]],[d[2]],[d[3]]],m=[[Ee(c[0][c[0].length-1][3],c[1][0][0]),Ee(c[1][c[1].length-1][3],c[2][0][0]),Ee(c[2][c[2].length-1][3],c[3][0][0]),Ee(c[3][c[3].length-1][3],c[0][0][0])],c.flat()];return vr(e,m,t),m}function $a(e,t=0){let[n,i,o,r,s,a,l,d]=_n(e),c=e.roundness?Ct(Math.abs(n-l),e):(n-l)*.01,u=e.roundness?Ct(Math.abs(r-i),e):(r-i)*.01,[m,p,f,h]=[z(e.x+n,e.y+i),z(e.x+o,e.y+r),z(e.x+s,e.y+a),z(e.x+l,e.y+d)];return[Lt(z(p[0]-c,p[1]-u),p,p,z(p[0]-c,p[1]+u)),Lt(z(f[0]+c,f[1]-u),f,f,z(f[0]-c,f[1]-u)),Lt(z(h[0]+c,h[1]+u),h,h,z(h[0]+c,h[1]-u)),Lt(z(m[0]-c,m[1]+u),m,m,z(m[0]+c,m[1]+u))]}function en(e,t=0){let n=Tr(e,t);if(n)return n;let o=$a(e,t).map(a=>ja(Xa(a,t))),s=[[Ee(o[0][o[0].length-1][3],o[1][0][0]),Ee(o[1][o[1].length-1][3],o[2][0][0]),Ee(o[2][o[2].length-1][3],o[3][0][0]),Ee(o[3][o[3].length-1][3],o[0][0][0])],o.flat()];return vr(e,s,t),s}var vn=(e,t=1)=>{if(e.length>=3){let[n,i]=[e[0],e[e.length-1]];return Tn(n,i)<=lm/t}return!1},Ct=(e,t)=>{if(t.roundness?.type===Ar.PROPORTIONAL_RADIUS||t.roundness?.type===Ar.LEGACY)return e*Sr;if(t.roundness?.type===Ar.ADAPTIVE_RADIUS){let n=t.roundness?.value??sm,i=n/Sr;return e<=i?e*Sr:n}return 0},fm=(e,t)=>{let n=e.type==="rectangle"?15:0,i=a=>{let l=pm(Va(a[1],a[0])),d=Mr(l,n);return Ee(Wa(a[0],d),Wa(a[1],Mr(d,-1)))},o=se(e,t),r=i(Ei(e)?Ee(Ye(z(e.x,e.y),o,e.angle),Ye(z(e.x+e.width,e.y+e.height),o,e.angle)):Ee(Ye(z(e.x+e.width/2,e.y),o,e.angle),Ye(z(e.x+e.width/2,e.y+e.height),o,e.angle))),s=i(Ei(e)?Ee(Ye(z(e.x+e.width,e.y),o,e.angle),Ye(z(e.x,e.y+e.height),o,e.angle)):Ee(Ye(z(e.x,e.y+e.height/2),o,e.angle),Ye(z(e.x+e.width,e.y+e.height/2),o,e.angle)));return[r,s]},hm=(e,t,n,i)=>{let o=se(t,n);return(t.type==="diamond"?$a(t).map(a=>{let l=dm(a,.5),d=Ye(l,o,t.angle);return z(d[0],d[1])}):[Ye(z(t.x+t.width,t.y+t.height/2),o,t.angle),Ye(z(t.x+t.width/2,t.y+t.height),o,t.angle),Ye(z(t.x,t.y+t.height/2),o,t.angle),Ye(z(t.x+t.width/2,t.y),o,t.angle)]).find(a=>Tn(e,a)<=Et(i)+t.strokeWidth/2&&!tn({point:e,element:t,threshold:0,elementsMap:n,overrideShouldTestInside:!0}))},Dr=(e,t,n,i,o,r)=>{if(am(e.points.length>=2,"Arrow must have at least two points"),e.width<3&&e.height<3)return null;let s=hm(t,n,o,r);if(s)return s;let[a,l]=fm(n,o),d=O.getPointAtIndexGlobalCoordinates(e,i==="start"?1:e.points.length-2,o),c=um(Mr(Va(t,d),2*Tn(d,t)+Math.max(Tn(a[0],a[1]),Tn(l[0],l[1]))),d),u=Ee(c,d),m=Ya(a,u),p=Ya(l,u),f=m&&Tn(d,m),h=p&&Tn(d,p),E=null;return f!=null&&h!=null?E=f<h?m:p:E=m||p||null,E&&Gt(E,n,o)?E:null};P();import{ARROW_LABEL_FONT_SIZE_TO_MIN_WIDTH_RATIO as km,ARROW_LABEL_WIDTH_FRACTION as Fm,BOUND_TEXT_PADDING as st,DEFAULT_FONT_SIZE as Rm,STICKY_NOTE_PADDING as Fr,TEXT_ALIGN as nl,VERTICAL_ALIGN as il,getFontString as go,isProdEnv as Nm,invariant as zm}from"@excalidraw/common";import{pointFrom as ol,pointRotateRads as Hm}from"@excalidraw/math";P();var xi={},qa=(e,t)=>{let n=xi[e]||(xi[e]={height:t});return n.height=t,n},Ka=e=>{xi[e]&&delete xi[e]},Ww=e=>xi[e]?.height??null;P();import{BOUND_TEXT_PADDING as po,DEFAULT_FONT_SIZE as Em,DEFAULT_FONT_FAMILY as gm,getFontString as xm,isTestEnv as wm,normalizeEOL as bm}from"@excalidraw/common";var We=(e,t,n)=>{let i=e.split(`
`).map(a=>a||" ").join(`
`),o=parseFloat(t),r=ym(i,o,n);return{width:tl(i,t),height:r}},Qa="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".toLocaleUpperCase(),Ja=(e,t)=>{let n=Pm(e);return n===0?We(Qa.split("").join(`
`),e,t).width+po*2:n+po*2},fo=(e,t)=>We("",e,t).width+po*2,$w=()=>tl(Qa,xm({fontSize:Em,fontFamily:gm}))>0,wi=e=>bm(e).replace(/\t/g,"        "),Lr=e=>wi(e).split(`
`),Zw=e=>{let t=Lr(e.text).length;return e.height/t/e.fontSize},ho=(e,t)=>e*t,el=(e,t)=>ho(e,t)+po*2,mo,qw=e=>{mo=e},Br=class{canvas;constructor(){this.canvas=document.createElement("canvas")}getLineWidth(t,n){let i=this.canvas.getContext("2d");i.font=n;let r=i.measureText(t).width;return wm()?r*10:r}},nn=(e,t)=>(mo||(mo=new Br),mo.getLineWidth(e,t)),tl=(e,t)=>{let n=Lr(e),i=0;return n.forEach(o=>{i=Math.max(i,nn(o,t))}),i},ym=(e,t,n)=>{let i=Lr(e).length;return ho(t,n)*i},Un=(()=>{let e={};return{calculate:(o,r)=>{let s=o.charCodeAt(0);if(e[r]||(e[r]=[]),!e[r][s]){let a=nn(o,r);e[r][s]=a}return e[r][s]},getCache:o=>e[o],clearCache:o=>{e[o]=[]}}})(),Kw=e=>{let t=Un.getCache(e);if(!t)return 0;let n=t.filter(i=>i!==void 0);return Math.min(...n)},Pm=e=>{let t=Un.getCache(e);if(!t)return 0;let n=t.filter(i=>i!==void 0);return Math.max(...n)};P();import{isDevEnv as Im,isTestEnv as Sm}from"@excalidraw/common";var Cr,Eo,Gr,nb=e=>(Cr||(Cr=te.class(...Object.values(Ot))),Cr.test(e)),Am=()=>{if(!Eo)try{Eo=Tm()}catch{Eo=Mm()}return Eo},Or=()=>(Gr||(Gr=vm()),Gr),Je={WHITESPACE:/\s/u,HYPHEN:/-/u,OPENING:/<\(\[\{/u,CLOSING:/>\)\]\}.,:;!\?\//u},Ot={CHAR:/\p{Script=Han}\p{Script=Hiragana}\p{Script=Katakana}\p{Script=Hangul}/u,OPENING://u,CLOSING://u,CURRENCY://u},Dn={FLAG:/\p{RI}\p{RI}/u,JOINER:/(?:\p{Emoji_Modifier}|\uFE0F\u20E3?|[\u{E0020}-\u{E007E}]+\u{E007F})?/u,ZWJ:/\u200D/u,ANY:/[\p{Emoji}]/u,MOST:/[\p{Extended_Pictographic}\p{Emoji_Presentation}]/u},Mm=()=>te.or(Or(),me.On(Je.HYPHEN,Je.WHITESPACE,Ot.CHAR)),Tm=()=>te.or(Or(),me.Before(Je.WHITESPACE).Build(),me.After(Je.WHITESPACE,Je.HYPHEN).Build(),me.Before(Ot.CHAR,Ot.CURRENCY).NotPrecededBy(Je.OPENING,Ot.OPENING).Build(),me.After(Ot.CHAR).NotFollowedBy(Je.HYPHEN,Je.CLOSING,Ot.CLOSING).Build(),me.BeforeMany(Ot.OPENING).NotPrecededBy(Je.OPENING).Build(),me.AfterMany(Ot.CLOSING).NotFollowedBy(Je.CLOSING).Build(),me.AfterMany(Je.CLOSING).FollowedBy(Je.OPENING).Build()),vm=()=>te.group(te.or(Dn.FLAG,te.and(Dn.MOST,Dn.JOINER,te.build(`(?:${Dn.ZWJ.source}(?:${Dn.FLAG.source}|${Dn.ANY.source}${Dn.JOINER.source}))*`)))),te={build:e=>new RegExp(e,"u"),join:(...e)=>e.map(t=>t.source).join(""),and:(...e)=>te.build(te.join(...e)),or:(...e)=>te.build(e.map(t=>t.source).join("|")),group:(...e)=>te.build(`(${te.join(...e)})`),class:(...e)=>te.build(`[${te.join(...e)}]`)},me={On:(...e)=>{let t=te.join(...e);return te.build(`([${t}])`)},Before:(...e)=>{let t=te.join(...e),n=()=>te.build(`(?=[${t}])`);return me.Chain(n)},After:(...e)=>{let t=te.join(...e),n=()=>te.build(`(?<=[${t}])`);return me.Chain(n)},BeforeMany:(...e)=>{let t=te.join(...e),n=()=>te.build(`(?<![${t}])(?=[${t}])`);return me.Chain(n)},AfterMany:(...e)=>{let t=te.join(...e),n=()=>te.build(`(?<=[${t}])(?![${t}])`);return me.Chain(n)},NotBefore:(...e)=>{let t=te.join(...e),n=()=>te.build(`(?![${t}])`);return me.Chain(n)},NotAfter:(...e)=>{let t=te.join(...e),n=()=>te.build(`(?<![${t}])`);return me.Chain(n)},Chain:e=>({Build:e,PreceededBy:(...t)=>{let n=e(),i=me.After(...t).Build(),o=()=>te.and(i,n);return me.Chain(o)},FollowedBy:(...t)=>{let n=e(),i=me.Before(...t).Build(),o=()=>te.and(n,i);return me.Chain(o)},NotPrecededBy:(...t)=>{let n=e(),i=me.NotAfter(...t).Build(),o=()=>te.and(i,n);return me.Chain(o)},NotFollowedBy:(...t)=>{let n=e(),i=me.NotBefore(...t).Build(),o=()=>te.and(n,i);return me.Chain(o)}})},Dm=e=>{let t=Am();return e.normalize("NFC").split(t).filter(Boolean)},kt=(e,t,n)=>{if(!Number.isFinite(n)||n<0)return e;let i=[],o=e.split(`
`);for(let r of o){if(nn(r,t)<=n){i.push(r);continue}let a=Bm(r,t,n);i.push(...a)}return i.join(`
`)},Bm=(e,t,n)=>{let i=[],r=Dm(e)[Symbol.iterator](),s="",a=0,l=r.next();for(;!l.done;){let d=l.value,c=s+d,u=Gm(d)?a+Un.calculate(d,t):nn(c,t);if(/\s/.test(d)||u<=n){s=c,a=u,l=r.next();continue}if(s)i.push(s.trimEnd()),s="",a=0;else{let m=Lm(d,t,n),p=m[m.length-1]??"",f=m.slice(0,-1);i.push(...f),s=p,a=nn(p,t),l=r.next()}}if(s){let d=Cm(s,t,n);i.push(d)}return i},Lm=(e,t,n)=>{if(Or().test(e))return[e];Om(e);let i=[],o=Array.from(e),r="",s=0;for(let a of o){let l=Un.calculate(a,t),d=s+l;if(d<=n){r=r+a,s=d;continue}r&&i.push(r),r=a,s=l}return r&&i.push(r),i},Cm=(e,t,n)=>{if(!(nn(e,t)>n))return e;let[,o,r]=e.match(/^(.+?)(\s+)$/)??[e,e.trimEnd(),""],s=nn(o,t);for(let a of Array.from(r)){let l=Un.calculate(a,t),d=s+l;if(d>n)break;o=o+a,s=d}return o},Gm=e=>e.codePointAt(0)!==void 0&&e.codePointAt(1)===void 0,Om=e=>{if((Sm()||Im())&&/\s/.test(e))throw new Error("Word should not contain any whitespaces!")};var xo=(e,t,n)=>{let i=n.getNonDeletedElementsMap(),o;Nm()||zm(!t||!H(t)||e.angle===0,"text element angle must be 0 if bound to arrow container");let r={x:e.x,y:e.y,text:e.text,width:e.width,height:e.height,angle:t?H(t)?0:t.angle:e.angle};r.text=e.text,(t||!e.autoResize)&&(o=t?at(t,e):e.width,r.text=kt(e.originalText,go(e),o));let s=We(r.text,go(e),e.lineHeight);if(e.autoResize&&(r.width=s.width),r.height=s.height,t){let a=yi(t,e),l=at(t,e);if(!H(t)&&s.height>a){let m=kr(s.height,t.type);n.mutateElement(t,{height:m}),qa(t.id,m)}if(s.width>l){let m=kr(s.width,t.type);n.mutateElement(t,{width:m})}let d={...e,...r},{x:c,y:u}=bi(t,d,i);r.x=c,r.y=u}n.mutateElement(e,r)},Bn=(e,t,n,i=!1)=>{let o=t.getNonDeletedElementsMap();if(!Ft(e))return;Ka(e.id);let s=$(e,o);if(s&&s.text){if(!e)return;let a=s.text,l=s.height,d=s.width,c=at(e,s),u=yi(e,s),m=e.height;if(i||n!=="n"&&n!=="s"){a&&(a=kt(s.originalText,go(s),c));let p=We(a,go(s),s.lineHeight);l=p.height,d=p.width}if(l>u){m=kr(l,e.type);let p=m-e.height,f=!H(e)&&(n==="ne"||n==="nw"||n==="n")?e.y-p:e.y;t.mutateElement(e,{height:m,y:f})}t.mutateElement(s,{text:a,width:d,height:l}),H(e)||t.mutateElement(s,bi(e,s,o))}},bi=(e,t,n)=>{if(H(e))return O.getBoundTextElementPosition(e,t,n);let i=Nr(e),o=yi(e,t),r=at(e,t),s,a;t.verticalAlign===il.TOP?a=i.y:t.verticalAlign===il.BOTTOM?a=i.y+(o-t.height):a=i.y+(o/2-t.height/2),t.textAlign===nl.LEFT?s=i.x:t.textAlign===nl.RIGHT?s=i.x+(r-t.width):s=i.x+(r/2-t.width/2);let l=e.angle??0;if(l!==0){let d=ol(i.x+r/2,i.y+o/2),c=ol(s+t.width/2,a+t.height/2),[u,m]=Hm(c,d,l);return{x:u-t.width/2,y:m-t.height/2}}return{x:s,y:a}},Ft=e=>e?.boundElements?.length&&e?.boundElements?.find(t=>t.type==="text")?.id||null,$=(e,t)=>{if(!e)return null;let n=Ft(e);return n&&t.get(n)||null},Ae=(e,t)=>e&&e.containerId&&t.get(e.containerId)||null,mb=(e,t,n)=>{if(!H(e))return{x:e.x+e.width/2,y:e.y+e.height/2};if(O.getPointsGlobalCoordinates(e,n).length%2===1){let s=Math.floor(e.points.length/2),a=O.getPointGlobalCoordinates(e,e.points[s],n);return{x:a[0],y:a[1]}}let o=e.points.length/2-1,r=O.getEditorMidPoints(e,n,t)[o];return r||(r=O.getSegmentMidPoint(e,o+1)),{x:r[0],y:r[1]}},Rr=e=>e.type==="rectangle"&&e.customData?.isStickyNote===!0,Nr=e=>{if(e.type==="rectangle"){let i=Rr(e)?Fr:st;return{x:e.x+i,y:e.y+i}}let t=st,n=st;return e.type==="ellipse"&&(t+=e.width/2*(1-Math.sqrt(2)/2),n+=e.height/2*(1-Math.sqrt(2)/2)),e.type==="diamond"&&(t+=e.width/4,n+=e.height/4),{x:e.x+t,y:e.y+n}},pb=(e,t)=>H(t)?0:t?t.angle:e.angle,fb=(e,t,n)=>{if(H(e))return O.getBoundTextElementPosition(e,t,n)},hb=(e,t)=>e.some(n=>{if(ue(n)){let i=Ae(n,t);return!H(i)}return!1}),Eb=(e,t)=>e.some(n=>{if(ue(n)){let i=Ae(n,t);return!H(i)}return ee(n)}),_m=new Set(["rectangle","ellipse","diamond","arrow"]),gb=e=>_m.has(e.type),kr=(e,t)=>{e=Math.ceil(e);let n=st*2;return t==="ellipse"?Math.round((e+n)/Math.sqrt(2)*2):t==="arrow"?e+n*8:t==="diamond"?2*(e+n):e+n},at=(e,t)=>{let{width:n}=e;if(H(e)){let o=(t?.fontSize??Rm)*km;return Math.max(Fm*n,o)}if(e.type==="ellipse")return Math.round(n/2*Math.sqrt(2))-st*2;if(e.type==="diamond")return Math.round(n/2)-st*2;let i=Rr(e)?Fr:st;return n-i*2},yi=(e,t)=>{let{height:n}=e;if(H(e))return n-st*8*2<=0?t.height:n;if(e.type==="ellipse")return Math.round(n/2*Math.sqrt(2))-st*2;if(e.type==="diamond")return Math.round(n/2)-st*2;let i=Rr(e)?Fr:st;return n-i*2},xb=(e,t=`

`)=>e.reduce((i,o)=>(ee(o)&&i.push(o.text),i),[]).join(t);P();import{curvePointDistance as zr,distanceToLineSegment as Hr,pointRotateRads as _r}from"@excalidraw/math";import{ellipse as Um,ellipseDistanceFromPoint as Ym}from"@excalidraw/math/ellipse";var on=(e,t,n)=>{switch(e.type){case"selection":case"rectangle":case"image":case"text":case"iframe":case"embeddable":case"frame":case"magicframe":return Wm(e,t,n);case"diamond":return jm(e,t,n);case"ellipse":return Xm(e,t,n);case"line":case"arrow":case"freedraw":return Vm(e,n)}},Wm=(e,t,n)=>{let i=se(e,t),o=_r(n,i,-e.angle),[r,s]=Jt(e);return Math.min(...r.map(a=>Hr(o,a)),...s.map(a=>zr(a,o)).filter(a=>a!==null))},jm=(e,t,n)=>{let i=se(e,t),o=_r(n,i,-e.angle),[r,s]=en(e);return Math.min(...r.map(a=>Hr(o,a)),...s.map(a=>zr(a,o)).filter(a=>a!==null))},Xm=(e,t,n)=>{let i=se(e,t);return Ym(_r(n,i,-e.angle),Um(i,e.width/2,e.height/2))},Vm=(e,t)=>{let[n,i]=uo(e);return Math.min(...n.map(o=>Hr(t,o)),...i.map(o=>zr(o,t)))};var bo=e=>{if(e.type==="arrow")return!1;let t=!ul(e.backgroundColor)||ht(e)||lo(e)||ee(e);return e.type==="line"?t&&vn(e.points):e.type==="freedraw"?t&&vn(e.points):t||xe(e)},Ur=null,rl=null,sl=1/0,al=!1,ll=!1,tn=({point:e,element:t,threshold:n,elementsMap:i,frameNameBound:o=null,overrideShouldTestInside:r=!1})=>{if(Ur&&fl(e,Ur)&&sl<=n&&r===ll){let u=rl?.deref();if(u&&u.id===t.id&&u.version===t.version&&u.versionNonce===t.versionNonce)return al}let s=o?wo(pe(o.x-n,o.y-n),e,pe(o.x+o.width+n,o.y+o.height+n)):!1,a=le(t,i,!0);if(!wo(pe(a[0]-n,a[1]-n),je(e,gt(a),-t.angle),pe(a[2]+n,a[3]+n))&&!s)return!1;let c=(r||bo(t))&&Gt(e,t,i)||dl(e,t,i,n)||s;return Ur=e,rl=new WeakRef(t),sl=n,ll=r,al=c,c},ep=(e,t,n,i=0)=>{let[o,r,s,a]=le(t,n);return o-=i,r-=i,s+=i,a+=i,wo(pe(o,r),e,pe(s,a))},Nb=(e,t)=>!tn(e)&&!tp(e.point,e.element,t)&&ep(e.point,e.element,t),tp=(e,t,n)=>{let i=$(t,n);if(!i)return!1;let o=K(t)?{...i,...O.getBoundTextElementPosition(t,i,n)}:i;return Gt(e,o,n)},hl=(e,[t,n],i,o=0)=>{let r=pe(t,n),s=!q(e),a=Math.max(1,o),l=[t-a,n-a,t+a,n+a],d=le(e,i);if(!Ln(l,d))return!1;if(e.frameId){let m=i.get(e.frameId);if(m&&q(m)){let p=le(m,i);if(!sn(r,p))return!1}}let c=rn(e,i,Pi(se(e,i),r)),u=on(e,i,r);return s?c.length===0||u<=o:c.length>0&&u<=a},yo=(e,t,n,i)=>{let o=[];for(let r=t.length-1;r>=0;--r){let s=t[r];if(cl(!s.isDeleted,"Elements in the function parameter for getAllElementsAtPositionForBinding() should not contain deleted elements"),ce(s,!1)&&hl(s,e,n,i)&&(o.push(s),!ul(s.backgroundColor)))break}return o},Rt=(e,t,n,i)=>{let o=yo(e,t,n,i);return!o||o.length===0?null:o.length===1?o[0]:o.sort((r,s)=>s.width**2+s.height**2-(r.width**2+r.height**2)).pop()},El=(e,t,n,i,o)=>{let r=[];for(let a=n.length-1;a>=0;--a){let l=n[a];cl(!l.isDeleted,"Elements in the function parameter for getAllElementsAtPositionForBinding() should not contain deleted elements"),ce(l,!1)&&hl(l,e,i,o)&&r.push(l)}if(!r||r.length===0)return null;if(r.length===1)return r[0];let s=r.filter(a=>on(a,i,e)<=Xe(a,t)||Gt(e,a,i));return s.length===0?null:s[0]},rn=(e,t,n,i=0,o=!1)=>{let r=[Math.min(n[0][0]-i,n[1][0]-i),Math.min(n[0][1]-i,n[1][1]-i),Math.max(n[0][0]+i,n[1][0]+i),Math.max(n[0][1]+i,n[1][1]+i)],s=le(e,t);if(!Ln(r,s))return[];switch(e.type){case"rectangle":case"image":case"text":case"iframe":case"embeddable":case"frame":case"selection":case"magicframe":return ip(e,t,n,i,o);case"diamond":return op(e,t,n,i,o);case"ellipse":return rp(e,t,n,i);case"line":case"freedraw":case"arrow":return np(e,n,o)}},gl=(e,t,n,i,o,r=!1)=>{for(let s of e){let a=Po(s[0],s[1],s[2],s[3]),l=[Math.min(t[0][0],t[1][0]),Math.min(t[0][1],t[1][1]),Math.max(t[0][0],t[1][0]),Math.max(t[0][1],t[1][1])];if(!Ln(a,l))continue;let d=ml(s,t);if(d.length>0){for(let c of d)n.push(je(c,i,o));if(r)return n}}return n},xl=(e,t,n,i,o,r=!1)=>{for(let s of e){let a=pl(s,t);if(a&&(n.push(je(a,i,o)),r))return n}return n},np=(e,t,n=!1)=>{let[i,o]=uo(e),r=[];for(let s of i){let a=pl(s,t);if(a&&(r.push(a),n))return r}for(let s of o){let a=Po(s[0],s[1],s[2],s[3]),l=[Math.min(t[0][0],t[1][0]),Math.min(t[0][1],t[1][1]),Math.max(t[0][0],t[1][0]),Math.max(t[0][1],t[1][1])];if(!Ln(a,l))continue;let d=ml(s,t);if(d.length>0&&(r.push(...d),n))return r}return r},ip=(e,t,n,i=0,o=!1)=>{let r=se(e,t),s=je(n[0],r,-e.angle),a=je(n[1],r,-e.angle),l=Pi(s,a),[d,c]=Jt(e,i),u=[];return xl(d,l,u,r,e.angle,o),o&&u.length>0||gl(c,l,u,r,e.angle,o),u},op=(e,t,n,i=0,o=!1)=>{let r=se(e,t),s=je(n[0],r,-e.angle),a=je(n[1],r,-e.angle),l=Pi(s,a),[d,c]=en(e,i),u=[];return xl(d,l,u,r,e.angle,o),o&&u.length>0||gl(c,l,u,r,e.angle,o),u},rp=(e,t,n,i=0)=>{let o=se(e,t),r=je(n[0],o,-e.angle),s=je(n[1],o,-e.angle);return Jm(Qm(o,e.width/2+i,e.height/2+i),Pi(r,s)).map(a=>je(a,o,e.angle))},dl=(e,t,n,i=1)=>on(t,n,e)<=i,Gt=(e,t,n)=>{if((K(t)||Ie(t))&&!vn(t.points))return!1;let[i,o,r,s]=le(t,n);if(!wo(pe(i,o),e,pe(r,s)))return!1;let a=pe((i+r)/2,(o+s)/2),l=$m(Km(qm(Zm(e,a,.1)),Math.max(t.width,t.height)*2),a),d=Pi(e,l);return rn(t,n,d).filter((u,m,p)=>p.findIndex(f=>fl(f,u))===m).length%2===1},Yr=(e,t,n)=>{let i=(s,a)=>{let{x:l,y:d,width:c,height:u,angle:m}=s,p=se(s,n);if(s.type==="diamond"){let[h,E,g,x,w,y,b,I]=_n(s);return[pe(l+h,d+E-a),pe(l+g+a,d+x),pe(l+w,d+y+a),pe(l+b-a,d+I)].map(T=>je(T,p,m))}if(s.type==="ellipse"){let h=l+c/2,E=d+u/2,g=c/2,x=u/2;return[pe(h,E-x-a),pe(h+g+a,E),pe(h,E+x+a),pe(h-g-a,E)].map(y=>je(y,p,m))}return[pe(l-a,d-a),pe(l+c+a,d-a),pe(l+c+a,d+u+a),pe(l-a,d+u+a)].map(h=>je(h,p,m))},o=-1*Math.max(e.width,e.height)/20;return i(e,o).every(s=>Gt(s,t,n))};P();import{invariant as wl,isDevEnv as sp,isTestEnv as ap}from"@excalidraw/common";import{pointFrom as an,pointFromVector as Io,pointRotateRads as So,pointScaleFromOrigin as Ao,pointsEqual as lp,triangleIncludesPoint as Wr,vectorCross as ke,vectorFromPoint as Q,vectorScale as Mo}from"@excalidraw/math";var he=[1,0],we=[0,1],Re=[-1,0],Ve=[0,-1],Nt=e=>{let[t,n]=e,i=Math.abs(t),o=Math.abs(n);return t>o?he:t<=-o?Re:n>i?we:Ve},Fe=(e,t)=>Nt(Q(e,t)),lt=(e,t)=>Ne(Fe(e,t)),fe=(e,t)=>e[0]===t[0]&&e[1]===t[1],Ne=e=>fe(e,he)||fe(e,Re),Wb=e=>!Ne(e),dp=(e,t,n)=>{let i=gt(t);(sp()||ap())&&(wl(e.width>0&&e.height>0,"Diamond element has no width or height"),wl(!lp(i,n),"The point is too close to the element mid point to determine heading"));let o=.95,r=Io(Mo(Q(So(an(e.x+e.width/2,e.y),i,e.angle),i),o),i),s=Io(Mo(Q(So(an(e.x+e.width,e.y+e.height/2),i,e.angle),i),o),i),a=Io(Mo(Q(So(an(e.x+e.width/2,e.y+e.height),i,e.angle),i),o),i),l=Io(Mo(Q(So(an(e.x,e.y+e.height/2),i,e.angle),i),o),i);if(ke(Q(n,r),Q(r,s))<=0&&ke(Q(n,r),Q(r,l))>0)return Fe(r,i);if(ke(Q(n,s),Q(s,a))<=0&&ke(Q(n,s),Q(s,r))>0)return Fe(s,i);if(ke(Q(n,a),Q(a,l))<=0&&ke(Q(n,a),Q(a,s))>0)return Fe(a,i);if(ke(Q(n,l),Q(l,r))<=0&&ke(Q(n,l),Q(l,a))>0)return Fe(l,i);if(ke(Q(n,i),Q(r,i))<=0&&ke(Q(n,i),Q(s,i))>0){let c=e.width>e.height?r:s;return Fe(c,i)}else if(ke(Q(n,i),Q(s,i))<=0&&ke(Q(n,i),Q(a,i))>0){let c=e.width>e.height?a:s;return Fe(c,i)}else if(ke(Q(n,i),Q(a,i))<=0&&ke(Q(n,i),Q(l,i))>0){let c=e.width>e.height?a:l;return Fe(c,i)}let d=e.width>e.height?r:l;return Fe(d,i)},Ii=(e,t,n)=>{let o=gt(t);if(e.type==="diamond")return dp(e,t,n);let r=Ao(an(t[0],t[1]),o,2),s=Ao(an(t[2],t[1]),o,2),a=Ao(an(t[0],t[3]),o,2),l=Ao(an(t[2],t[3]),o,2);return Wr([r,s,o],n)?Ve:Wr([s,l,o],n)?he:Wr([l,a,o],n)?we:Re},jr=e=>[e[0]===0?0:e[0]>0?-1:1,e[1]===0?0:e[1]>0?-1:1];P();import{getSizeFromPoints as Tp,randomInteger as ts,getUpdatedTimestamp as ns}from"@excalidraw/common";P();import{clamp as To,pointDistance as $r,pointFrom as j,pointScaleFromOrigin as cp,pointsEqual as Ai,pointTranslate as Vr,vector as xt,vectorCross as vo,vectorFromPoint as Zr,vectorScale as up}from"@excalidraw/math";import{BinaryHeap as mp,invariant as Yn,isAnyTrue as pp,getSizeFromPoints as bl,isDevEnv as fp,arrayToMap as hp}from"@excalidraw/common";var qr=1,ne=40,Ep=(e,t)=>{let n=e.fixedSegments?e.fixedSegments.slice():null;if(n){let i=[];e.points.map(s=>j(e.x+s[0],e.y+s[1])).forEach((s,a,l)=>{if(a<2)return i.push(s);let d=Fe(s,l[a-1]),c=Fe(l[a-1],l[a-2]);if(fe(d,c)){let u=n?.findIndex(p=>p.index===a-1)??-1,m=n?.findIndex(p=>p.index===a)??-1;m!==-1&&(n[m].start=j(l[a-2][0]-e.x,l[a-2][1]-e.y)),u!==-1&&n.splice(u,1),i.splice(-1,1),n.forEach(p=>{p.index>a-1&&(p.index-=1)})}return i.push(s)});let o=[];i.forEach((s,a,l)=>{if(a<3)return o.push(s);if($r(l[a-2],l[a-1])<qr){let d=n?.findIndex(m=>m.index===a-2)??-1,c=n?.findIndex(m=>m.index===a-1)??-1;c!==-1&&n.splice(c,1),d!==-1&&n.splice(d,1),o.splice(-2,2),n.forEach(m=>{m.index>a-2&&(m.index-=2)});let u=lt(s,l[a-1]);return o.push(j(u?s[0]:l[a-2][0],u?l[a-2][1]:s[1]))}o.push(s)});let r=n.filter(s=>s.index!==1&&s.index!==o.length-1);return r.length===0?zt(Jr(es(Qr(e,Kr(e,t,o.map(s=>j(s[0]-e.x,s[1]-e.y))))??[])),r,null,null):(fp()&&Yn(Tl(o),"Invalid elbow points with fixed segments"),zt(o,r,e.startIsSpecial,e.endIsSpecial))}return{x:e.x,y:e.y,points:e.points,fixedSegments:e.fixedSegments,startIsSpecial:e.startIsSpecial,endIsSpecial:e.endIsSpecial}},gp=(e,t,n)=>{let i=t.map(A=>A.index),r=(e.fixedSegments?.map(A=>A.index)??[]).findIndex(A=>!i.includes(A));if(r===-1||!e.fixedSegments?.[r])return{points:e.points};let s=e.fixedSegments[r].index,a=e.fixedSegments[r-1],l=e.fixedSegments[r+1],d=e.x+(a?a.end[0]:0),c=e.y+(a?a.end[1]:0),u=a?null:e.startBinding,m=l?null:e.endBinding,{startHeading:p,endHeading:f,startGlobalPoint:h,endGlobalPoint:E,hoveredStartElement:g,hoveredEndElement:x,...w}=Kr({x:d,y:c,startBinding:u,endBinding:m,startArrowhead:null,endArrowhead:null,points:e.points},n,[j(0,0),j(e.x+(l?.start[0]??e.points[e.points.length-1][0])-d,e.y+(l?.start[1]??e.points[e.points.length-1][1])-c)],{isDragging:!1}),{points:y}=zt(Jr(es(Qr(e,{startHeading:p,endHeading:f,startGlobalPoint:h,endGlobalPoint:E,hoveredStartElement:g,hoveredEndElement:x,...w})??[])),t,null,null);if(!y||y.length<2)throw new Error("Property 'points' is required in the update returned by normalizeArrowElementUpdate()");let b=[];if(a)for(let A=0;A<a.index;A++)b.push(j(e.x+e.points[A][0],e.y+e.points[A][1]));if(y.forEach(A=>{b.push(j(e.x+(a?a.end[0]:0)+A[0],e.y+(a?a.end[1]:0)+A[1]))}),l)for(let A=l.index;A<e.points.length;A++)b.push(j(e.x+e.points[A][0],e.y+e.points[A][1]));let I=(l?.index??e.points.length)-(a?.index??0)-1,S=t.map(A=>A.index>s?{...A,index:A.index-I+(y.length-1)}:A),T=b.flatMap((A,F)=>{let B=b[F-1],k=b[F+1];if(B&&k){let C=Fe(A,B),X=Fe(k,A);if(fe(C,X))return S.forEach(N=>{N.index>F&&(N.index-=1)}),[];if(fe(C,jr(X)))return S.forEach(N=>{N.index>F&&(N.index+=1)}),[A,A]}return[A]});return zt(T,S,!1,!1)},xp=(e,t,n,i,o,r)=>{let s=t.map((b,I)=>e.fixedSegments==null||e.fixedSegments[I]===void 0||e.fixedSegments[I].index!==b.index||(b.start[0]!==e.fixedSegments[I].start[0]&&b.end[0]!==e.fixedSegments[I].end[0])!=(b.start[1]!==e.fixedSegments[I].start[1]&&b.end[1]!==e.fixedSegments[I].end[1])?I:null).filter(b=>b!==null).shift();if(s==null)return{points:e.points};let a=e.fixedSegments?.findIndex(b=>b.index===1)??-1,l=e.fixedSegments?.findIndex(b=>b.index===e.points.length-1)??-1,d=$r(t[s].start,t[s].end),c=d<ne+5;if(a===-1&&t[s].index===1&&o){let b=Ne(n),S=(b?fe(n,he):fe(n,we))?c?d/2:ne:c?-d/2:-ne;t[s].start=j(t[s].start[0]+(b?S:0),t[s].start[1]+(b?0:S))}if(l===-1&&t[s].index===e.points.length-1&&r){let b=Ne(i),S=(b?fe(i,he):fe(i,we))?c?d/2:ne:c?-d/2:-ne;t[s].end=j(t[s].end[0]+(b?S:0),t[s].end[1]+(b?0:S))}let u=t.map(b=>({...b,start:j(e.x+b.start[0],e.y+b.start[1]),end:j(e.x+b.end[0],e.y+b.end[1])})),m=e.points.map((b,I)=>j(e.x+b[0],e.y+b[1])),p=u[s].index-1,f=u[s].index,h=u[s].start,E=u[s].end,g=m[p-1]&&!Ai(m[p],m[p-1])?lt(m[p-1],m[p]):void 0,x=m[f+1]&&!Ai(m[f],m[f+1])?lt(m[f+1],m[f]):void 0;if(g!==void 0){let b=g?1:0;m[p-1][b]=h[b]}if(m[p]=h,m[f]=E,x!==void 0){let b=x?1:0;m[f+1][b]=E[b]}let w=u.findIndex(b=>b.index===p);if(w!==-1){let b=lt(u[w].end,u[w].start)?1:0;u[w].start[b]=h[b],u[w].end=h}let y=u.findIndex(b=>b.index===f+1);if(y!==-1){let b=lt(u[y].end,u[y].start)?1:0;u[y].end[b]=E[b],u[y].start=E}if(a===-1&&p===0){let b=o?Ne(n):lt(m[1],m[0]);m.unshift(j(b?h[0]:e.x+e.points[0][0],b?e.y+e.points[0][1]:h[1])),o&&m.unshift(j(e.x+e.points[0][0],e.y+e.points[0][1]));for(let I of u)I.index+=o?2:1}if(l===-1&&f===e.points.length-1){let b=Ne(i);m.push(j(b?E[0]:e.x+e.points[e.points.length-1][0],b?e.y+e.points[e.points.length-1][1]:E[1])),r&&m.push(j(e.x+e.points[e.points.length-1][0],e.y+e.points[e.points.length-1][1]))}return zt(m,u.map(b=>({...b,start:j(b.start[0]-e.x,b.start[1]-e.y),end:j(b.end[0]-e.x,b.end[1]-e.y)})),!1,!1)},wp=(e,t,n,i,o,r,s,a,l)=>{let d=e.startIsSpecial??null,c=e.endIsSpecial??null,u=t.map((E,g)=>g===0?j(e.x+E[0],e.y+E[1]):g===t.length-1?j(e.x+E[0],e.y+E[1]):j(e.x+e.points[g][0],e.y+e.points[g][1])),m=n.map(E=>({...E,start:j(e.x+(E.start[0]-t[0][0]),e.y+(E.start[1]-t[0][1])),end:j(e.x+(E.end[0]-t[0][0]),e.y+(E.end[1]-t[0][1]))})),p=[],f=2+(d?1:0),h=2+(c?1:0);for(;p.length+f<u.length-h;)p.push(u[p.length+f]);{let E=u.at(d?2:1),g=u.at(d?3:2);if(!E||!g)throw new Error(`Second and third points must exist when handling endpoint drag (${d})`);let x=Ne(i),w=Ne(Nt(Zr(E,g)));if(a&&x===w){let y=x?fe(i,he):fe(i,we);if(p.unshift(j(w?r[0]+(y?ne:-ne):g[0],w?g[1]:r[1]+(y?ne:-ne))),p.unshift(j(x?r[0]+(y?ne:-ne):r[0],x?r[1]:r[1]+(y?ne:-ne))),!d){d=!0;for(let b of m)b.index>1&&(b.index+=1)}}else if(p.unshift(j(w?r[0]:E[0],w?E[1]:r[1])),d){d=!1;for(let y of m)y.index>1&&(y.index-=1)}p.unshift(r)}{let E=u.at(u.length-(c?3:2)),g=u.at(u.length-(c?4:3));if(!E||!g)throw new Error(`Second and third to last points must exist when handling endpoint drag (${c})`);let x=Ne(o),w=lt(g,E);if(l&&x===w){let y=x?fe(o,he):fe(o,we);p.push(j(w?s[0]+(y?ne:-ne):g[0],w?g[1]:s[1]+(y?ne:-ne))),p.push(j(x?s[0]+(y?ne:-ne):s[0],x?s[1]:s[1]+(y?ne:-ne))),c||(c=!0)}else p.push(j(w?s[0]:E[0],w?E[1]:s[1])),c&&(c=!1)}return p.push(s),zt(p,m.map(({index:E})=>({index:E,start:p[E-1],end:p[E]})).map(E=>({...E,start:j(E.start[0]-r[0],E.start[1]-r[1]),end:j(E.end[0]-r[0],E.end[1]-r[1])})),d,c)},ln=1e6,Wn=(e,t,n,i)=>{if(e.points.length<2)return{points:n.points??e.points};v.PROD||(Yn(!n.points||n.points.length>=2,"Updated point array length must match the arrow point length, contain exactly the new start and end points or not be specified at all (i.e. you can't add new points between start and end manually to elbow arrows)"),Yn(!e.fixedSegments||e.fixedSegments.map(b=>b.start[0]===b.end[0]||b.start[1]===b.end[1]).every(Boolean),"Fixed segments must be either horizontal or vertical"),Yn(!n.fixedSegments||n.fixedSegments.map(b=>b.start[0]===b.end[0]||b.start[1]===b.end[1]).every(Boolean),"Updates to fixed segments must be either horizontal or vertical"),Yn(e.points.slice(1).map((b,I)=>b[0]===e.points[I][0]||b[1]===e.points[I][1]),"Elbow arrow segments must be either horizontal or vertical"),Yn(n.fixedSegments?.find(b=>b.index===1&&Ai(b.start,(n.points??e.points)[0]))==null&&n.fixedSegments?.find(b=>b.index===(n.points??e.points).length-1&&Ai(b.end,(n.points??e.points)[(n.points??e.points).length-1]))==null,"The first and last segments cannot be fixed"));let o=n.fixedSegments??e.fixedSegments??[],r=n.points?n.points&&n.points.length===2?e.points.map((b,I)=>I===0?n.points[0]:I===e.points.length-1?n.points[1]:b):n.points.slice():e.points.slice(),{startBinding:s,endBinding:a,...l}=n,d=typeof s<"u"?s:e.startBinding,c=typeof a<"u"?a:e.endBinding,u=d&&Bo(d.elementId,t),m=c&&Bo(c.elementId,t),p=Tl(r);if(d&&!u&&p||c&&!m&&p||t.size===0&&p||Object.keys(l).length===0&&(u?.id!==d?.elementId||m?.id!==c?.elementId))return zt(r.map(b=>j(e.x+b[0],e.y+b[1])),e.fixedSegments,e.startIsSpecial,e.endIsSpecial);let{startHeading:f,endHeading:h,startGlobalPoint:E,endGlobalPoint:g,hoveredStartElement:x,hoveredEndElement:w,...y}=Kr({x:e.x,y:e.y,startBinding:d,endBinding:c,startArrowhead:e.startArrowhead,endArrowhead:e.endArrowhead,points:e.points},t,r,i);return t.size===0&&p?zt(r.map(b=>j(e.x+b[0],e.y+b[1])),e.fixedSegments,e.startIsSpecial,e.endIsSpecial):!n.points&&!n.fixedSegments&&!n.startBinding&&!n.endBinding?Ep(e,t):n.startBinding===e.startBinding&&n.endBinding===e.endBinding&&(n.points??[]).every((b,I)=>Ai(b,e.points[I]??j(1/0,1/0)))&&p?{}:o.length===0?zt(Jr(es(Qr(e,{startHeading:f,endHeading:h,startGlobalPoint:E,endGlobalPoint:g,hoveredStartElement:x,hoveredEndElement:w,...y})??[])),o,null,null):(e.fixedSegments?.length??0)>o.length?gp(e,o,t):n.points?n.points&&n.fixedSegments?n:wp(e,r,o,f,h,E,g,x,w):xp(e,o,f,h,x,w)},Kr=(e,t,n,i)=>{let o=Vr(n[0],xt(e.x,e.y)),r=Vr(n[n.length-1],xt(e.x,e.y)),s=null,a=null;if(i?.isDragging){let b=Array.from(t.values());s=Sl(o,t,b,i?.zoom)||null,a=Sl(r,t,b,i?.zoom)||null}else s=e.startBinding&&Bo(e.startBinding.elementId,t)||null,a=e.endBinding&&Bo(e.endBinding.elementId,t)||null;let l=Pl({...e,angle:0,type:"arrow",elbowed:!0,points:n},"start",e.startBinding?.fixedPoint,o,s,t,i?.isDragging),d=Pl({...e,angle:0,type:"arrow",elbowed:!0,points:n},"end",e.endBinding?.fixedPoint,r,a,t,i?.isDragging),c=Il(l,d,s,o,t,i?.zoom),u=Il(d,l,a,r,t,i?.zoom),m=[l[0]-2,l[1]-2,l[0]+2,l[1]+2],p=[d[0]-2,d[1]-2,d[0]+2,d[1]+2],f=s?et(s,t,dn(c,e.startArrowhead?Xe(s,{elbowed:!0})*6:Xe(s,{elbowed:!0})*2,1)):m,h=a?et(a,t,dn(u,e.endArrowhead?Xe(a,{elbowed:!0})*6:Xe(a,{elbowed:!0})*2,1)):p,E=sn(l,a?et(a,t,dn(u,ne,ne)):p)||sn(d,s?et(s,t,dn(c,ne,ne)):m),g=Ml(E?[m,p]:[f,h]),x=Pp(E?m:f,E?p:h,g,E?dn(c,!s&&!a?0:ne,0):dn(c,!s&&!a?0:ne-(e.startArrowhead?Cn*6:Cn*2),ne),E?dn(u,!s&&!a?0:ne,0):dn(u,!s&&!a?0:ne-(e.endArrowhead?Cn*6:Cn*2),ne),E,s&&et(s,t),a&&et(a,t)),w=yl(x[0],c,l),y=yl(x[1],u,d);return{dynamicAABBs:x,startDonglePosition:w,startGlobalPoint:l,startHeading:c,endDonglePosition:y,endGlobalPoint:d,endHeading:u,commonBounds:g,hoveredStartElement:s,hoveredEndElement:a,boundsOverlap:E,startElementBounds:f,endElementBounds:h}},Qr=(e,t)=>{let{dynamicAABBs:n,startDonglePosition:i,startGlobalPoint:o,startHeading:r,endDonglePosition:s,endGlobalPoint:a,endHeading:l,commonBounds:d,hoveredEndElement:c}=t,u=Ip(n,i||o,r,s||a,l,d),m=i&&Do(i,u),p=s&&Do(s,u),f=Do(a,u);f&&c&&(f.closed=!0);let h=Do(o,u);h&&e.startBinding&&(h.closed=!0);let E=m&&p&&(sn(m.pos,n[1])||sn(p.pos,n[0])),g=bp(m||h,p||f,u,r||he,l||he,E?[]:n);if(g){let x=g.map(w=>[w.pos[0],w.pos[1]]);return m&&x.unshift(o),p&&x.push(a),x}return null},dn=(e,t,n)=>{switch(e){case Ve:return[t,n,n,n];case he:return[n,t,n,n];case we:return[n,n,t,n]}return[n,n,n,t]},bp=(e,t,n,i,o,r)=>{let s=Xr(e.pos,t.pos),a=new mp(l=>l.f);for(a.push(e);a.size()>0;){let l=a.pop();if(!l||l.closed)continue;if(l===t)return yp(e,l);l.closed=!0;let d=Ap(l.addr,n);for(let c=0;c<4;c++){let u=d[c];if(!u||u.closed)continue;let m=cp(u.pos,l.pos,.5);if(pp(...r.map(y=>sn(m,y))))continue;let p=Mp(c),f=l.parent?Nt(Zr(l.pos,l.parent.pos)):i,h=jr(f);if(fe(h,p)||Al(e.addr,u.addr)&&fe(p,i)||Al(t.addr,u.addr)&&fe(p,o))continue;let g=f!==p,x=l.g+Xr(u.pos,l.pos)+(g?Math.pow(s,3):0),w=u.visited;if(!w||x<u.g){let y=Sp(u,t,p,o);u.visited=!0,u.parent=l,u.h=Xr(t.pos,u.pos)+y*Math.pow(s,2),u.g=x,u.f=u.g+u.h,w?a.rescoreElement(u):a.push(u)}}}return null},yp=(e,t)=>{let n=t,i=[];for(;n.parent;)i.unshift(n),n=n.parent;return i.unshift(e),i},Xr=(e,t)=>Math.abs(e[0]-t[0])+Math.abs(e[1]-t[1]),Pp=(e,t,n,i,o,r,s,a)=>{let l=s??e,d=a??t,[c,u,m,p]=i??[0,0,0,0],[f,h,E,g]=o??[0,0,0,0],x=[e[0]>t[2]?e[1]>t[3]||e[3]<t[1]?Math.min((l[0]+d[2])/2,e[0]-p):(l[0]+d[2])/2:e[0]>t[0]?e[0]-p:n[0]-p,e[1]>t[3]?e[0]>t[2]||e[2]<t[0]?Math.min((l[1]+d[3])/2,e[1]-c):(l[1]+d[3])/2:e[1]>t[1]?e[1]-c:n[1]-c,e[2]<t[0]?e[1]>t[3]||e[3]<t[1]?Math.max((l[2]+d[0])/2,e[2]+u):(l[2]+d[0])/2:e[2]<t[2]?e[2]+u:n[2]+u,e[3]<t[1]?e[0]>t[2]||e[2]<t[0]?Math.max((l[3]+d[1])/2,e[3]+m):(l[3]+d[1])/2:e[3]<t[3]?e[3]+m:n[3]+m],w=[t[0]>e[2]?t[1]>e[3]||t[3]<e[1]?Math.min((d[0]+l[2])/2,t[0]-g):(d[0]+l[2])/2:t[0]>e[0]?t[0]-g:n[0]-g,t[1]>e[3]?t[0]>e[2]||t[2]<e[0]?Math.min((d[1]+l[3])/2,t[1]-f):(d[1]+l[3])/2:t[1]>e[1]?t[1]-f:n[1]-f,t[2]<e[0]?t[1]>e[3]||t[3]<e[1]?Math.max((d[2]+l[0])/2,t[2]+h):(d[2]+l[0])/2:t[2]<e[2]?t[2]+h:n[2]+h,t[3]<e[1]?t[0]>e[2]||t[2]<e[0]?Math.max((d[3]+l[1])/2,t[3]+E):(d[3]+l[1])/2:t[3]<e[3]?t[3]+E:n[3]+E],y=Ml([x,w]);if(!r&&x[2]-x[0]+w[2]-w[0]>y[2]-y[0]+1e-11&&x[3]-x[1]+w[3]-w[1]>y[3]-y[1]+1e-11){let[b,I]=[(w[0]+w[2])/2,(w[1]+w[3])/2];if(t[0]>e[2]&&e[1]>t[3]){let S=x[2]+(w[0]-x[2])/2,T=w[3]+(x[1]-w[3])/2;return vo(xt(e[2]-b,e[1]-I),xt(e[0]-b,e[3]-I))>0?[[x[0],x[1],S,x[3]],[S,w[1],w[2],w[3]]]:[[x[0],T,x[2],x[3]],[w[0],w[1],w[2],T]]}else if(e[2]<t[0]&&e[3]<t[1]){let S=x[2]+(w[0]-x[2])/2,T=x[3]+(w[1]-x[3])/2;return vo(xt(e[0]-b,e[1]-I),xt(e[2]-b,e[3]-I))>0?[[x[0],x[1],x[2],T],[w[0],T,w[2],w[3]]]:[[x[0],x[1],S,x[3]],[S,w[1],w[2],w[3]]]}else if(e[0]>t[2]&&e[3]<t[1]){let S=w[2]+(x[0]-w[2])/2,T=x[3]+(w[1]-x[3])/2;return vo(xt(e[2]-b,e[1]-I),xt(e[0]-b,e[3]-I))>0?[[S,x[1],x[2],x[3]],[w[0],w[1],S,w[3]]]:[[x[0],x[1],x[2],T],[w[0],T,w[2],w[3]]]}else if(e[0]>t[2]&&e[1]>t[3]){let S=w[2]+(x[0]-w[2])/2,T=w[3]+(x[1]-w[3])/2;return vo(xt(e[0]-b,e[1]-I),xt(e[2]-b,e[3]-I))>0?[[S,x[1],x[2],x[3]],[w[0],w[1],S,w[3]]]:[[x[0],T,x[2],x[3]],[w[0],w[1],w[2],T]]}}return[x,w]},Ip=(e,t,n,i,o,r)=>{let s=new Set,a=new Set;n===Re||n===he?a.add(t[1]):s.add(t[0]),o===Re||o===he?a.add(i[1]):s.add(i[0]),e.forEach(c=>{s.add(c[0]),s.add(c[2]),a.add(c[1]),a.add(c[3])}),s.add(r[0]),s.add(r[2]),a.add(r[1]),a.add(r[3]);let l=Array.from(a).sort((c,u)=>c-u),d=Array.from(s).sort((c,u)=>c-u);return{row:l.length,col:d.length,data:l.flatMap((c,u)=>d.map((m,p)=>({f:0,g:0,h:0,closed:!1,visited:!1,parent:null,addr:[p,u],pos:[m,c]})))}},yl=(e,t,n)=>{switch(t){case Ve:return j(n[0],e[1]);case he:return j(e[2],n[1]);case we:return j(n[0],e[3])}return j(e[0],n[1])},Sp=(e,t,n,i)=>{if(i===he)switch(n){case he:return e.pos[0]>=t.pos[0]?4:e.pos[1]===t.pos[1]?0:2;case Ve:return e.pos[1]>t.pos[1]&&e.pos[0]<t.pos[0]?1:3;case we:return e.pos[1]<t.pos[1]&&e.pos[0]<t.pos[0]?1:3;case Re:return e.pos[1]===t.pos[1]?4:2}else if(i===Re)switch(n){case he:return e.pos[1]===t.pos[1]?4:2;case Ve:return e.pos[1]>t.pos[1]&&e.pos[0]>t.pos[0]?1:3;case we:return e.pos[1]<t.pos[1]&&e.pos[0]>t.pos[0]?1:3;case Re:return e.pos[0]<=t.pos[0]?4:e.pos[1]===t.pos[1]?0:2}else if(i===Ve)switch(n){case he:return e.pos[1]>t.pos[1]&&e.pos[0]<t.pos[0]?1:3;case Ve:return e.pos[1]>=t.pos[1]?4:e.pos[0]===t.pos[0]?0:2;case we:return e.pos[0]===t.pos[0]?4:2;case Re:return e.pos[1]>t.pos[1]&&e.pos[0]>t.pos[0]?1:3}else if(i===we)switch(n){case he:return e.pos[1]<t.pos[1]&&e.pos[0]<t.pos[0]?1:3;case Ve:return e.pos[0]===t.pos[0]?4:2;case we:return e.pos[1]<=t.pos[1]?4:e.pos[0]===t.pos[0]?0:2;case Re:return e.pos[1]<t.pos[1]&&e.pos[0]>t.pos[0]?1:3}return 0},Ap=([e,t],n)=>[Si([e,t-1],n),Si([e+1,t],n),Si([e,t+1],n),Si([e-1,t],n)],Si=([e,t],n)=>e<0||e>=n.col||t<0||t>=n.row?null:n.data[t*n.col+e]??null,Do=(e,t)=>{for(let n=0;n<t.col;n++)for(let i=0;i<t.row;i++){let o=Si([n,i],t);if(o&&e[0]===o.pos[0]&&e[1]===o.pos[1])return o}return null},Ml=e=>[Math.min(...e.map(t=>t[0])),Math.min(...e.map(t=>t[1])),Math.max(...e.map(t=>t[2])),Math.max(...e.map(t=>t[3]))],Bo=(e,t)=>{let n=t.get(e);return n&&ce(n)?n:null},zt=(e,t,n,i)=>{let o=e[0][0],r=e[0][1],s=e.map(a=>Vr(a,up(Zr(e[0]),-1)));return(o<-ln||o>ln||r<-ln||r>ln||o+s[s.length-1][0]<-ln||r+s[s.length-1][0]>ln||o+s[s.length-1][1]<-ln||r+s[s.length-1][1]>ln)&&console.error("Elbow arrow normalization is outside reasonable bounds (> 1e6)",{x:o,y:r,points:s,...bl(s)}),s=s.map(([a,l])=>j(To(a,-1e6,1e6),To(l,-1e6,1e6))),{points:s,x:To(o,-1e6,1e6),y:To(r,-1e6,1e6),fixedSegments:(t?.length??0)>0?t:null,...bl(s),startIsSpecial:n,endIsSpecial:i}},Jr=e=>{if(e.length>1){let t=Math.abs(e[0][1]-e[1][1])<Math.abs(e[0][0]-e[1][0]);return e.filter((n,i)=>{if(i===0||i===e.length-1)return!0;let o=e[i+1],r=Math.abs(n[1]-o[1])<Math.abs(n[0]-o[0]);return t===r?(t=r,!1):(t=r,!0)})}return e},es=e=>e.length>=4?e.filter((t,n)=>{if(n===0||n===e.length-1)return!0;let i=e[n-1];return $r(i,t)>qr}):e,Mp=e=>{switch(e){case 0:return Ve;case 1:return he;case 2:return we}return Re},Pl=(e,t,n,i,o,r,s)=>s?o&&r?Lo(e,o,t,r):i:o?$e(n||[0,0],o,r??hp([o])):i,Il=(e,t,n,i,o,r)=>vl(e,t,n,n&&et(n,o,Array(4).fill(on(n,o,e))),i,o,r),Sl=(e,t,n,i)=>Rt(e,n,t,Et(i)),Al=(e,t)=>e[0]===t[0]&&e[1]===t[1],Tl=(e,t=qr)=>e.slice(1).map((n,i)=>Math.abs(n[0]-e[i][0])<t||Math.abs(n[1]-e[i][1])<t).every(Boolean);var be=(e,t,n,i)=>{let o=!1,{points:r,fixedSegments:s,fileId:a}=n;_(e)&&(Object.keys(n).length===0||typeof r<"u"||typeof s<"u")?n={...n,angle:0,...Wn({...e,x:n.x||e.x,y:n.y||e.y},t,n,i)}:typeof r<"u"&&(n={...Tp(r),...n});for(let l in n){let d=n[l];if(typeof d<"u"){if(e[l]===d&&(typeof d!="object"||d===null||l==="groupIds"||l==="scale"))continue;if(l==="scale"){let c=e[l],u=d;if(c[0]===u[0]&&c[1]===u[1])continue}else if(l==="points"){let c=e[l],u=d;if(c.length===u.length){let m=!1,p=c.length;for(;--p;){let f=c[p],h=u[p];if(f[0]!==h[0]||f[1]!==h[1]){m=!0;break}}if(!m)continue}}e[l]=d,o=!0}}return o&&((typeof n.height<"u"||typeof n.width<"u"||typeof a<"u"||typeof r<"u")&&Ze.delete(e),e.version=n.version??e.version+1,e.versionNonce=n.versionNonce??ts(),e.updated=ns()),e},De=(e,t,n=!1)=>{let i=!1;for(let o in t){let r=t[o];if(typeof r<"u"){if(e[o]===r&&(typeof r!="object"||r===null))continue;i=!0}}return!i&&!n?e:{...e,...t,version:t.version??e.version+1,versionNonce:t.versionNonce??ts(),updated:ns()}},Dl=(e,t)=>(e.version=(t??e.version)+1,e.versionNonce=ts(),e.updated=ns(),e);var Ol=5,Cn=5,Oo=10/1.5,Xe=(e,t)=>(t.elbowed?Cn:Ol)+e.strokeWidth/2,Et=e=>{let t=Math.max(Ol,15),n=e?.value&&e.value<1?e.value:1;return is(t/(n*1.5),t,t*2)},Py=e=>!e[vp.CTRL_OR_CMD],wt=e=>e.isBindingEnabled,Gp=(e,t,n,i,o,r,s)=>{let{start:a,end:l}=os(e,t,n,i,o.getNonDeletedElementsMap(),o.getNonDeletedElements(),r,{...s,finalize:!0});if(Bl(e,a,"start",o),Bl(e,l,"end",o),a.focusPoint||l.focusPoint){let d=new Map;a.focusPoint&&d.set(0,{point:dt(e,"startBinding",e.startBinding,a.element,o.getNonDeletedElementsMap())||e.points[0]}),l.focusPoint&&d.set(e.points.length-1,{point:dt(e,"endBinding",e.endBinding,l.element,o.getNonDeletedElementsMap())||e.points[e.points.length-1]}),O.movePoints(e,o,d)}return{start:a,end:l}},Bl=(e,{mode:t,element:n,focusPoint:i},o,r)=>{t===null?Te(e,o,r):t!==void 0&&bt(e,n,t,o,r,i)},kl=(e,t,n,i,o)=>{tt(t.size===1,"Bound elbow arrows cannot be moved");let r=t.entries().next().value;tt(r,"There should be a position update for dragging an elbow arrow endpoint");let[s,{point:a}]=r,l=O.getPointGlobalCoordinates(e,a,n),d=Rt(l,i,n,Et(o)),c=d?{element:d,mode:"orbit",focusPoint:O.getPointAtIndexGlobalCoordinates(e,s,n)}:{mode:null},u={mode:void 0};return s===0?{start:c,end:u}:{start:u,end:c}},Op=(e,t,n,i,o,r,s,a,l,d,c)=>{let u={mode:void 0},m={mode:void 0},p=e.points.length>2,f=O.getPointGlobalCoordinates(e,t.get(o?s:a).point,n),h=Rt(f,i,n);if(o)return h?u={element:h,mode:"inside",focusPoint:f}:u={mode:null},{start:u,end:m};if(r){let E=l?.selectedLinearElement?.initialState.origin;if(h&&e.startBinding?.elementId===h.id){let g=J(h.x+h.width/2,h.y+h.height/2);return{start:p?{mode:void 0}:{mode:"inside",element:h,focusPoint:E??g},end:p?{mode:"orbit",element:h,focusPoint:f}:{mode:"inside",element:h,focusPoint:f}}}if(h&&e.startBinding){let g=e.startBinding;if(yo(f,i,n).find(w=>w.id===g.elementId)){let w=n.get(e.startBinding.elementId);return tt(w,"Other element must be in the elements map"),{start:p?{mode:void 0}:{mode:w.id!==h.id?"orbit":"inside",element:w,focusPoint:E??J(e.x,e.y)},end:{mode:"orbit",element:h,focusPoint:f}}}}if(e.startBinding&&e.startBinding.elementId!==h?.id){let g=n.get(e.startBinding.elementId);tt(g,"Other element must be in the elements map");let w={mode:!!l.selectedLinearElement?.initialState.arrowStartIsInside?"inside":"orbit",element:g,focusPoint:c?se(g,n):E??J(e.x,e.y)},y=h&&Yr(g,h,n),b;if(h){let I=d==="inside"||d==="skip";b={mode:I&&!y?"inside":"orbit",element:h,focusPoint:f}}else b={mode:null};return{start:p?{mode:void 0}:w,end:b}}if(!e.startBinding)return h?m={mode:d==="inside"||d==="skip"?"inside":"orbit",element:h,focusPoint:f}:m={mode:null},{start:u,end:m}}tt(!1,"New arrow creation should not reach here")},Ll=(e,t,n,i,o,r,s,a)=>{let l={mode:void 0},d={mode:void 0},c=s.points.length>2,u=Rt(e,o,i),m=n?yo(e,o,i).some(E=>E.id===n.elementId):!1,p=n?i.get(n.elementId):null,f=m&&p?Bp(p.backgroundColor):!1,h=u&&p&&Yr(p,u,i);return r==="inside"||r==="skip"?(l=u?{element:!m||!p||f?u:p,focusPoint:e,mode:"inside"}:{mode:null},d=a&&u&&u.id===n?.elementId?{mode:null}:d,{current:l,other:d}):u?u.id===t?.elementId&&t.mode==="inside"?{current:{mode:"inside",focusPoint:e,element:u},other:d}:n?n.elementId===u.id?n.mode==="orbit"?(l={element:u,mode:"orbit",focusPoint:e},d={mode:a?null:void 0},{current:l,other:c?{mode:void 0}:d}):(l={element:u,mode:"inside",focusPoint:e},{current:l,other:c?{mode:void 0}:d}):(m&&p&&!f?l={element:p,mode:"inside",focusPoint:e}:l={element:u,mode:"orbit",focusPoint:e},{current:l,other:c?{mode:void 0}:d}):(l={element:u,mode:"orbit",focusPoint:e},{current:l,other:c?{mode:void 0}:d}):{current:{mode:null},other:d}},os=(e,t,n,i,o,r,s,a)=>Dp("COMPLEX_BINDINGS")?kp(e,t,o,r,s,a):Fl(e,t,n,i,o,r,s,a),Fl=(e,t,n,i,o,r,s,a)=>{let d=e.points.length-1,c=t.has(0),u=t.has(d),m={mode:void 0},p={mode:void 0};if(tt(e.points.length>1,"Do not attempt to bind linear elements with a single point"),!c&&!u)return{start:m,end:p};if(c&&u)return{start:{mode:null},end:{mode:null}};if(!wt(s))return m=c?{mode:null}:m,p=u?{mode:null}:p,{start:m,end:p};if(_(e))return kl(e,t,o,r,a?.zoom);let f=c?e.endBinding:e.startBinding,h=t.get(c?0:d)?.point;tt(h,`Local point must be defined for ${c?"start":"end"} dragging`);let E=O.getPointGlobalCoordinates(e,h,o),g=Rt(E,r,o,Et(s.zoom)),x=g&&(a?.angleLocked?Gt(J(n,i),g,o):Gt(E,g,o)),w=f?o.get(f.elementId):void 0,y=f&&w&&$e(f.fixedPoint,w,o),b=w&&y&&tn({point:y,element:w,elementsMap:o,threshold:0,overrideShouldTestInside:!0});if(f&&f.elementId===g?.id)return tt(!a?.newArrow||s.selectedLinearElement?.initialState.origin,"appState.selectedLinearElement.initialState.origin must be defined for new arrows"),{start:{mode:"inside",element:g,focusPoint:c?E:a?.newArrow?s.selectedLinearElement.initialState.origin:O.getPointAtIndexGlobalCoordinates(e,0,o)},end:{mode:"inside",element:g,focusPoint:u?E:O.getPointAtIndexGlobalCoordinates(e,-1,o)}};if(a?.altKey)return{start:c?g?{mode:"inside",element:g,focusPoint:E}:{mode:null}:m,end:u?g?{mode:"inside",element:g,focusPoint:E}:{mode:null}:p};let I=g?x?{mode:"inside",element:g,focusPoint:E}:{mode:"orbit",element:g,focusPoint:Dr(e,E,g,c?"start":"end",o,s.zoom)||E}:{mode:null},S=O.getPointAtIndexGlobalCoordinates(e,c?-1:0,o),A=(a?.newArrow?s.selectedLinearElement?.initialState.arrowStartIsInside:f?.mode==="inside")?{mode:void 0}:w&&!b&&s.selectedLinearElement?.initialState.altFocusPoint?{mode:"orbit",element:w,focusPoint:s.selectedLinearElement.initialState.altFocusPoint}:a?.angleLocked&&w?{mode:"orbit",element:w,focusPoint:Dr(e,S,w,c?"end":"start",o,s.zoom)||S}:{mode:void 0};return{start:c?I:A,end:u?I:A}},kp=(e,t,n,i,o,r)=>{let s=o.bindMode||"orbit",a=0,l=e.points.length-1,d=t.has(a),c=t.has(l),u={mode:void 0},m={mode:void 0};if(tt(e.points.length>1,"Do not attempt to bind linear elements with a single point"),!d&&!c)return{start:u,end:m};if(d&&c)return{start:{mode:null},end:{mode:null}};if(!wt(o))return u=d?{mode:null}:u,m=c?{mode:null}:m,{start:u,end:m};if(_(e))return kl(e,t,n,i);if(r?.newArrow){let{start:p,end:f}=Op(e,t,n,i,d,c,a,l,o,s,r?.shiftKey);return{start:p,end:f}}if(d){let p=t.get(a)?.point;tt(p,"Local point must be defined for start dragging");let f=O.getPointGlobalCoordinates(e,p,n),{current:h,other:E}=Ll(f,e.startBinding,e.endBinding,n,i,s,e,r?.finalize);return{start:h,end:E}}if(c){let p=t.get(l)?.point;tt(p,"Local point must be defined for end dragging");let f=O.getPointGlobalCoordinates(e,p,n),{current:h,other:E}=Ll(f,e.endBinding,e.startBinding,n,i,s,e,r?.finalize);return{start:E,end:h}}return{start:u,end:m}},Iy=(e,t,n)=>{e.forEach(i=>{Gp(i,new Map,1/0,1/0,t,n)})},bt=(e,t,n,i,o,r)=>{let s=o.getNonDeletedElementsMap(),a;_(e)?a={elementId:t.id,mode:"orbit",..._p(e,t,i,s)}:a={elementId:t.id,mode:n,...Zn(e,t,i,s,r)},o.mutateElement(e,{[i==="start"?"startBinding":"endBinding"]:a}),Gl(t.boundElements||[]).has(e.id)||o.mutateElement(t,{boundElements:(t.boundElements||[]).concat({id:e.id,type:"arrow"})})},Te=(e,t,n)=>{let i=t==="start"?"startBinding":"endBinding",o=e[i];if(o==null)return null;let r=e[t==="start"?"endBinding":"startBinding"];if(!r||r.elementId!==o.elementId){let s=n.getNonDeletedElementsMap().get(o.elementId);n.mutateElement(s,{boundElements:s.boundElements?.filter(a=>a.id!==e.id)})}return n.mutateElement(e,{[i]:null}),o.elementId},ve=(e,t,n)=>{if(!ce(e))return;let{simultaneouslyUpdated:i}=n??{},o=Rp(i),r=t.getNonDeletedElementsMap();n?.changedElements&&(r=new Map(r),n.changedElements.forEach(a=>{r.set(a.id,a)}));let s=a=>{if(!H(a)||a.isDeleted||!Fp(a,e))return;let l=a.startBinding?r.get(a.startBinding.elementId):null,d=a.endBinding?l?.id===a.endBinding.elementId?l:r.get(a.endBinding.elementId):null;if(o.has(a.id))return;let c=Go(r,a,(m,p)=>{if(m&&ce(m)&&(p==="startBinding"||p==="endBinding")&&(e.id===a[p]?.elementId||e.id===a[p==="startBinding"?"endBinding":"startBinding"]?.elementId)){let f=dt(a,p,a[p],m,r);if(f)return[p==="startBinding"?0:a.points.length-1,{point:f}]}return null}).filter(m=>m!==null);O.movePoints(a,t,new Map(c),{moveMidPointsWithElement:!!l&&l?.id===d?.id});let u=$(a,r);u&&!u.isDeleted&&Bn(a,t,!1)};$n(r,e,s),n?.indirectArrowUpdate&&($n(r,e,s),$n(r,e,s))},Cl=(e,t,n,i,o)=>{tt(!_(e),"Elbow arrows not supported for indirect updates");let r=e[t],s=r&&n.get(r.elementId),a=O.getPointAtIndexGlobalCoordinates(e,t==="startBinding"?0:-1,n),l=s&&tn({element:s,point:a,elementsMap:n,threshold:Et(o.zoom)}),d=t==="startBinding"?"start":"end";if(Te(e,d,i),l){let c=t==="startBinding"?0:e.points.length-1,u=e.points[c],m=Fl(e,new Map([[c,{point:u}]]),a[0],a[1],n,i.getNonDeletedElements(),o);m[d]&&m[d].element?.id===s.id&&m[d].mode&&bt(e,s,m[d].mode,d,i,m[d].focusPoint)}},Sy=(e,t,n,i)=>{if(H(e)){let o=t.getNonDeletedElementsMap();e.startBinding&&Cl(e,"startBinding",o,t,n),e.endBinding&&Cl(e,"endBinding",o,t,n)}else ve(e,t,{...i,changedElements:new Map([[e.id,e]])})},Fp=(e,t)=>e.startBinding?.elementId===t.id||e.endBinding?.elementId===t.id,Rp=e=>new Set((e||[]).map(t=>t.id)),vl=(e,t,n,i,o,r,s)=>{let a=Nt(Vn(t,e));return!n||!i?a:Np(o,n,r,s)?Ii(n,i,e):Nt(Vn(e,se(n,r)))},Np=(e,t,n,i)=>{let o=on(t,n,e),r=Et(i);return o>r?null:o},Lo=(e,t,n,i,o)=>{let r=_(e),s=O.getPointAtIndexGlobalCoordinates(e,n==="start"?0:-1,i);if(e.points.length<2)return s;let a=za(t)&&r?zp(e,t,i,s):s,l=o&&!r?o[1]:O.getPointAtIndexGlobalCoordinates(e,n==="start"?1:-2,i),d=Xe(t,e),c=et(t,i),u=gt(c),m=null;if(r){let p=Ne(Ii(t,c,s)),h=rs(t,i,a,.05,e)||s,E=J(p?u[0]:h[0],p?h[1]:u[1]),g=o??Ti(E,jn(Xn(Co(Vn(h,E)),Math.max(t.width,t.height)*2),E));if(m=rn(t,i,g,d).sort(Mi)[0],!m){let x=J(p?h[0]:u[0],p?u[1]:h[1]),w=Ti(x,jn(Xn(Co(Vn(h,x)),Math.max(t.width,t.height)*2),x));m=rn(t,i,w,Cn).sort(Mi)[0]}}else{let p=o;if(!p){let f=Xn(Co(Vn(a,l)),Ht(a,l)+Math.max(t.width,t.height)+d*2);p=o??Ti(jn(f,l),jn(Xn(f,-1),l))}m=Ht(a,l)<1?a:rn(t,i,p,d).sort((f,h)=>Mi(f,l)-Mi(h,l))[0]}return!m||Mi(a,m)<Lp?a:m},zp=(e,t,n,i)=>{let o=se(t,n),r=re(i,o,-t.angle),s=Xe(t,e);return r[0]<t.x&&r[1]<t.y?r[1]-t.y>-s?re(J(t.x-s,t.y),o,t.angle):re(J(t.x,t.y-s),o,t.angle):r[0]<t.x&&r[1]>t.y+t.height?r[0]-t.x>-s?re(J(t.x,t.y+t.height+s),o,t.angle):re(J(t.x-s,t.y+t.height),o,t.angle):r[0]>t.x+t.width&&r[1]>t.y+t.height?r[0]-t.x<t.width+s?re(J(t.x+t.width,t.y+t.height+s),o,t.angle):re(J(t.x+t.width+s,t.y+t.height),o,t.angle):r[0]>t.x+t.width&&r[1]<t.y?r[0]-t.x<t.width+s?re(J(t.x+t.width,t.y-s),o,t.angle):re(J(t.x+t.width+s,t.y),o,t.angle):i},rs=(e,t,n,i=.05,o)=>{let{x:r,y:s,width:a,height:l,angle:d}=e,c=se(e,t,-.1,-.1),u=re(n,c,-d),m=o?Xe(e,o):0,p=is(i*l,5,80),f=is(i*a,5,80);if(!(Ht(c,u)<m)){if(u[0]<=r+a/2&&u[1]>c[1]-p&&u[1]<c[1]+p)return re(J(r-m,c[1]),c,d);if(u[1]<=s+l/2&&u[0]>c[0]-f&&u[0]<c[0]+f)return re(J(c[0],s-m),c,d);if(u[0]>=r+a/2&&u[1]>c[1]-p&&u[1]<c[1]+p)return re(J(r+a+m,c[1]),c,d);if(u[1]>=s+l/2&&u[0]>c[0]-f&&u[0]<c[0]+f)return re(J(c[0],s+l+m),c,d);if(e.type==="diamond"){let h=m,E=J(r+a/4-h,s+l/4-h),g=J(r+3*a/4+h,s+l/4-h),x=J(r+a/4-h,s+3*l/4+h),w=J(r+3*a/4+h,s+3*l/4+h);if(Ht(E,u)<Math.max(f,p))return re(E,c,d);if(Ht(g,u)<Math.max(f,p))return re(g,c,d);if(Ht(x,u)<Math.max(f,p))return re(x,c,d);if(Ht(w,u)<Math.max(f,p))return re(w,c,d)}}},Hp=(e,t)=>t.width**2+t.height**2-(e.width**2+e.height**2),dt=(e,t,n,i,o,r)=>{if(n==null||n.elementId!==i.id&&e.points.length>2||Cp(e.points[e.points.length-1],J(0,0)))return null;let s=$e(Di(n.fixedPoint),i,o),a=t==="startBinding"?0:e.points.length-1,l=_(e),d=t==="startBinding"?e.endBinding:e.startBinding,c=d&&o.get(d.elementId),u=le(i,o),m=c&&le(c,o),p=c&&Hp(i,c)<(t==="endBinding"?1:0),f=m&&Ln(u,m),h=!1;if(!f&&!l&&e.startBinding&&e.endBinding&&c&&e.points.length===2){let w=$e(e.startBinding.fixedPoint,t==="startBinding"?i:c,o),y=$e(e.endBinding.fixedPoint,t==="endBinding"?i:c,o),b=Ti(w,y),I=rn(t==="endBinding"?i:c,o,b,0,!0),S=rn(t==="startBinding"?i:c,o,b,0,!0);I.length>0&&S.length>0&&(h=Ht(I[0],S[0])<40)}let E=(h||f)&&p,g=r?.customIntersector;if(!l&&!g){let[w,y,b,I]=O.getElementAbsoluteCoords(e,o),S=J((w+b)/2,(y+I)/2),T=s,A=re(J(e.x+e.points[a===0?1:e.points.length-2][0],e.y+e.points[a===0?1:e.points.length-2][1]),S,e.angle),F=Xe(i,e),B=Xn(Co(Vn(T,A)),Ht(T,A)+Math.max(i.width,i.height)+F*2);g=Ti(jn(B,A),jn(Xn(B,-1),A))}let x=n.mode==="orbit"&&i?E?s:Lo({...e,points:[a===0?O.createPointAt(e,o,s[0],s[1],null):e.points[0],...e.points.slice(1,-1),a===e.points.length-1?O.createPointAt(e,o,s[0],s[1],null):e.points[e.points.length-1]]},i,a===0?"start":"end",o,g):s;return O.createPointAt(e,o,x[0],x[1],null)},_p=(e,t,n,i)=>{let o=[t.x,t.y,t.x+t.width,t.y+t.height],r=Lo(e,t,n,i),s=J(o[0]+(o[2]-o[0])/2,o[1]+(o[3]-o[1])/2),a=re(r,s,-t.angle);return{fixedPoint:Di([(a[0]-t.x)/t.width,(a[1]-t.y)/t.height])}},Zn=(e,t,n,i,o)=>{let r=o||O.getPointAtIndexGlobalCoordinates(e,n==="start"?0:-1,i),s=se(t,i),a=re(r,s,-t.angle),l=(a[0]-t.x)/t.width,d=(a[1]-t.y)/t.height;return{fixedPoint:Di([l,d])}},Rl=(e,t,n)=>{for(let i of e){if("boundElements"in i&&i.boundElements&&Object.assign(i,{boundElements:i.boundElements.reduce((o,r)=>{let s=t.get(r.id);return s&&o.push({...r,id:s}),o},[])}),"containerId"in i&&i.containerId&&Object.assign(i,{containerId:t.get(i.containerId)??null}),"endBinding"in i&&i.endBinding){let o=t.get(i.endBinding.elementId);Object.assign(i,{endBinding:o?{...i.endBinding,elementId:o}:null})}if("startBinding"in i&&i.startBinding){let o=t.get(i.startBinding.elementId);Object.assign(i,{startBinding:o?{...i.startBinding,elementId:o}:null})}_(i)&&Object.assign(i,Wn(i,n,{points:[i.points[0],i.points[i.points.length-1]]}))}},Ay=(e,t)=>{let n=Gl(e);for(let i of t)cn.unbindAffected(n,i,(o,r)=>be(o,n,r)),un.unbindAffected(n,i,(o,r)=>be(o,n,r))},vi=(e,t,n=[])=>{if(!e)return null;let i=e.filter(o=>!t.has(o.id));return i.push(...n.map(o=>({id:o.id,type:o.type}))),i},Nl=new Set(["boundElements","frameId","containerId","startBinding","endBinding"]),$n=(e,t,n)=>{ce(t)&&(t.boundElements?.slice()??[]).forEach(({id:o})=>{n(e.get(o),"boundElements",o)})},Go=(e,t,n)=>{let i=[];if(t.frameId){let o=t.frameId;i.push(n(e.get(o),"frameId",o))}if(ue(t)){let o=t.containerId;i.push(n(e.get(o),"containerId",o))}if(H(t)){if(t.startBinding){let o=t.startBinding.elementId;i.push(n(e.get(o),"startBinding",o))}if(t.endBinding){let o=t.endBinding.elementId;i.push(n(e.get(o),"endBinding",o))}}return i},cn=class{static unbindAffected(t,n,i){n&&Go(t,n,o=>{!o||o.isDeleted||$n(t,o,(r,s,a)=>{a===n.id&&i(o,{boundElements:vi(o.boundElements,new Set([a]))})})})}static rebindAffected=(t,n,i)=>{!n||n.isDeleted||Go(t,n,(o,r)=>{if(!o||o.isDeleted){i(n,{[r]:null});return}r!=="frameId"&&(o.boundElements?.find(s=>s.id===n.id)||(H(n)&&i(o,{boundElements:vi(o.boundElements,new Set,new Array(n))}),ee(n)&&(o.boundElements?.find(s=>s.type==="text")?i(n,{[r]:null}):i(o,{boundElements:vi(o.boundElements,new Set,new Array(n))}))))})}},un=class{static unbindAffected(t,n,i){n&&$n(t,n,o=>{!o||o.isDeleted||Go(t,o,(r,s,a)=>{a===n.id&&i(o,{[s]:null})})})}static rebindAffected=(t,n,i)=>{!n||n.isDeleted||$n(t,n,(o,r,s)=>{if(!o||o.isDeleted){i(n,{boundElements:vi(n.boundElements,new Set([s]))});return}ee(o)&&((n.boundElements?.slice()??[]).reverse().find(l=>l.type==="text")?.id===o.id?o.containerId!==n.id&&i(o,{containerId:n.id}):(o.containerId!==null&&i(o,{containerId:null}),i(n,{boundElements:vi(n.boundElements,new Set([o.id]))})))})}},$e=(e,t,n)=>{let[i,o]=Di(e);return re(J(t.x+t.width*i,t.y+t.height*o),se(t,n),t.angle)},Up=(e,t)=>{let n=e.startBinding&&t.get(e.startBinding.elementId),i=e.endBinding&&t.get(e.endBinding.elementId),o=n&&e.startBinding?$e(e.startBinding.fixedPoint,n,t):J(e.x+e.points[0][0],e.y+e.points[0][1]),r=i&&e.endBinding?$e(e.endBinding.fixedPoint,i,t):J(e.x+e.points[e.points.length-1][0],e.y+e.points[e.points.length-1][1]);return[o,r]},zl=(e,t)=>{let[n,i]=Up(e,t);return[O.pointFromAbsoluteCoords(e,n,t),O.pointFromAbsoluteCoords(e,i,t)]},Di=e=>e&&(Math.abs(e[0]-.5)<1e-4||Math.abs(e[1]-.5)<1e-4)?e.map(t=>Math.abs(t-.5)<1e-4?.5001:t):e,Yp=e=>e.type==="ellipse"||e.type==="diamond"?e.type:"rectangle",Wp={rectangle:[{centerAngle:0,sectorWidth:75,side:"right"},{centerAngle:45,sectorWidth:15,side:"bottom-right"},{centerAngle:90,sectorWidth:75,side:"bottom"},{centerAngle:135,sectorWidth:15,side:"bottom-left"},{centerAngle:180,sectorWidth:75,side:"left"},{centerAngle:225,sectorWidth:15,side:"top-left"},{centerAngle:270,sectorWidth:75,side:"top"},{centerAngle:315,sectorWidth:15,side:"top-right"}],diamond:[{centerAngle:0,sectorWidth:15,side:"right"},{centerAngle:45,sectorWidth:75,side:"bottom-right"},{centerAngle:90,sectorWidth:15,side:"bottom"},{centerAngle:135,sectorWidth:75,side:"bottom-left"},{centerAngle:180,sectorWidth:15,side:"left"},{centerAngle:225,sectorWidth:75,side:"top-left"},{centerAngle:270,sectorWidth:15,side:"top"},{centerAngle:315,sectorWidth:75,side:"top-right"}],ellipse:[{centerAngle:0,sectorWidth:15,side:"right"},{centerAngle:45,sectorWidth:75,side:"bottom-right"},{centerAngle:90,sectorWidth:15,side:"bottom"},{centerAngle:135,sectorWidth:75,side:"bottom-left"},{centerAngle:180,sectorWidth:15,side:"left"},{centerAngle:225,sectorWidth:75,side:"top-left"},{centerAngle:270,sectorWidth:15,side:"top"},{centerAngle:315,sectorWidth:75,side:"top-right"}]},jp=e=>e.map((t,n)=>{let i=t.sectorWidth/2,o=t.centerAngle-i,r=t.centerAngle+i;return o=(o%360+360)%360,r=(r%360+360)%360,{start:o,end:r,side:t.side}}),Xp=(e,t)=>{let[n,i]=e,o=n-.5,r=i-.5,s=Math.atan2(r,o);s<0&&(s+=2*Math.PI);let a=s*180/Math.PI,l=Wp[t],d=jp(l);for(let m of d)if(m.start<=m.end){if(a>=m.start&&a<=m.end)return m.side}else if(a>=m.start||a<=m.end)return m.side;let c=1/0,u=l[0].side;for(let m of l){let p=Math.abs(a-m.centerAngle);p>180&&(p=360-p),p<c&&(c=p,u=m.side)}return u},My=(e,t)=>{let n=t.get(e.elementId);if(!n||n.isDeleted||!ce(n))return null;let i=se(n,t),o=Yp(n),r=Xp(Di(e.fixedPoint),o),s=.01;if(n.type==="diamond"){let[a,l]=en(n),[d,c,u,m]=a,p,f;switch(r){case"left":{if(l.length>=3){let E=l[2][1];p=E[0]-s,f=E[1]}else{let h=Me(c[1],u[0]);p=h[0]-s,f=h[1]}break}case"right":{if(l.length>=1){let E=l[0][1];p=E[0]+s,f=E[1]}else{let h=Me(m[1],d[0]);p=h[0]+s,f=h[1]}break}case"top":{if(l.length>=4){let E=l[3][1];p=E[0],f=E[1]-s}else{let h=Me(u[1],m[0]);p=h[0],f=h[1]-s}break}case"bottom":{if(l.length>=2){let E=l[1][1];p=E[0],f=E[1]+s}else{let h=Me(d[1],c[0]);p=h[0],f=h[1]+s}break}case"top-right":{let h=Me(m[0],m[1]);p=h[0]+s*.707,f=h[1]-s*.707;break}case"bottom-right":{let h=Me(d[0],d[1]);p=h[0]+s*.707,f=h[1]+s*.707;break}case"bottom-left":{let h=Me(c[0],c[1]);p=h[0]-s*.707,f=h[1]+s*.707;break}case"top-left":{let h=Me(u[0],u[1]);p=h[0]-s*.707,f=h[1]-s*.707;break}default:return null}return re(J(p,f),i,n.angle)}if(n.type==="ellipse"){let a=n.x+n.width/2,l=n.y+n.height/2,d=n.width/2,c=n.height/2,u,m;switch(r){case"top":{u=a,m=l-c-s;break}case"right":{u=a+d+s,m=l;break}case"bottom":{u=a,m=l+c+s;break}case"left":{u=a-d-s,m=l;break}case"top-right":{let p=-Math.PI/4,f=d*Math.cos(p),h=c*Math.sin(p);u=a+f+s*.707,m=l+h-s*.707;break}case"bottom-right":{let p=Math.PI/4,f=d*Math.cos(p),h=c*Math.sin(p);u=a+f+s*.707,m=l+h+s*.707;break}case"bottom-left":{let p=3*Math.PI/4,f=d*Math.cos(p),h=c*Math.sin(p);u=a+f-s*.707,m=l+h+s*.707;break}case"top-left":{let p=-3*Math.PI/4,f=d*Math.cos(p),h=c*Math.sin(p);u=a+f-s*.707,m=l+h-s*.707;break}default:return null}return re(J(u,m),i,n.angle)}if(Ei(n)){let[a,l]=Jt(n),[d,c,u,m]=a,p,f;switch(r){case"top":{let h=Me(d[0],d[1]);p=h[0],f=h[1]-s;break}case"right":{let h=Me(c[0],c[1]);p=h[0]+s,f=h[1];break}case"bottom":{let h=Me(u[0],u[1]);p=h[0],f=h[1]+s;break}case"left":{let h=Me(m[0],m[1]);p=h[0]-s,f=h[1];break}case"top-left":{if(l.length>=1){let h=l[0],E=h[0],g=h[3],x=Me(E,g);p=x[0]-s*.707,f=x[1]-s*.707}else p=n.x-s,f=n.y-s;break}case"top-right":{if(l.length>=2){let h=l[1],E=h[0],g=h[3],x=Me(E,g);p=x[0]+s*.707,f=x[1]-s*.707}else p=n.x+n.width+s,f=n.y-s;break}case"bottom-right":{if(l.length>=3){let h=l[2],E=h[0],g=h[3],x=Me(E,g);p=x[0]+s*.707,f=x[1]+s*.707}else p=n.x+n.width+s,f=n.y+n.height+s;break}case"bottom-left":{if(l.length>=4){let h=l[3],E=h[0],g=h[3],x=Me(E,g);p=x[0]-s*.707,f=x[1]+s*.707}else p=n.x-s,f=n.y+n.height+s;break}default:return null}return re(J(p,f),i,n.angle)}return null},Me=(e,t)=>J((e[0]+t[0])/2,(e[1]+t[1])/2);var ss=({points:e})=>{let t=e[0][0],n=e[0][1];return{points:e.map(i=>G(i[0]-t,i[1]-n)),offsetX:t,offsetY:n}},O=class e{elementId;selectedPointsIndices;initialState;isDragging;lastUncommittedPoint;lastCommittedPoint;pointerOffset;hoverPointIndex;segmentMidPointHoveredCoords;hoveredFocusPointBinding;draggedFocusPointBinding;elbowed;customLineAngle;isEditing;pointerDownState;constructor(t,n,i=!1){this.elementId=t.id,_l(t.points[0],G(0,0))||(console.error("Linear element is not normalized",Error().stack),be(t,n,e.getNormalizeElementPointsAndCoords(t))),this.selectedPointsIndices=null,this.lastUncommittedPoint=null,this.lastCommittedPoint=null,this.isDragging=!1,this.pointerOffset={x:0,y:0},this.initialState={prevSelectedPointsIndices:null,lastClickedPoint:-1,origin:null,segmentMidpoint:{value:null,index:null,added:!1},arrowStartIsInside:!1,altFocusPoint:null},this.hoverPointIndex=-1,this.segmentMidPointHoveredCoords=null,this.hoveredFocusPointBinding=null,this.draggedFocusPointBinding=null,this.elbowed=_(t)&&t.elbowed,this.customLineAngle=null,this.isEditing=i}static POINT_HANDLE_SIZE=10;static getElement(t,n){let i=n.get(t);return i||null}static handleBoxSelection(t,n,i,o){if(!n.selectedLinearElement?.isEditing||!n.selectionElement)return!1;let{selectedLinearElement:r}=n,{selectedPointsIndices:s,elementId:a}=r,l=e.getElement(a,o);if(!l)return!1;let[d,c,u,m]=V(n.selectionElement,o),f=e.getPointsGlobalCoordinates(l,o).reduce((h,E,g)=>((E[0]>=d&&E[0]<=u&&E[1]>=c&&E[1]<=m||t.shiftKey&&s?.includes(g))&&h.push(g),h),[]).filter(h=>!(_(l)&&h!==0&&h!==l.points.length-1));i({selectedLinearElement:{...r,selectedPointsIndices:f.length?f:null}})}static handlePointerMove(t,n,i,o,r){let s=n.scene.getNonDeletedElementsMap(),a=n.scene.getNonDeletedElements(),{elementId:l}=r,d=e.getElement(l,s);Le(d,"Element being dragged must exist in the scene"),Le(d.points.length>1,"Element must have at least 2 points");let c=d.points.length-1,u=d.points[c],m=d.points[c-1],p=r.customLineAngle??Zl(m,d.points[c]),f=0,h=0;if(Bi(t)){let[b,I]=e._getShiftLockedDelta(d,s,m,G(i,o),t[Gn.CTRL_OR_CMD]?null:n.getEffectiveGridSize(),p),S=G(b+m[0],I+m[1]);f=S[0]-u[0],h=S[1]-u[1]}else{let b=e.createPointAt(d,s,i-r.pointerOffset.x,o-r.pointerOffset.y,t[Gn.CTRL_OR_CMD]?null:n.getEffectiveGridSize());f=b[0]-u[0],h=b[1]-u[1]}let E=null,{positions:g,updates:x}=$l([c],f,h,i,o,s,d,a,n,Bi(t),t.altKey,r);if(e.movePoints(d,n.scene,g,{startBinding:x?.startBinding,endBinding:x?.endBinding,moveMidPointsWithElement:x?.moveMidPointsWithElement}),Se(d,!1)&&wt(n.state)&&(E=x?.suggestedBinding??null),Se(d)&&Xl(e.getPointGlobalCoordinates(d,d.points[d.points.length-1],s),d,a,s,n.scene),n.state.selectedLinearElement?.customLineAngle===p&&r.initialState.altFocusPoint&&(!E||Kp(n.state.suggestedBinding??[],E)))return null;let w=Se(d)&&d.startBinding&&s.get(d.startBinding.elementId);return{selectedLinearElement:{...r,customLineAngle:p,initialState:{...r.initialState,altFocusPoint:!r.initialState.altFocusPoint&&w&&x?.suggestedBinding?.element.id!==w.id?Vl(d,G(d.x,d.y),w,"start",s,n.state.zoom):r.initialState.altFocusPoint}},suggestedBinding:E}}static handlePointDragging(t,n,i,o,r){let s=n.scene.getNonDeletedElementsMap(),a=n.scene.getNonDeletedElements(),{elbowed:l,elementId:d,initialState:c}=r,u=Array.from(r.selectedPointsIndices??[]),{lastClickedPoint:m}=c,p=e.getElement(d,s);Le(p,"Element being dragged must exist in the scene"),Le(p.points.length>1,"Element must have at least 2 points"),Le(u,"There must be selected points in order to drag them"),l&&u.some((M,U)=>M>0&&M!==p.points.length-1?(u[U]=p.points.length-1,m=p.points.length-1,!0):!1),Le(m>-1&&u.includes(m)&&p.points[m],`There must be a valid lastClickedPoint in order to drag it. selectedPointsIndices(${JSON.stringify(u)}) points(0..${p.points.length-1}) lastClickedPoint(${m})`);let f=p.points[m],h=p.points[m===0?1:m-1],E=u.length===1,g=r.customLineAngle??Zl(h,p.points[m]),x=u.includes(0),w=u.includes(p.points.length-1),y=0,b=0;if(Bi(t)&&E){let[M,U]=e._getShiftLockedDelta(p,s,h,G(i,o),t[Gn.CTRL_OR_CMD]?null:n.getEffectiveGridSize(),g),Y=G(M+h[0],U+h[1]);y=Y[0]-f[0],b=Y[1]-f[1]}else{let M=e.createPointAt(p,s,i-r.pointerOffset.x,o-r.pointerOffset.y,t[Gn.CTRL_OR_CMD]?null:n.getEffectiveGridSize());y=M[0]-f[0],b=M[1]-f[1]}let I=null,{positions:S,updates:T}=$l(u,y,b,i,o,s,p,a,n,Bi(t)&&E,t.altKey,r);e.movePoints(p,n.scene,S,{startBinding:T?.startBinding,endBinding:T?.endBinding,moveMidPointsWithElement:T?.moveMidPointsWithElement}),Se(p,!1)&&wt(n.state)&&(x||w)&&(I=T?.suggestedBinding??null),Se(p)&&x!==w&&Xl(e.getPointGlobalCoordinates(p,x?p.points[0]:p.points[p.points.length-1],s),p,a,s,n.scene),$(p,s)&&Bn(p,n.scene,!1);let F=l?w?[p.points.length-1]:[0]:u,B=l?F[0]:m,k=!x&&!w?e.getPointGlobalCoordinates(p,f,s):null,C=B,X=Se(p)&&p.startBinding&&s.get(p.startBinding.elementId),N=Se(p)&&p.endBinding&&s.get(p.endBinding.elementId),Z=w&&X&&T?.suggestedBinding?.element.id!==X.id?X:x&&N&&T?.suggestedBinding?.element.id!==N.id?N:null;return{selectedLinearElement:{...r,selectedPointsIndices:F,initialState:{...r.initialState,lastClickedPoint:B,altFocusPoint:!r.initialState.altFocusPoint&&Se(p)&&Z?Vl(p,G(p.x,p.y),Z,"start",s,n.state.zoom):r.initialState.altFocusPoint},segmentMidPointHoveredCoords:k,hoverPointIndex:C,isDragging:!0,customLineAngle:g},suggestedBinding:I}}static handlePointerUp(t,n,i,o){let r=o.getNonDeletedElementsMap(),{elementId:s,selectedPointsIndices:a,isDragging:l,initialState:d}=n,c=e.getElement(s,r);if(!c)return n;if(l&&a)for(let u of a)(u===0||u===c.points.length-1)&&Qp(c.points,i.zoom.value)&&(Bt(c)&&o.mutateElement(c,{...ql(c,!0)},{informMutation:!1,isDragging:!1}),e.movePoints(c,o,new Map([[u,{point:u===0?c.points[c.points.length-1]:c.points[0]}]])));return{...n,segmentMidPointHoveredCoords:null,hoverPointIndex:-1,selectedPointsIndices:l||t.shiftKey?!l&&t.shiftKey&&d.prevSelectedPointsIndices?.includes(d.lastClickedPoint)?a&&a.filter(u=>u!==d.lastClickedPoint):a:a?.includes(d.lastClickedPoint)?[d.lastClickedPoint]:a,isDragging:!1,customLineAngle:null,initialState:{...n.initialState,origin:null,arrowStartIsInside:!1}}}static getEditorMidPoints=(t,n,i)=>{let o=$(t,n);if(!_(t)&&!i.selectedLinearElement?.isEditing&&t.points.length>2&&!o)return[];let r=e.getPointsGlobalCoordinates(t,n),s=0,a=[];for(;s<r.length-1;){if(e.isSegmentTooShort(t,t.points[s],t.points[s+1],s,i.zoom)){a.push(null),s++;continue}let l=e.getSegmentMidPoint(t,s+1);a.push(l),s++}return a};static getSegmentMidpointHitCoords=(t,n,i,o)=>{let{elementId:r}=t,s=e.getElement(r,o);if(!s)return null;let a=e.getPointIndexUnderCursor(s,o,i.zoom,n.x,n.y);if(!_(s)&&a>=0||e.getPointsGlobalCoordinates(s,o).length>=3&&!i.selectedLinearElement?.isEditing&&!_(s))return null;let d=(e.POINT_HANDLE_SIZE+1)/i.zoom.value,c=t.segmentMidPointHoveredCoords;if(c&&On(G(c[0],c[1]),G(n.x,n.y))<=d)return c;let u=0,m=e.getEditorMidPoints(s,o,i);for(;u<m.length;){if(m[u]!==null&&On(m[u],G(n.x,n.y))<=d)return m[u];u++}return null};static isSegmentTooShort(t,n,i,o,r){if(_(t))return o>=0&&o<t.points.length?On(n,i)*r.value<e.POINT_HANDLE_SIZE/2:!1;let s=On(n,i);if(t.points.length>2&&t.roundness){let[a,l]=Wl(t);Le(a.length===0&&l.length>0,"Only linears built out of curves are supported"),Le(a.length+l.length>=o,"Invalid segment index while calculating mid point"),s=$p(l[o])}return s*r.value<e.POINT_HANDLE_SIZE*4}static getSegmentMidPoint(t,n){if(_(t)){Le(t.points.length>=n,"Invalid segment index while calculating elbow arrow mid point");let r=Hl(t.points[n-1],t.points[n]);return G(t.x+r[0],t.y+r[1])}let[i,o]=Wl(t);if(Le(i.length===0&&o.length>0||i.length>0&&o.length===0,"Only linears built out of either segments or curves are supported"),Le(i.length+o.length>=n,"Invalid segment index while calculating mid point"),i.length){let r=i[n-1];return Hl(r[0],r[1])}if(o.length){let r=o[n-1];return Zp(r,.5)}Le(!1,"Invalid segment type while calculating mid point")}static getSegmentMidPointIndex(t,n,i,o){let r=e.getElement(t.elementId,o);if(!r)return-1;let s=e.getEditorMidPoints(r,o,n),a=0;for(;a<s.length;){if(e.arePointsEqual(i,s[a]))return a+1;a++}return-1}static handlePointerDown(t,n,i,o,r,s){let a=n.state,l=s.getNonDeletedElementsMap(),d={didAddPoint:!1,hitElement:null,linearElementEditor:null};if(!r)return d;let{elementId:c}=r,u=e.getElement(c,l);if(!u)return d;let m=e.getSegmentMidpointHitCoords(r,o,a,l),p=G(o.x,o.y),f=null;if(m)f=e.getSegmentMidPointIndex(r,a,m,l);else if(t.altKey&&a.selectedLinearElement?.isEditing)return r.lastUncommittedPoint==null&&(s.mutateElement(u,{points:[...u.points,e.createPointAt(u,l,o.x,o.y,t[Gn.CTRL_OR_CMD]?null:n.getEffectiveGridSize())]}),d.didAddPoint=!0),i.scheduleCapture(),d.linearElementEditor={...r,initialState:{prevSelectedPointsIndices:r.selectedPointsIndices,lastClickedPoint:-1,origin:p,segmentMidpoint:{value:m,index:f,added:!1},arrowStartIsInside:!!n.state.newElement&&(n.state.bindMode==="inside"||n.state.bindMode==="skip"),altFocusPoint:null},selectedPointsIndices:[u.points.length-1],lastUncommittedPoint:null},d.didAddPoint=!0,d;let h=e.getPointIndexUnderCursor(u,l,a.zoom,o.x,o.y);(h>=0||m)&&(d.hitElement=u);let[E,g,x,w]=V(u,l),y=(E+x)/2,b=(g+w)/2,I=h>-1&&Be(G(u.x+u.points[h][0],u.y+u.points[h][1]),G(y,b),u.angle),S=h>-1||t.shiftKey?t.shiftKey||r.selectedPointsIndices?.includes(h)?Jp([...r.selectedPointsIndices||[],h]):[h]:null;return d.linearElementEditor={...r,initialState:{prevSelectedPointsIndices:r.selectedPointsIndices,lastClickedPoint:h,origin:p,segmentMidpoint:{value:m,index:f,added:!1},arrowStartIsInside:!!n.state.newElement&&(n.state.bindMode==="inside"||n.state.bindMode==="skip"),altFocusPoint:null},selectedPointsIndices:S,pointerOffset:I?{x:o.x-I[0],y:o.y-I[1]}:{x:0,y:0}},d}static arePointsEqual(t,n){return!t&&!n?!0:!t||!n?!1:_l(t,n)}static handlePointerMoveInEditMode(t,n,i,o){let r=o.state;if(!r.selectedLinearElement?.isEditing)return null;let{elementId:s,lastUncommittedPoint:a}=r.selectedLinearElement,l=o.scene.getNonDeletedElementsMap(),d=e.getElement(s,l);if(!d)return r.selectedLinearElement;let{points:c}=d,u=c[c.length-1];if(!t.altKey)return u===a&&e.deletePoints(d,o,[c.length-1]),r.selectedLinearElement?.lastUncommittedPoint?{...r.selectedLinearElement,lastUncommittedPoint:null}:r.selectedLinearElement;let m;if(Bi(t)&&c.length>=2){let p=c[c.length-2],[f,h]=e._getShiftLockedDelta(d,l,p,G(n,i),t[Gn.CTRL_OR_CMD]?null:o.getEffectiveGridSize());m=G(f+p[0],h+p[1])}else m=e.createPointAt(d,l,n-r.selectedLinearElement.pointerOffset.x,i-r.selectedLinearElement.pointerOffset.y,t[Gn.CTRL_OR_CMD]||_(d)?null:o.getEffectiveGridSize());return u===a?e.movePoints(d,o.scene,new Map([[d.points.length-1,{point:m}]])):e.addPoints(d,o.scene,[m]),{...r.selectedLinearElement,lastUncommittedPoint:d.points[d.points.length-1]}}static getPointGlobalCoordinates(t,n,i){let[o,r,s,a]=V(t,i),l=(o+s)/2,d=(r+a)/2,{x:c,y:u}=t;return Be(G(c+n[0],u+n[1]),G(l,d),t.angle)}static getPointsGlobalCoordinates(t,n){let[i,o,r,s]=V(t,n),a=(i+r)/2,l=(o+s)/2;return t.points.map(d=>{let{x:c,y:u}=t;return Be(G(c+d[0],u+d[1]),G(a,l),t.angle)})}static getPointAtIndexGlobalCoordinates(t,n,i){let o=n<0?t.points.length+n:n,[,,,,r,s]=V(t,i),a=G(r,s),l=t.points[o],{x:d,y:c}=t;return l?Be(G(d+l[0],c+l[1]),a,t.angle):Be(G(d,c),a,t.angle)}static pointFromAbsoluteCoords(t,n,i){if(_(t))return G(n[0]-t.x,n[1]-t.y);let[o,r,s,a]=V(t,i),l=(o+s)/2,d=(r+a)/2,[c,u]=Be(G(n[0],n[1]),G(l,d),-t.angle);return G(c-t.x,u-t.y)}static getPointIndexUnderCursor(t,n,i,o,r){let s=e.getPointsGlobalCoordinates(t,n),a=s.length;for(;--a>-1;){let l=s[a];if(On(G(o,r),G(l[0],l[1]))*i.value<e.POINT_HANDLE_SIZE+1)return a}return-1}static createPointAt(t,n,i,o,r){let s=Yl(i,o,r),[a,l,d,c]=V(t,n),u=(a+d)/2,m=(l+c)/2,[p,f]=Be(G(s[0],s[1]),G(u,m),-t.angle);return G(p-t.x,f-t.y)}static getNormalizeElementPointsAndCoords(t){let{points:n,offsetX:i,offsetY:o}=ss(t);return{points:n,x:t.x+i,y:t.y+o}}static duplicateSelectedPoints(t,n){Le(t.selectedLinearElement?.isEditing,"Not currently editing a linear element");let i=n.getNonDeletedElementsMap(),{selectedPointsIndices:o,elementId:r}=t.selectedLinearElement,s=e.getElement(r,i);Le(s,"The linear element does not exist in the provided Scene"),Le(o!=null,"There are no selected points to duplicate");let{points:a}=s,l=[],d=!1,c=-1,u=a.reduce((m,p,f)=>{if(++c,m.push(p),o.includes(f)){let E=a[f+1];E||(d=!0),m.push(E?G((p[0]+E[0])/2,(p[1]+E[1])/2):G(p[0],p[1])),l.push(c+1),++c}return m},[]);if(n.mutateElement(s,{points:u}),d){let m=s.points[s.points.length-1];e.movePoints(s,n,new Map([[s.points.length-1,{point:G(m[0]+30,m[1]+30)}]]))}return{...t,selectedLinearElement:{...t.selectedLinearElement,selectedPointsIndices:l}}}static deletePoints(t,n,i){let o=n.state.selectedLinearElement?.isEditing&&n.state.selectedLinearElement?.lastUncommittedPoint===t.points[t.points.length-1],r=t.points.filter((c,u)=>!i.includes(u));Bt(t)&&t.polygon&&(o||i.includes(0)||i.includes(t.points.length-1))&&(r[0]=G(r[r.length-1][0],r[r.length-1][1]));let{points:a,offsetX:l,offsetY:d}=ss({points:r});e._updatePoints(t,n.scene,a,l,d)}static addPoints(t,n,i){let o=[...t.points,...i];Bt(t)&&t.polygon&&(o[0]=G(o[o.length-1][0],o[o.length-1][1]));let{points:r,offsetX:s,offsetY:a}=ss({points:o});e._updatePoints(t,n,r,s,a)}static movePoints(t,n,i,o){let{points:r}=t;if(Bt(t)&&t.polygon){let c=i.get(0),u=i.get(r.length-1);c?i.set(r.length-1,{point:G(c.point[0],c.point[1]),isDragging:c.isDragging}):u&&i.set(0,{point:G(u.point[0],u.point[1]),isDragging:u.isDragging})}let s=i.get(0)?.point??G(0,0),[a,l]=s,d=_(t)?[i.get(0)?.point??r[0],i.get(r.length-1)?.point??r[r.length-1]]:r.map((c,u)=>{let m=i.get(u)?.point??c;return o?.moveMidPointsWithElement&&u!==0&&u!==r.length-1&&!i.has(u)?m:G(m[0]-a,m[1]-l)});e._updatePoints(t,n,d,a,l,o,{isDragging:Array.from(i.values()).some(c=>c.isDragging)})}static shouldAddMidpoint(t,n,i,o){let r=e.getElement(t.elementId,o);if(r&&_(r)||!r)return!1;let{segmentMidpoint:s}=t.initialState;if(s.added||s.value===null||s.index===null||t.initialState.origin===null)return!1;let a=t.initialState.origin,l=On(a,G(n.x,n.y));return!(!i.selectedLinearElement?.isEditing&&l<qp/i.zoom.value)}static addMidpoint(t,n,i,o,r){let s=r.getNonDeletedElementsMap(),a=e.getElement(t.elementId,s);if(!a)return;let{segmentMidpoint:l}=t.initialState,d={pointerDownState:t.initialState,selectedPointsIndices:t.selectedPointsIndices},c=e.createPointAt(a,s,n.x,n.y,o&&!_(a)?i.getEffectiveGridSize():null),u=[...a.points.slice(0,l.index),c,...a.points.slice(l.index)];return r.mutateElement(a,{points:u}),d.pointerDownState={...t.initialState,segmentMidpoint:{...t.initialState.segmentMidpoint,added:!0},lastClickedPoint:l.index},d.selectedPointsIndices=[l.index],d}static _updatePoints(t,n,i,o,r,s,a){if(_(t)){let l={};s?.startBinding!==void 0&&(l.startBinding=s.startBinding),s?.endBinding!==void 0&&(l.endBinding=s.endBinding),l.points=Array.from(i),n.mutateElement(t,l,{informMutation:!0,isDragging:a?.isDragging??!1})}else{let l=as(t,i),d=as(t,t.points),c=(l[0]+l[2])/2,u=(l[1]+l[3])/2,m=(d[0]+d[2])/2,p=(d[1]+d[3])/2,f=m-c,h=p-u,E=Be(G(o,r),G(f,h),t.angle);n.mutateElement(t,{...s,points:i,x:t.x+E[0],y:t.y+E[1]})}}static _getShiftLockedDelta(t,n,i,o,r,s){let a=e.getPointGlobalCoordinates(t,i,n);if(_(t))return[o[0]-a[0],o[1]-a[1]];let[l,d]=Yl(o[0],o[1],r),{width:c,height:u}=Kl(a[0],a[1],l,d,s);return Be(G(c,u),G(0,0),-t.angle)}static getBoundTextElementPosition=(t,n,i)=>{e.getPointsGlobalCoordinates(t,i).length<2&&be(n,i,{isDeleted:!0});let r=0,s=0;if(t.points.length%2===1){let a=Math.floor(t.points.length/2),l=e.getPointGlobalCoordinates(t,t.points[a],i);r=l[0]-n.width/2,s=l[1]-n.height/2}else{let a=t.points.length/2-1,l=e.getSegmentMidPoint(t,a+1);r=l[0]-n.width/2,s=l[1]-n.height/2}return{x:r,y:s}};static getMinMaxXYWithBoundText=(t,n,i,o)=>{let[r,s,a,l]=i,d=(r+a)/2,c=(s+l)/2,{x:u,y:m}=e.getBoundTextElementPosition(t,o,n),p=u+o.width,f=m+o.height,h=G(d,c),E=Be(G(r,s),h,t.angle),g=Be(G(a,s),h,t.angle),x=Be(G(u,m),h,-t.angle),w=Be(G(p,m),h,-t.angle),y=Be(G(u,f),h,-t.angle),b=Be(G(p,f),h,-t.angle);return E[0]<g[0]&&E[1]>=g[1]?(r=Math.min(r,y[0]),a=Math.max(a,Math.max(w[0],b[0])),s=Math.min(s,x[1]),l=Math.max(l,b[1])):E[0]>=g[0]&&E[1]>g[1]?(r=Math.min(r,b[0]),a=Math.max(a,Math.max(x[0],w[0])),s=Math.min(s,y[1]),l=Math.max(l,w[1])):E[0]>=g[0]?(r=Math.min(r,w[0]),a=Math.max(a,y[0]),s=Math.min(s,b[1]),l=Math.max(l,x[1])):E[1]<=g[1]&&(r=Math.min(r,Math.min(w[0],x[0])),a=Math.max(a,b[0]),s=Math.min(s,w[1]),l=Math.max(l,y[1])),[r,s,a,l,d,c]};static getElementAbsoluteCoords=(t,n,i=!1)=>{let o=Ze.generateElementShape(t,null),r=vt(o[0]),[s,a,l,d]=Li(r),c=s+t.x,u=a+t.y,m=l+t.x,p=d+t.y,f=(c+m)/2,h=(u+p)/2,E=i&&$(t,n);return E?e.getMinMaxXYWithBoundText(t,n,[c,u,m,p],E):[c,u,m,p,f,h]};static moveFixedSegment(t,n,i,o,r){let s=r.getNonDeletedElementsMap(),a=e.getElement(t.elementId,s);if(!a||!_(a))return t;if(n&&n>0&&n<a.points.length){let l=Ne(Nt(Vp(a.points[n],a.points[n-1]))),d=(a.fixedSegments??[]).reduce((p,f)=>(p[f.index]=f,p),{});d[n]={index:n,start:G(l?a.points[n-1][0]:i-a.x,l?o-a.y:a.points[n-1][1]),end:G(l?a.points[n][0]:i-a.x,l?o-a.y:a.points[n][1])};let c=Object.values(d).sort((p,f)=>p.index-f.index),u=c.map(p=>p.index).reduce((p,f)=>f<n?p+1:p,0);r.mutateElement(a,{fixedSegments:c});let m=G(a.x+(a.fixedSegments[u].start[0]+a.fixedSegments[u].end[0])/2,a.y+(a.fixedSegments[u].start[1]+a.fixedSegments[u].end[1])/2);return{...t,segmentMidPointHoveredCoords:m,initialState:{...t.initialState,segmentMidpoint:{added:!1,index:a.fixedSegments[u].index,value:m}}}}return t}static deleteFixedSegment(t,n,i){n.mutateElement(t,{fixedSegments:t.fixedSegments?.filter(o=>o.index!==i)})}},Jp=e=>{let t=[...new Set(e.filter(n=>n!==null&&n!==-1))];return t=t.sort((n,i)=>n-i),t.length?t:null},$l=(e,t,n,i,o,r,s,a,l,d,c,u)=>{let m=new Map(e.map(L=>[L,{point:G(s.points[L][0]+t,s.points[L][1]+n),isDragging:!0}]));if(!H(s))return{positions:m};let p=e.includes(0),f=e.includes(s.points.length-1),{start:h,end:E}=os(s,m,i,o,r,a,l.state,{newArrow:!!l.state.newElement,angleLocked:d,altKey:c});if(_(s)){let L=p?h.element:f?E.element:null;return{positions:m,updates:{suggestedBinding:L?{element:L,midPoint:rs(L,r,G(i-u.pointerOffset.x,o-u.pointerOffset.y))}:null}}}if(!p&&!f){let L={...s,points:s.points.map((U,Y)=>m.get(Y)?.point??U)},M=new Map(m);if(s.startBinding){let U=r.get(s.startBinding.elementId);if(U){let Y=dt(L,"startBinding",s.startBinding,U,r)??null;Y&&M.set(0,{point:Y,isDragging:!0})}}if(s.endBinding){let U=r.get(s.endBinding.elementId);if(U){let Y=dt(L,"endBinding",s.endBinding,U,r)??null;Y&&M.set(s.points.length-1,{point:Y,isDragging:!0})}}return{positions:M}}if(p===f)return{positions:m};let g={suggestedBinding:null};h.mode===null?g.startBinding=null:h.mode?(g.startBinding={elementId:h.element.id,mode:h.mode,...Zn(s,h.element,"start",r,h.focusPoint)},p&&(g.startBinding.mode==="orbit"||!qn("COMPLEX_BINDINGS"))&&(g.suggestedBinding=h.element?{element:h.element,midPoint:jl(G(i-u.pointerOffset.x,o-u.pointerOffset.y),h.element,r,l.state.zoom)}:null)):p&&(g.suggestedBinding=l.state.suggestedBinding),E.mode===null?g.endBinding=null:E.mode?(g.endBinding={elementId:E.element.id,mode:E.mode,...Zn(s,E.element,"end",r,E.focusPoint)},f&&(g.endBinding.mode==="orbit"||!qn("COMPLEX_BINDINGS"))&&(g.suggestedBinding=E.element?{element:E.element,midPoint:jl(G(i-u.pointerOffset.x,o-u.pointerOffset.y),E.element,r,l.state.zoom)}:null)):f&&(g.suggestedBinding=l.state.suggestedBinding);let x=p?G(s.points[0][0]+t,s.points[0][1]+n):s.points[0],w=f?G(s.points[s.points.length-1][0]+t,s.points[s.points.length-1][1]+n):s.points[s.points.length-1],y={...s,points:[x,...s.points.slice(1,-1),w],startBinding:g.startBinding===void 0?s.startBinding:g.startBinding===null?null:g.startBinding,endBinding:g.endBinding===void 0?s.endBinding:g.endBinding===null?null:g.endBinding},b=h.focusPoint&&E.focusPoint?Ul(h.focusPoint,E.focusPoint):void 0,I=h.focusPoint&&E.focusPoint?Ul(E.focusPoint,h.focusPoint):void 0,S=s.endBinding&&y.startBinding&&p&&y.startBinding.elementId===s.endBinding.elementId,T=s.startBinding&&y.endBinding&&f&&s.startBinding.elementId===y.endBinding.elementId,A=y.endBinding?E.element??r.get(y.endBinding.elementId):null,F=S?y.points[y.points.length-1]:T&&l.state.bindMode!=="inside"&&qn("COMPLEX_BINDINGS")?y.points[0]:A&&dt(s,"endBinding",y.endBinding,A,r,{customIntersector:I})||y.points[y.points.length-1];y.points[y.points.length-1]=F;let B=y.startBinding?h.element??r.get(y.startBinding.elementId):null,k=T&&qn("COMPLEX_BINDINGS")?y.points[0]:S&&l.state.bindMode!=="inside"&&qn("COMPLEX_BINDINGS")?F:B&&dt(s,"startBinding",y.startBinding,B,r,{customIntersector:b})||y.points[0],C=!S&&!(T&&l.state.bindMode!=="inside"&&qn("COMPLEX_BINDINGS"))&&!!A,X=On(k,y.points[0])!==0,N=new Set(e);B&&X&&N.add(0),A&&C&&N.add(s.points.length-1);let Z=Array.from(N);return{updates:g,positions:new Map(Z.map(L=>[L,L===0?{point:k,isDragging:!0}:L===s.points.length-1?{point:F,isDragging:!0}:m.get(L)]))}},Zl=(e,t)=>Math.atan2(t[1]-e[1],t[0]-e[0]);P();import{arrayToMap as Pt}from"@excalidraw/common";import{isPointWithinBounds as Pf,pointFrom as ms}from"@excalidraw/math";P();import{vectorCross as td,vectorFromPoint as ko}from"@excalidraw/math";function Ql(e){return[Math.min(e[0][0],e[1][0]),Math.min(e[0][1],e[1][1]),Math.max(e[0][0],e[1][0]),Math.max(e[0][1],e[1][1])]}function ef(e,t){return e[0]<=t[2]&&e[2]>=t[0]&&e[1]<=t[3]&&e[3]>=t[1]}var tf=1e-6;function Jl(e,t){let n=ko(e[1],e[0]),i=ko(t,e[0]),o=td(n,i);return Math.abs(o)<tf}function ls(e,t){let n=ko(e[1],e[0]),i=ko(t,e[0]);return td(n,i)<0}function ed(e,t){return Jl(e,t[0])||Jl(e,t[1])||(ls(e,t[0])?!ls(e,t[1]):ls(e,t[1]))}function nd(e,t){return ef(Ql(e),Ql(t))&&ed(e,t)&&ed(t,e)}P();import{arrayToMap as nf}from"@excalidraw/common";import{getElementBounds as of}from"@excalidraw/element";import{isArrowElement as rf,isExcalidrawElement as sf,isFreeDrawElement as af,isLinearElement as lf,isTextElement as df}from"@excalidraw/element";import{rangeIncludesValue as Fo,pointFrom as _t,pointRotateRads as cf,rangeInclusive as Ro}from"@excalidraw/math";var uf=e=>e.type==="diamond"?[_t(e.width/2,0),_t(e.width,e.height/2),_t(e.width/2,e.height),_t(0,e.height/2)]:[_t(0,0),_t(0+e.width,0),_t(0+e.width,e.height),_t(0,e.height)],mf=e=>lf(e)||af(e)?e.points:uf(e),id=e=>{let t=e.reduce((n,[i,o])=>(n.minY=Math.min(n.minY,o),n.minX=Math.min(n.minX,i),n.maxX=Math.max(n.maxX,i),n.maxY=Math.max(n.maxY,o),n),{minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0,cx:0,cy:0});return t.cx=(t.maxX+t.minX)/2,t.cy=(t.maxY+t.minY)/2,t},rd=e=>{let t=mf(e),{cx:n,cy:i}=id(t),o=_t(n,i),r=t.map(c=>cf(c,o,e.angle)),{minX:s,minY:a,maxX:l,maxY:d}=id(r);return[s+e.x,a+e.y,l+e.x,d+e.y]},od=(e,t,n=!1)=>{let i=rd(e),o=t[0]<=i[0]&&t[2]>=i[2]&&t[1]<=i[1]&&t[3]>=i[3];return n?o?!0:i[0]<=t[0]&&i[2]>=t[2]&&i[1]<=t[1]&&i[3]>=t[3]:o},pf=(e,t)=>{let n=rd(e);return(Fo(n[0],Ro(t[0],t[2]))||Fo(t[0],Ro(n[0],n[2])))&&(Fo(n[1],Ro(t[1],t[3]))||Fo(t[1],Ro(n[1],n[3])))},sd=({elements:e,bounds:t,type:n,errorMargin:i=0})=>{sf(t)&&(t=of(t,nf(e)));let o=[t[0]-i,t[1]-i,t[2]+i,t[3]+i],r=new Set;for(let s of e){if(r.has(s.id))continue;if(n==="overlap"?pf(s,o):n==="inside"?od(s,o):od(s,o,!0)){if(r.add(s.id),s.boundElements)for(let l of s.boundElements)r.add(l.id);df(s)&&s.containerId&&r.add(s.containerId),rf(s)&&(s.startBinding&&r.add(s.startBinding.elementId),s.endBinding&&r.add(s.endBinding?.elementId))}}return e.filter(s=>r.has(s.id))};P();import{arrayToMap as wf,isShallowEqual as bf}from"@excalidraw/common";P();var ff=(e,t,n)=>{let i=n.reduce((o,r)=>(r.groupIds.includes(e)&&(o[r.id]=!0),o),{});return Object.keys(i).length<2?t.selectedGroupIds[e]||t.editingGroupId===e?{selectedElementIds:t.selectedElementIds,selectedGroupIds:{...t.selectedGroupIds,[e]:!1},editingGroupId:null}:t:{editingGroupId:t.editingGroupId,selectedGroupIds:{...t.selectedGroupIds,[e]:!0},selectedElementIds:{...t.selectedElementIds,...i}}},ad=function(){let e=null,t=null,n=null,i=(r,s,a,l)=>{if(n!==void 0&&s===t&&r===e&&a.editingGroupId===n?.editingGroupId)return n;let d={};for(let m of r){let p=m.groupIds;if(a.editingGroupId){let f=p.indexOf(a.editingGroupId);f>-1&&(p=p.slice(0,f))}if(p.length>0){let f=p[p.length-1];d[f]=!0}}let c={},u=s.reduce((m,p)=>{if(p.isDeleted)return m;let f=p.groupIds.find(h=>d[h]);return f&&(m[p.id]=!0,Array.isArray(c[f])?c[f].push(p.id):c[f]=[p.id]),m},{});for(let m of Object.keys(c))c[m].length<2&&d[m]&&(d[m]=!1);return t=s,e=r,n={editingGroupId:a.editingGroupId,selectedGroupIds:d,selectedElementIds:ds({...a.selectedElementIds,...u},l)},n},o=(r,s,a,l)=>{let d=l?l.scene.getSelectedElements({selectedElementIds:r.selectedElementIds,elements:s}):yt(s,r);return d.length?i(d,s,r,a):{selectedGroupIds:{},editingGroupId:null,selectedElementIds:ds(r.selectedElementIds,a)}};return o.clearCache=()=>{t=null,e=null,n=null},o}(),hf=(e,t)=>cs(e,t)!=null,cs=(e,t)=>t.groupIds.filter(n=>n!==e.editingGroupId).find(n=>e.selectedGroupIds[n]),Ef=e=>Object.entries(e.selectedGroupIds).filter(([t,n])=>n).map(([t,n])=>t),ld=(e,t)=>{let n={...t,selectedGroupIds:{}};for(let i of e){let o=i.groupIds;if(t.editingGroupId){let r=o.indexOf(t.editingGroupId);r>-1&&(o=o.slice(0,r))}if(o.length>0){let r=o[o.length-1];n={...n,...ff(r,n,e)}}}return n.selectedGroupIds},n0=(e,t)=>({...e,editingGroupId:t.groupIds.length?t.groupIds[0]:null,selectedGroupIds:{},selectedElementIds:{[t.id]:!0}}),gf=(e,t)=>e.groupIds.includes(t),Ce=(e,t)=>{let n=[];for(let i of e.values())gf(i,t)&&n.push(i);return n},xf=(e,t)=>e.groupIds.find(n=>t[n]),i0=(e,t,n)=>{let i=[...e],o=n?i.indexOf(n):-1,r=o>-1?o:i.length;return i.splice(r,0,t),i},o0=(e,t)=>e.filter(n=>!t[n]),r0=(e,t)=>{let n=new Map;return e.forEach(i=>{let o=i.groupIds.length===0?i.id:i.groupIds[i.groupIds.length-1],r=n.get(o)||[],s=$(i,t);s&&r.push(s),n.set(o,[...r,i])}),Array.from(n.values())},dd=e=>{let t=new Set;for(let[,n]of e)if(!n.isDeleted)for(let i of n.groupIds??[])t.add(i);return t},cd=e=>{let t=e.flatMap(o=>o.groupIds),n=new Map,i=0;for(let o of t)n.set(o,(n.get(o)??0)+1),n.get(o)>i&&(i=n.get(o));return i===e.length},ud=e=>e.groupIds.length>0,md=(e,t,n)=>{let i=[...e],o=t?e.indexOf(t):-1,r=o>-1?o:e.length;for(let s=0;s<r;s++)i[s]=n(i[s]);return i},No=(e,t,n)=>{let i=Ef(n),o=e.filter(u=>!ue(u)),r=new Map,s=new Map,a=u=>{let m=s.get(u.id)||[],p=$(u,t);p&&m.push(p),s.set(u.id,[...m,u])},l=(u,m)=>{let p=r.get(m)||[],f=$(u,t);f&&p.push(f),r.set(m,[...p,u])},d=(u,m)=>{let p=u.groupIds.indexOf(m,0);return u.groupIds.slice(0,p).length>0?l(u,u.groupIds[p-1]):a(u)},c=e.every(u=>hf(n,u));return o.forEach(u=>{let m=xf(u,n.selectedGroupIds);m?i.length===1&&c?d(u,m):l(u,m):a(u)}),Array.from(r.values()).concat(Array.from(s.values()))};var pd=e=>{let t=new Set;return e.forEach(n=>{q(n)&&t.add(n.id)}),e.filter(n=>!(n.frameId&&t.has(n.frameId)))},us=(e,t,n,i=!0)=>{let[o,r,s,a]=V(t,n),l=e.filter(d=>{let[c,u,m,p]=le(d,n),f=Ut(d,n);if(f){let[h,E,g,x]=le(f,n);c=Math.max(h,c),u=Math.max(E,u),m=Math.min(g,m),p=Math.min(x,p)}return d.locked===!1&&d.type!=="selection"&&!ue(d)&&o<=c&&r<=u&&s>=m&&a>=p});return l=i?pd(l):l,l=l.filter(d=>{let c=Ut(d,n);return c?mn(d,c,n):!0}),l},h0=(e,t,n,i)=>{let o=new Set(t.map(r=>r.id));return e.filter(r=>{let s=fd(r,n.width,n.height,n,i);return!o.has(r.id)&&s})},E0=function(){let e=null,t=null,n=null,i=(o,r)=>(n!=null&&o===e&&r.selectedElementIds===t||(n=o.some(s=>r.selectedElementIds[s.id]),e=o,t=r.selectedElementIds),n);return i.clearCache=()=>{e=null,t=null,n=null},i}(),yt=(e,t,n)=>{let i=new Set,o=[];for(let r of e.values()){if(t.selectedElementIds[r.id]){o.push(r),i.add(r.id);continue}if(n?.includeBoundTextElement&&ue(r)&&t.selectedElementIds[r?.containerId]){o.push(r),i.add(r.id);continue}}if(n?.includeElementsInFrames){let r=[];return o.forEach(s=>{q(s)&&pn(e,s.id).forEach(a=>!i.has(a.id)&&r.push(a)),r.push(s)}),r}return o},g0=(e,t)=>t.editingTextElement?[t.editingTextElement]:t.newElement?[t.newElement]:yt(e,t,{includeBoundTextElement:!0}),ds=(e,t)=>bf(t.selectedElementIds,e)?t.selectedElementIds:e,yf=(e,t)=>{let n=e.filter(K);if(n.length===1){let i=n[0],o=i.boundElements?.map(s=>s.id)??[];if(e.every(s=>s.id===i.id||o.includes(s.id)))return new O(i,wf(t))}return null},x0=(e,t,n)=>({selectedLinearElement:yf(e,t),...ad({editingGroupId:n.editingGroupId,selectedElementIds:pd(e).reduce((i,o)=>(ue(o)||(i[o.id]=!0),i),{})},t,n,null)});var hd=(e,t,n)=>{let i=Pt(e);for(let o of t)if(o.frameId){let r=n.get(o.id),s=n.get(o.frameId),a=r&&i.get(r);a&&be(a,i,{frameId:s??null})}};function Kn(e,t,n){let i=ps(t,n),o=ps(e,n);return i.some(s=>o.some(a=>nd(s,a)))}var Ed=(e,t,n)=>zo(us(e,t,n,!1)).filter(i=>!q(i)&&!i.frameId||i.frameId===t.id),fs=(e,t,n)=>us([t],e,n).some(i=>i.id===t.id),L0=(e,t)=>{let n=Pt(e);return e.filter(i=>Kn(i,t,n))},fn=(e,t,n)=>{let[i,o,r,s]=V(t,n),[a,l,d,c]=Ge(e);return i<=a&&o<=l&&r>=d&&s>=c},mn=(e,t,n)=>fn([e],t,n)||Kn(e,t,n)||fs(e,t,n),C0=(e,t,n)=>{let[i,o,r,s]=V(t,n);return Pf(ms(i,o),ms(e.x,e.y),ms(r,s))},G0=(e,t,n)=>{let i=Pt(e),o=t.flatMap(r=>Ce(e,r));return o.length===0?!0:!!o.find(r=>fn([r],n,i)||Kn(r,n,i))},O0=(e,t,n)=>{let i=Pt(e),o=t.flatMap(r=>Ce(e,r));return o.length===0?!0:o.find(r=>fn([r],n,i)||Kn(r,n,i))===void 0},k0=e=>{let t=new Map;for(let n of e){let i=q(n)?n.id:n.frameId;i&&!t.has(i)&&t.set(i,pn(e,i))}return t},pn=(e,t)=>{let n=[];for(let i of e.values())i.frameId===t&&n.push(i);return n},If=e=>e.filter(t=>q(t)),F0=e=>{let t=Pt(If(e));return e.filter(n=>t.has(n.id)||!n.frameId||!t.has(n.frameId))},R0=(e,t,n,i)=>{let o=pn(e,t.id),r=new Set(o),s=new Set([...Ed(e,t,i),...o.filter(m=>fs(m,t,i))]),a=o.filter(m=>!s.has(m)),l=new Set(Array.from(s).flatMap(m=>m.groupIds));for(let m of a)if(!Kn(m,t,i))m.groupIds.length===0&&r.delete(m);else if(m.groupIds.length>0)for(let p of m.groupIds)l.add(p);for(let m of a)if(m.groupIds.length>0){let p=!0;for(let f of m.groupIds)l.has(f)&&(p=!1);p&&r.delete(m)}let d=Array.from(s).filter(m=>m.groupIds.length===0);for(let m of d)r.add(m);let c=Array.from(s).filter(m=>m.groupIds.length>0),u=ld(c,n);for(let[m,p]of Object.entries(u))if(p){let f=Ce(e,m);if(fn(f,t,i))for(let h of f)r.add(h)}return[...r].filter(m=>!(ee(m)&&m.containerId))},N0=(e,t,n)=>Sf(zo(e,Ed(e,t,n)),t,n),Sf=(e,t,n)=>{let i=[],o=new Map;for(let r of e){let s=!1;if(r.groupIds.length>0){if(r.groupIds.some(a=>o.get(a)))s=!0;else{let a=new Set(r.groupIds.flatMap(l=>Ce(n,l)));s=!fn(Array.from(a),t,n)}r.groupIds.forEach(a=>{o.set(a,s)})}s||i.push(r)}return i},Ut=(e,t)=>e.frameId&&t.get(e.frameId)||null,z0=(e,t)=>{let n=new Set,i=Pt(e);e=zo(e);for(let s of e)q(s)&&s.id!==t.id&&n.add(s.id);let o=new Set,r=[];for(let s of e)if(!(q(s)||s.frameId&&n.has(s.frameId)))if(s.groupIds.length){let a=s.groupIds.at(-1);if(!o.has(a)){o.add(a);let l=Ce(e,a);if(l.some(d=>mn(d,t,i)))for(let d of l)r.push(d)}}else mn(s,t,i)&&r.push(s);return r},Af=(e,t,n,i)=>{let o=Pt(e),r=new Map;for(let d of e.values())d.frameId===n.id&&r.set(d.id,!0);let s=new Set(t.map(d=>d.id)),a=[],l=new Set;for(let d of t)q(d)&&d.id!==n.id&&l.add(d.id);for(let d of zo(e,t)){if(q(d)||d.frameId&&l.has(d.frameId)||d.frameId&&i.selectedElementIds[d.id]&&i.selectedElementIds[d.frameId])continue;r.has(d.id)||a.push(d);let c=$(d,o);c&&!s.has(c.id)&&!r.has(c.id)&&a.push(c)}for(let d of a)be(d,o,{frameId:n.id});return e},gd=(e,t)=>{let n=new Map,i=new Map;for(let o of e)if(o.frameId){n.set(o.id,o);let r=i.get(o.frameId)||[];r.push(o);let s=$(o,t);s&&(n.set(s.id,s),r.push(s)),i.set(o.frameId,r)}for(let[,o]of n)be(o,t,{frameId:null})},Mf=(e,t)=>{let n=pn(e,t.id);return gd(n,Pt(e)),e},H0=(e,t,n,i)=>Af(Mf(e,n),t,n,i.state).slice(),_0=(e,t,n)=>{let i=n.scene.getSelectedElements({selectedElementIds:t.selectedElementIds,elements:e}),o=new Set(i);if(t.editingGroupId)for(let a of i)a.groupIds.length===0?o.add(a):a.groupIds.flatMap(l=>Ce(e,l)).forEach(l=>o.add(l));let r=new Set,s=Pt(e);return o.forEach(a=>{a.frameId&&!q(a)&&!xd(a,s,t)&&r.add(a)}),r.size>0&&gd(r,s),e},zo=(e,t)=>{let n=new Set,i=t||e;for(let s of i.values()){let a=s.groupIds[s.groupIds.length-1];a&&n.add(a)}let o=new Set;for(let s of n)Ce(e,s).some(a=>q(a))&&o.add(s);let r=[];for(let s of i.values())o.has(s.groupIds[s.groupIds.length-1])||r.push(s);return r},Tf=(e,t,n)=>{let i=ee(e)&&Ae(e,t)||e;return i.frameId&&n.selectedElementIds[i.id]&&n.selectedElementIds[i.frameId]?Ut(i,t):n.selectedElementIds[i.id]&&n.selectedElementsAreBeingDragged?n.frameToHighlight:Ut(i,t)},xd=(e,t,n,i)=>{let o=i?.targetFrame??Tf(e,t,n);if(!o)return!1;let r=ee(e)&&Ae(e,t)||e,s=l=>{i?.checkedGroups&&r.groupIds.forEach(d=>{i.checkedGroups?.set(d,l)})};if(!n.selectedElementIds[r.id]||!n.selectedElementsAreBeingDragged||n.selectedElementIds[r.id]&&n.selectedElementIds[o.id])return!0;if(r.groupIds.length===0)return mn(r,o,t);for(let l of r.groupIds)if(i?.checkedGroups?.has(l))return i.checkedGroups.get(l);let a=new Set(r.groupIds.filter(l=>i?.checkedGroups?!i.checkedGroups.has(l):!0).flatMap(l=>Ce(t,l)));if(n.editingGroupId&&n.selectedElementsAreBeingDragged){let l=new Set(yt(t,n));if(n.frameToHighlight!==null)return!0;l.forEach(c=>{a.delete(c)})}for(let l of a)if(q(l))return s(!1),!1;for(let l of a)if(mn(l,o,t))return s(!0),!0;return!1},U0=(e,t,n,i,o)=>{if(!n.frameRendering||!n.frameRendering.clip)return!1;let r=Kn(e,t,i)||fs(e,t,i);if(r){for(let s of e.groupIds)o?.set(s,!0);return!0}if(!r&&e.groupIds.length>0&&!fn([e],t,i)){let s=!1;if(n.selectedElementsAreBeingDragged)s=xd(e,i,n,{targetFrame:t,checkedGroups:o});else{s=e.frameId===t.id;for(let a of e.groupIds)o?.set(a,s)}for(let a of e.groupIds)o?.set(a,s);return s}return!1},vf="Frame",Df="AI Frame",Bf=e=>co(e)?vf:Df,Y0=e=>e.name===null?Bf(e):e.name,W0=(e,t)=>sd({elements:e,bounds:t,type:"overlap"}).filter(n=>!n.frameId||n.frameId===t.id),j0=e=>{let t=Pt(e);return e.length>1&&e.some(n=>n.frameId&&t.has(n.frameId))};var _f=(e,t)=>Mn(e)&&!t.imageCache.has(e.fileId),Yo=e=>{switch(e.type){case"freedraw":return e.strokeWidth*12;case"text":return e.fontSize/2;case"arrow":return e.startArrowhead||e.endArrowhead?40:20;default:return 20}},Uf=(e,t,n,i,o=1)=>{let r=(t?.opacity??100)*e.opacity/1e4*o;return(n.has(e.id)||i&&i.some(s=>s.id===e.id)||t&&n.has(t.id))&&(r*=kf/100),r},Yf=(e,t,n)=>{let r=Yo(e),[s,a,l,d]=V(e,t),c=K(e)||Ie(e)?hn(s,l):e.width,u=K(e)||Ie(e)?hn(a,d):e.height,m=c*window.devicePixelRatio+r*2,p=u*window.devicePixelRatio+r*2,f=n.value;return(m*f>32767||p*f>32767)&&(f=Math.min(32767/m,32767/p)),m*p*f*f>16777216&&(f=Math.sqrt(16777216/(m*p))),m=Math.floor(m*f),p=Math.floor(p*f),{width:m,height:p,scale:f}},Pd=(e,t,n,i,o)=>{let r=document.createElement("canvas"),s=r.getContext("2d"),a=Yo(e),{width:l,height:d,scale:c}=Yf(e,t,n);if(!l||!d)return null;r.width=l,r.height=d;let u=-100,m=0;if(K(e)||Ie(e)){let[g,x]=V(e,t);u=e.x>g?hn(e.x,g)*window.devicePixelRatio*c:0,m=e.y>x?hn(e.y,x)*window.devicePixelRatio*c:0,s.translate(u,m)}s.save(),s.translate(a*c,a*c),s.scale(window.devicePixelRatio*c,window.devicePixelRatio*c);let p=An.canvas(r);Uo(e,p,s,i,t),s.restore();let f=$(e,t),h=document.createElement("canvas"),E=h.getContext("2d");if(H(e)&&f){let[g,x,w,y]=V(e,t),b=Math.max(hn(g,w),hn(x,y));h.width=b*window.devicePixelRatio*c+a*c*10,h.height=b*window.devicePixelRatio*c+a*c*10,E.translate(h.width/2,h.height/2),E.rotate(e.angle),E.drawImage(r,-r.width/2,-r.height/2,r.width,r.height);let[,,,,I,S]=V(f,t);E.rotate(-e.angle);let T=(h.width-r.width)/2,A=(h.height-r.height)/2,F=h.width/2-(I-g)*window.devicePixelRatio*c-T-a*c,B=h.height/2-(S-x)*window.devicePixelRatio*c-A-a*c;E.translate(-F,-B),E.clearRect(-(f.width/2+_o)*window.devicePixelRatio*c,-(f.height/2+_o)*window.devicePixelRatio*c,(f.width+_o*2)*window.devicePixelRatio*c,(f.height+_o*2)*window.devicePixelRatio*c)}return{element:e,canvas:r,theme:o.theme,scale:c,zoomValue:n.value,canvasOffsetX:u,canvasOffsetY:m,boundTextElementVersion:$(e,t)?.version||null,containingFrameOpacity:Ut(e,t)?.opacity||100,boundTextCanvas:h,angle:e.angle,imageCrop:xe(e)?e.crop:null,editingTextElementId:i.editingTextElementId}},s1=14,Id=typeof document<"u"?document.createElement("img"):{src:""};Id.src=`data:${xs.svg},${encodeURIComponent('<svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="image" class="svg-inline--fa fa-image fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="#888" d="M464 448H48c-26.51 0-48-21.49-48-48V112c0-26.51 21.49-48 48-48h416c26.51 0 48 21.49 48 48v288c0 26.51-21.49 48-48 48zM112 120c-30.928 0-56 25.072-56 56s25.072 56 56 56 56-25.072 56-56-25.072-56-56-56zM64 384h384V272l-87.515-87.515c-4.686-4.686-12.284-4.686-16.971 0L208 320l-55.515-55.515c-4.686-4.686-12.284-4.686-16.971 0L64 336v48z"></path></svg>')}`;var Sd=typeof document<"u"?document.createElement("img"):{src:""};Sd.src=`data:${xs.svg},${encodeURIComponent('<svg viewBox="0 0 668 668" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2"><path d="M464 448H48c-26.51 0-48-21.49-48-48V112c0-26.51 21.49-48 48-48h416c26.51 0 48 21.49 48 48v288c0 26.51-21.49 48-48 48ZM112 120c-30.928 0-56 25.072-56 56s25.072 56 56 56 56-25.072 56-56-25.072-56-56-56ZM64 384h384V272l-87.515-87.515c-4.686-4.686-12.284-4.686-16.971 0L208 320l-55.515-55.515c-4.686-4.686-12.284-4.686-16.971 0L64 336v48Z" style="fill:#888;fill-rule:nonzero" transform="matrix(.81709 0 0 .81709 124.825 145.825)"/><path d="M256 8C119.034 8 8 119.033 8 256c0 136.967 111.034 248 248 248s248-111.034 248-248S392.967 8 256 8Zm130.108 117.892c65.448 65.448 70 165.481 20.677 235.637L150.47 105.216c70.204-49.356 170.226-44.735 235.638 20.676ZM125.892 386.108c-65.448-65.448-70-165.481-20.677-235.637L361.53 406.784c-70.203 49.356-170.226 44.736-235.638-20.676Z" style="fill:#888;fill-rule:nonzero" transform="matrix(.30366 0 0 .30366 506.822 60.065)"/></svg>')}`;var Wf=(e,t,n)=>{t.fillStyle=n===kn.DARK?"#2E2E2E":"#E7E7E7",t.fillRect(0,0,e.width,e.height);let i=Math.min(e.width,e.height),o=Math.min(i,Math.min(i*.4,100));t.drawImage(e.status==="error"?Sd:Id,e.width/2-o/2,e.height/2-o/2,o,o)},Uo=(e,t,n,i,o)=>{switch(e.type){case"rectangle":case"iframe":case"embeddable":case"diamond":case"ellipse":{n.lineJoin="round",n.lineCap="round";let r=Ze.generateElementShape(e,i);if(e.type==="rectangle"&&e.customData?.isStickyNote===!0){if(n.save(),n.shadowColor="rgba(0, 0, 0, 0.18)",n.shadowBlur=8,n.shadowOffsetX=0,n.shadowOffsetY=0,t.draw(r),n.restore(),!i.isExporting&&o){let a=$(e,o);if(!(a?.id!=null&&i.editingTextElementId===a.id)&&(!a||!a.originalText.trim())){let c=i.stickyNotePlaceholder||"Add text",u=a?Es(a):Es({fontFamily:Cf,fontSize:Gf});n.save(),n.font=u,n.textAlign="left",n.textBaseline="top",n.globalAlpha=.4,n.fillStyle=i.theme===kn.DARK?Ci(e.strokeColor):e.strokeColor;let m=3;n.fillText(c,bd,bd+m),n.restore()}}break}t.draw(r);break}case"arrow":case"line":{n.lineJoin="round",n.lineCap="round",Ze.generateElementShape(e,i).forEach(r=>{t.draw(r)});break}case"freedraw":{n.save();let r=Ze.generateElementShape(e,i);for(let s of r)typeof s=="string"?(n.fillStyle=i.theme===kn.DARK?Ci(e.strokeColor):e.strokeColor,n.fill(new Path2D(s))):t.draw(s);n.restore();break}case"image":{n.save();let r=e.fileId!==null?i.imageCache.get(e.fileId):null,s=Mn(e)?r?.image:void 0;if(s!=null&&!(s instanceof Promise)){e.roundness&&n.roundRect&&(n.beginPath(),n.roundRect(0,0,e.width,e.height,Ct(Math.min(e.width,e.height),e)),n.clip());let{x:a,y:l,width:d,height:c}=e.crop?e.crop:{x:0,y:0,width:s.naturalWidth,height:s.naturalHeight},u=i.theme===kn.DARK&&r?.mimeType===xs.svg;if(u&&Hf){let m=window.devicePixelRatio||1,p=document.createElement("canvas");p.width=e.width*m,p.height=e.height*m;let f=p.getContext("2d");if(f){f.scale(m,m),f.drawImage(s,a,l,d,c,0,0,e.width,e.height);let h=f.getImageData(0,0,p.width,p.height),E=h.data;for(let g=0;g<E.length;g+=4)E[g]=255-E[g],E[g+1]=255-E[g+1],E[g+2]=255-E[g+2];f.putImageData(h,0,0),n.drawImage(p,0,0,p.width,p.height,0,0,e.width,e.height)}}else u&&(n.filter=Ff),n.drawImage(s,a,l,d,c,0,0,e.width,e.height)}else Wf(e,n,i.theme);n.restore();break}default:if(ee(e)){let r=Rf(e.text),s=r&&!n.canvas.isConnected;s&&document.body.appendChild(n.canvas),n.canvas.setAttribute("dir",r?"rtl":"ltr"),n.save(),n.font=Es(e),n.fillStyle=i.theme===kn.DARK?Ci(e.strokeColor):e.strokeColor,n.textAlign=e.textAlign;let a=e.text.replace(/\r\n?/g,`
`).split(`
`),l=e.textAlign==="center"?e.width/2:e.textAlign==="right"?e.width:0,d=ho(e.fontSize,e.lineHeight),c=Nf(e.fontFamily,e.fontSize,d);for(let u=0;u<a.length;u++)n.fillText(a[u],l,u*d+c);n.restore(),s&&n.canvas.remove()}else throw new Error(`Unimplemented type ${e.type}`)}},Gi=new WeakMap,yd=(e,t,n,i)=>{let o=n?i.zoom:{value:1},r=Gi.get(e),s=r&&r.zoomValue!==o.value&&!i?.shouldCacheIgnoreZoom,a=$(e,t),l=a?.version||null,d=xe(e)?e.crop:null,c=Ut(e,t)?.opacity||100,u=e.type==="rectangle"&&e.customData?.isStickyNote===!0,m=n.editingTextElementId,p=u&&r?.editingTextElementId!==m;if(!r||s||p||r.theme!==i.theme||r.boundTextElementVersion!==l||r.imageCrop!==d||r.containingFrameOpacity!==c||H(e)&&a&&e.angle!==r.angle){let f=Pd(e,t,o,n,i);return f?(Gi.set(e,f),f):null}return r},gs=(e,t,n,i,o)=>{let r=e.element,s=Yo(r),a=e.scale,[l,d,c,u]=V(r,o),m=((l+c)/2+i.scrollX)*window.devicePixelRatio,p=((d+u)/2+i.scrollY)*window.devicePixelRatio;t.save(),t.scale(1/window.devicePixelRatio,1/window.devicePixelRatio);let f=$(r,o);if(H(r)&&f){let h=(e.boundTextCanvas.width-e.canvas.width)/2,E=(e.boundTextCanvas.height-e.canvas.height)/2;t.translate(m,p),t.drawImage(e.boundTextCanvas,-(c-l)/2*window.devicePixelRatio-h/a-s,-(u-d)/2*window.devicePixelRatio-E/a-s,e.boundTextCanvas.width/a,e.boundTextCanvas.height/a)}else if(t.translate(m,p),t.rotate(r.angle),"scale"in e.element&&!_f(r,n)&&t.scale(e.element.scale[0],e.element.scale[1]),t.translate(-m,-p),t.drawImage(e.canvas,(l+i.scrollX)*window.devicePixelRatio-s*e.scale/e.scale,(d+i.scrollY)*window.devicePixelRatio-s*e.scale/e.scale,e.canvas.width/e.scale,e.canvas.height/e.scale),v.VITE_APP_DEBUG_ENABLE_TEXT_CONTAINER_BOUNDING_BOX==="true"&&ht(r)){let h=$(r,o),E=Nr(r);t.strokeStyle="#c92a2a",t.lineWidth=3,t.strokeRect((E.x+i.scrollX)*window.devicePixelRatio,(E.y+i.scrollY)*window.devicePixelRatio,at(r,h)*window.devicePixelRatio,yi(r,h)*window.devicePixelRatio)}t.restore()},a1=(e,t,n,i)=>{t.save(),t.translate(e.x+n.scrollX,e.y+n.scrollY),t.fillStyle="rgba(0, 0, 200, 0.04)";let o=.5/n.zoom.value;t.fillRect(o,o,e.width,e.height),t.lineWidth=1/n.zoom.value,t.strokeStyle=i,t.strokeRect(o,o,e.width,e.height),t.restore()},l1=(e,t,n)=>{if(e.backgroundColor==="transparent"||!n.frameRendering?.enabled)return;t.save(),t.translate(e.x+n.scrollX,e.y+n.scrollY);let i=n.zoom.value;t.shadowColor=ct.shadowColor,t.shadowBlur=ct.shadowBlur/i,t.shadowOffsetX=ct.shadowOffsetX/i,t.shadowOffsetY=ct.shadowOffsetY/i,t.fillStyle=e.backgroundColor,ct.radius&&t.roundRect?(t.beginPath(),t.roundRect(0,0,e.width,e.height,ct.radius/i),t.fill(),t.closePath()):t.fillRect(0,0,e.width,e.height),t.restore()},d1=(e,t,n,i,o,r,s)=>{let a=s.openDialog?.name==="elementLinkSelector"&&!s.selectedElementIds[e.id]&&!s.hoveredElementIds[e.id];switch(o.globalAlpha=Uf(e,Ut(e,t),r.elementsPendingErasure,r.pendingFlowchartNodes,a?Of:1),e.type){case"magicframe":case"frame":{s.frameRendering.enabled&&s.frameRendering.outline&&(o.save(),o.translate(e.x+s.scrollX,e.y+s.scrollY),o.lineWidth=ct.strokeWidth/s.zoom.value,o.strokeStyle=s.theme===kn.DARK?Ci(ct.strokeColor):ct.strokeColor,Na(e)&&(o.strokeStyle=s.theme===kn.LIGHT?"#7affd7":Ci("#1d8264")),ct.radius&&o.roundRect?(o.beginPath(),o.roundRect(0,0,e.width,e.height,ct.radius/s.zoom.value),o.stroke(),o.closePath()):o.strokeRect(0,0,e.width,e.height),o.restore());break}case"freedraw":{if(r.isExporting){let[l,d,c,u]=V(e,t),m=(l+c)/2+s.scrollX,p=(d+u)/2+s.scrollY,f=(c-l)/2-(e.x-l),h=(u-d)/2-(e.y-d);o.save(),o.translate(m,p),o.rotate(e.angle),o.translate(-f,-h),Uo(e,i,o,r,n),o.restore()}else{let l=yd(e,n,r,s);if(!l)return;gs(l,o,r,s,n)}break}case"rectangle":case"diamond":case"ellipse":case"line":case"arrow":case"image":case"text":case"iframe":case"embeddable":{if(r.isExporting){let[l,d,c,u]=V(e,t),m=(l+c)/2+s.scrollX,p=(d+u)/2+s.scrollY,f=(c-l)/2-(e.x-l),h=(u-d)/2-(e.y-d);if(ee(e)){let g=Ae(e,t);if(H(g)){let x=O.getBoundTextElementPosition(g,e,t);f=(c-l)/2-(x.x-l),h=(u-d)/2-(x.y-d)}}o.save(),o.translate(m,p);let E=$(e,t);if(H(e)&&E){let g=document.createElement("canvas"),x=g.getContext("2d"),w=Math.max(hn(l,c),hn(d,u)),y=Yo(e);g.width=w*s.exportScale+y*10*s.exportScale,g.height=w*s.exportScale+y*10*s.exportScale,x.translate(g.width/2,g.height/2),x.scale(s.exportScale,s.exportScale),f=e.width/2-(e.x-l),h=e.height/2-(e.y-d),x.rotate(e.angle);let b=An.canvas(g);x.translate(-f,-h),Uo(e,b,x,r,t),x.translate(f,h),x.rotate(-e.angle);let[,,,,I,S]=V(E,t),T=(l+c)/2-I,A=(d+u)/2-S;x.translate(-T,-A),x.clearRect(-E.width/2,-E.height/2,E.width,E.height),o.scale(1/s.exportScale,1/s.exportScale),o.drawImage(g,-g.width/2,-g.height/2,g.width,g.height)}else o.rotate(e.angle),e.type==="image"&&o.scale(e.scale[0],e.scale[1]),o.translate(-f,-h),Uo(e,i,o,r,n);o.restore()}else{let l=yd(e,n,r,s);if(!l)return;let d=o.imageSmoothingEnabled;if(!s?.shouldCacheIgnoreZoom&&(!e.angle||Lf(e.angle))&&(o.imageSmoothingEnabled=!1),e.id===s.croppingElementId&&xe(l.element)&&l.element.crop!==null){o.save(),o.globalAlpha=.1;let c=Pd(ka(l.element,t),n,s.zoom,r,s);c&&gs(c,o,r,s,n),o.restore()}gs(l,o,r,s,n),o.imageSmoothingEnabled=d}break}default:throw new Error(`Unimplemented type ${e.type}`)}o.globalAlpha=1};function c1(e,t,n){let i=le({...e,angle:0},n),o=Ho((i[0]+i[2])/2,(i[1]+i[3])/2);return zf(t.length>=2,"Freepath outline must have at least 2 points"),t.slice(2).reduce((r,s)=>(r.push(wd(r[r.length-1][1],hs(Ho(s[0]+e.x,s[1]+e.y),o,e.angle))),r),[wd(hs(Ho(t[0][0]+e.x,t[0][1]+e.y),o,e.angle),hs(Ho(t[1][0]+e.x,t[1][1]+e.y),o,e.angle))])}P();var p1=e=>e==="rectangle"||e==="iframe"||e==="embeddable"||e==="ellipse"||e==="diamond"||e==="line"||e==="freedraw",f1=e=>e==="rectangle"||e==="ellipse"||e==="diamond"||e==="freedraw"||e==="arrow"||e==="line"||e==="text"||e==="embeddable",h1=e=>e==="rectangle"||e==="iframe"||e==="embeddable"||e==="ellipse"||e==="diamond"||e==="freedraw"||e==="arrow"||e==="line",E1=e=>e==="rectangle"||e==="iframe"||e==="embeddable"||e==="ellipse"||e==="diamond"||e==="arrow"||e==="line",Ad=e=>e==="rectangle"||e==="iframe"||e==="embeddable"||e==="line"||e==="diamond"||e==="image",g1=e=>e==="arrow",x1=e=>e==="arrow";var Ze=class e{static rg=new Ke;static cache=new WeakMap;static get=(t,n)=>{let i=e.cache.get(t);if(i&&(n===null||i.theme===n))return i.shape};static delete=t=>{e.cache.delete(t),Gi.delete(t)};static destroy=()=>{e.cache=new WeakMap};static generateElementShape=(t,n)=>{let i=n?.isExporting?void 0:e.get(t,n?n.theme:null);if(i!==void 0)return i;Gi.delete(t);let o=Kf(t,e.rg,n||{isExporting:!1,canvasBackgroundColor:Vf.white,embedsValidationStatus:null,theme:ws.LIGHT});return n?.isExporting||e.cache.set(t,{shape:o,theme:n?.theme||ws.LIGHT}),o}},Zf=e=>[8,8+e],Bd=e=>[1.5,6+e];function qf(e){let t=e.roughness,n=Math.max(e.width,e.height),i=Math.min(e.width,e.height);return i>=20&&n>=50||i>=15&&e.roundness&&Ad(e.type)||K(e)&&n>=50?t:Math.min(t/(n<10?3:2),2.5)}var ze=(e,t=!1,n=!1)=>{let i={seed:e.seed,strokeLineDash:e.strokeStyle==="dashed"?Zf(e.strokeWidth):e.strokeStyle==="dotted"?Bd(e.strokeWidth):void 0,disableMultiStroke:e.strokeStyle!=="solid",strokeWidth:e.strokeStyle!=="solid"?e.strokeWidth+.5:e.strokeWidth,fillWeight:e.strokeWidth/2,hachureGap:e.strokeWidth*4,roughness:qf(e),stroke:n?Wo(e.strokeColor):e.strokeColor,preserveVertices:t||e.roughness<jf.cartoonist};switch(e.type){case"rectangle":case"iframe":case"embeddable":case"diamond":case"ellipse":return i.fillStyle=e.fillStyle,i.fill=Oi(e.backgroundColor)?void 0:n?Wo(e.backgroundColor):e.backgroundColor,e.type==="rectangle"&&e.customData?.isStickyNote===!0&&(i.stroke="none"),e.type==="ellipse"&&(i.curveFitting=1),i;case"line":case"freedraw":return vn(e.points)&&(i.fillStyle=e.fillStyle,i.fill=e.backgroundColor==="transparent"?void 0:n?Wo(e.backgroundColor):e.backgroundColor),i;case"arrow":return i;default:throw new Error(`Unimplemented type ${e.type}`)}},Td=(e,t,n)=>lo(e)&&(t||Ra(e)&&n?.get(e.id)!==!0)&&Oi(e.backgroundColor)&&Oi(e.strokeColor)?{...e,roughness:0,backgroundColor:"#d3d3d3",fillStyle:"solid"}:ao(e)?{...e,strokeColor:Oi(e.strokeColor)?"#000000":e.strokeColor,backgroundColor:Oi(e.backgroundColor)?"#f4f4f6":e.backgroundColor}:e,vd=(e,t,n,i,o,r,s,a)=>{let l=bs(e,t,n,i);if(l===null)return[];let d=(u,m)=>{if(u===null)return[];let[,,p,f,h,E]=u;return[o.line(p,f,h,E,m)]},c=a?Wo(e.strokeColor):e.strokeColor;switch(i){case"dot":case"circle":case"circle_outline":{let[u,m,p]=l;return delete r.strokeLineDash,[o.circle(u,m,p,{...r,fill:i==="circle_outline"?s:c,fillStyle:"solid",stroke:c,roughness:Math.min(.5,r.roughness||0)})]}case"triangle":case"triangle_outline":{let[u,m,p,f,h,E]=l;return delete r.strokeLineDash,[o.polygon([[u,m],[p,f],[h,E],[u,m]],{...r,fill:i==="triangle_outline"?s:c,fillStyle:"solid",roughness:Math.min(1,r.roughness||0)})]}case"diamond":case"diamond_outline":{let[u,m,p,f,h,E,g,x]=l;return delete r.strokeLineDash,[o.polygon([[u,m],[p,f],[h,E],[g,x],[u,m]],{...r,fill:i==="diamond_outline"?s:c,fillStyle:"solid",roughness:Math.min(1,r.roughness||0)})]}case"crowfoot_one":return d(l,r);case"bar":case"arrow":case"crowfoot_many":case"crowfoot_one_or_many":default:{let[u,m,p,f,h,E]=l;if(e.strokeStyle==="dotted"){let g=Bd(e.strokeWidth-1);r.strokeLineDash=[g[0],g[1]-1]}else delete r.strokeLineDash;return r.roughness=Math.min(1,r.roughness||0),[o.line(p,f,u,m,r),o.line(h,E,u,m,r),...i==="crowfoot_one_or_many"?d(bs(e,t,n,"crowfoot_one"),r):[]]}}},Za=e=>{let t=new Ke,n={seed:e.seed,disableMultiStroke:!0,disableMultiStrokeFill:!0,roughness:0,preserveVertices:!0},i=gt(e.points.reduce((o,r)=>[Math.min(e.x+r[0],o[0]),Math.min(e.y+r[1],o[1]),Math.max(e.x+r[0],o[2]),Math.max(e.y+r[1],o[3])],[1/0,1/0,-1/0,-1/0]));switch(e.type){case"line":case"arrow":{let o=e.points.length?e.points:[de(0,0)];return _(e)?t.path(Ld(o,16),n).sets[0].ops:e.roundness?t.curve(o,n).sets[0].ops.slice(0,e.points.length).map((r,s)=>{if(s===0){let a=Yt(de(e.x+r.data[0],e.y+r.data[1]),i,e.angle);return{op:"move",data:de(a[0]-e.x,a[1]-e.y)}}return{op:"bcurveTo",data:[Yt(de(e.x+r.data[0],e.y+r.data[1]),i,e.angle),Yt(de(e.x+r.data[2],e.y+r.data[3]),i,e.angle),Yt(de(e.x+r.data[4],e.y+r.data[5]),i,e.angle)].map(a=>de(a[0]-e.x,a[1]-e.y)).flat()}}):o.map((r,s)=>{let a=Yt(de(e.x+r[0],e.y+r[1]),i,e.angle);return{op:s===0?"move":"lineTo",data:de(a[0]-e.x,a[1]-e.y)}})}case"freedraw":{if(e.points.length<2)return[];let o=ci(e.points,.75);return t.curve(o,n).sets[0].ops.slice(0,e.points.length).map((r,s)=>{if(s===0){let a=Yt(de(e.x+r.data[0],e.y+r.data[1]),i,e.angle);return{op:"move",data:de(a[0]-e.x,a[1]-e.y)}}return{op:"bcurveTo",data:[Yt(de(e.x+r.data[0],e.y+r.data[1]),i,e.angle),Yt(de(e.x+r.data[2],e.y+r.data[3]),i,e.angle),Yt(de(e.x+r.data[4],e.y+r.data[5]),i,e.angle)].map(a=>de(a[0]-e.x,a[1]-e.y)).flat()}})}}},Kf=(e,t,{isExporting:n,canvasBackgroundColor:i,embedsValidationStatus:o,theme:r})=>{let s=r===ws.DARK;switch(e.type){case"rectangle":case"iframe":case"embeddable":{let a;if(e.roundness){let l=e.width,d=e.height,c=Ct(Math.min(l,d),e);a=t.path(`M ${c} 0 L ${l-c} 0 Q ${l} 0, ${l} ${c} L ${l} ${d-c} Q ${l} ${d}, ${l-c} ${d} L ${c} ${d} Q 0 ${d}, 0 ${d-c} L 0 ${c} Q 0 0, ${c} 0`,ze(Td(e,n,o),!0,s))}else a=t.rectangle(0,0,e.width,e.height,ze(Td(e,n,o),!1,s));return a}case"diamond":{let a,[l,d,c,u,m,p,f,h]=_n(e);if(e.roundness){let E=Ct(Math.abs(l-f),e),g=Ct(Math.abs(u-d),e);a=t.path(`M ${l+E} ${d+g} L ${c-E} ${u-g}
            C ${c} ${u}, ${c} ${u}, ${c-E} ${u+g}
            L ${m+E} ${p-g}
            C ${m} ${p}, ${m} ${p}, ${m-E} ${p-g}
            L ${f+E} ${h+g}
            C ${f} ${h}, ${f} ${h}, ${f+E} ${h-g}
            L ${l-E} ${d+g}
            C ${l} ${d}, ${l} ${d}, ${l+E} ${d+g}`,ze(e,!0,s))}else a=t.polygon([[l,d],[c,u],[m,p],[f,h]],ze(e,!1,s));return a}case"ellipse":return t.ellipse(e.width/2,e.height/2,e.width,e.height,ze(e,!1,s));case"line":case"arrow":{let a,l=ze(e,!1,s),d=e.points.length?e.points:[de(0,0)];if(_(e)?d.every(c=>Math.abs(c[0])<=1e6&&Math.abs(c[1])<=1e6)?a=[t.path(Ld(d,16),ze(e,!0,s))]:(console.error("Elbow arrow with extreme point positions detected. Arrow not rendered.",e.id,JSON.stringify(d)),a=[]):e.roundness?a=[t.curve(d,l)]:l.fill?a=[t.polygon(d,l)]:a=[t.linearPath(d,l)],e.type==="arrow"){let{startArrowhead:c=null,endArrowhead:u="arrow"}=e;if(c!==null){let m=vd(e,a,"start",c,t,l,i,s);a.push(...m)}if(u!==null){let m=vd(e,a,"end",u,t,l,i,s);a.push(...m)}}return a}case"freedraw":{let a=[];if(vn(e.points)){let l=ci(e.points,.75);a.push(t.curve(l,{...ze(e,!1,s),stroke:"none"}))}return a.push(Qf(e)),a}case"frame":case"magicframe":case"text":case"image":return null;default:return Xf(e,`generateElementShape(): Unimplemented type ${e?.type}`),null}},Ld=(e,t)=>{let n=[];for(let o=1;o<e.length-1;o+=1){let r=e[o-1],s=e[o+1],a=e[o],l=lt(a,r),d=lt(s,a),c=Math.min(t,Md(e[o],s)/2,Md(e[o],r)/2);l?r[0]<a[0]?n.push([e[o][0]-c,e[o][1]]):n.push([e[o][0]+c,e[o][1]]):r[1]<a[1]?n.push([e[o][0],e[o][1]-c]):n.push([e[o][0],e[o][1]+c]),n.push(e[o]),d?s[0]<a[0]?n.push([e[o][0]-c,e[o][1]]):n.push([e[o][0]+c,e[o][1]]):s[1]<a[1]?n.push([e[o][0],e[o][1]-c]):n.push([e[o][0],e[o][1]+c])}let i=[`M ${e[0][0]} ${e[0][1]}`];for(let o=0;o<n.length;o+=3)i.push(`L ${n[o][0]} ${n[o][1]}`),i.push(`Q ${n[o+1][0]} ${n[o+1][1]}, ${n[o+2][0]} ${n[o+2][1]}`);return i.push(`L ${e[e.length-1][0]} ${e[e.length-1][1]}`),i.join(" ")},Cd=(e,t)=>{switch(e.type){case"rectangle":case"diamond":case"frame":case"magicframe":case"embeddable":case"image":case"iframe":case"text":case"selection":return wa(e);case"arrow":case"line":{let n=Ze.generateElementShape(e,null)[0],[,,,,i,o]=V(e,t);return bo(e)?Ia(e,n,de(e.x,e.y),e.angle,de(i,o)):ya(n,de(e.x,e.y),e.angle,de(i,o))}case"ellipse":return ba(e);case"freedraw":{let[,,,,n,i]=V(e,t);return Pa(e,de(n,i),bo(e))}}},ql=(e,t)=>{let n=[...e.points];if(t){if(!Ua(e.points))return null;let o=n[0],r=n[n.length-1];Math.hypot(o[0]-r[0],o[1]-r[1])>$f||n.length<4?n.push(de(o[0],o[1])):n[n.length-1]=de(o[0],o[1])}return{polygon:t,points:n}},Qf=e=>th(Jf(e)),Jf=e=>{let t=e.simulatePressure?e.points:e.points.length?e.points.map(([n,i],o)=>[n,i,e.pressures[o]]):[[0,0,.5]];return Ba(t,{simulatePressure:e.simulatePressure,size:e.strokeWidth*4.25,thinning:.6,smoothing:.5,streamline:.5,easing:n=>Math.sin(n*Math.PI/2),last:!0})},Dd=(e,t)=>[(e[0]+t[0])/2,(e[1]+t[1])/2],eh=/(\s?[A-Z]?,?-?[0-9]*\.[0-9]{0,2})(([0-9]|e|-)*)/g,th=e=>{if(!e.length)return"";let t=e.length-1;return e.reduce((n,i,o,r)=>(o===t?n.push(i,Dd(i,r[0]),"L",r[0],"Z"):n.push(i,Dd(i,r[o+1])),n),["M",e[0],"Q"]).join(" ").replace(eh,"$1")};var Is=class e{static boundsCache=new WeakMap;static nonRotatedBoundsCache=new WeakMap;static getBounds(t,n,i=!1){let o=i&&t.angle!==0?e.nonRotatedBoundsCache.get(t):e.boundsCache.get(t);if(o?.version&&o.version===t.version&&!ue(t))return o.bounds;if(i&&t.angle!==0){let s=e.calculateBounds({...t,angle:0},n);return e.nonRotatedBoundsCache.set(t,{version:t.version,bounds:s}),s}let r=e.calculateBounds(t,n);return e.boundsCache.set(t,{version:t.version,bounds:r}),r}static calculateBounds(t,n){let i,[o,r,s,a,l,d]=V(t,n);if(Ie(t)){let[c,u,m,p]=Ss(t.points.map(([f,h])=>oe(D(f,h),D(l-t.x,d-t.y),t.angle)));return[c+t.x,u+t.y,m+t.x,p+t.y]}else if(K(t))i=ch(t,l,d,n);else if(t.type==="diamond"){let[c,u]=oe(D(l,r),D(l,d),t.angle),[m,p]=oe(D(l,a),D(l,d),t.angle),[f,h]=oe(D(o,d),D(l,d),t.angle),[E,g]=oe(D(s,d),D(l,d),t.angle),x=Math.min(c,m,f,E),w=Math.min(u,p,h,g),y=Math.max(c,m,f,E),b=Math.max(u,p,h,g);i=[x,w,y,b]}else if(t.type==="ellipse"){let c=(s-o)/2,u=(a-r)/2,m=Math.cos(t.angle),p=Math.sin(t.angle),f=Math.hypot(c*m,u*p),h=Math.hypot(u*m,c*p);i=[l-f,d-h,l+f,d+h]}else{let[c,u]=oe(D(o,r),D(l,d),t.angle),[m,p]=oe(D(o,a),D(l,d),t.angle),[f,h]=oe(D(s,a),D(l,d),t.angle),[E,g]=oe(D(s,r),D(l,d),t.angle),x=Math.min(c,m,f,E),w=Math.min(u,p,h,g),y=Math.max(c,m,f,E),b=Math.max(u,p,h,g);i=[x,w,y,b]}return i}},V=(e,t,n=!1)=>{if(Ie(e))return sh(e);if(K(e))return O.getElementAbsoluteCoords(e,t,n);if(ee(e)){let i=t?Ae(e,t):null;if(H(i)){let{x:o,y:r}=O.getBoundTextElementPosition(i,e,t);return[o,r,o+e.width,r+e.height,o+e.width/2,r+e.height/2]}}return[e.x,e.y,e.x+e.width,e.y+e.height,e.x+e.width/2,e.y+e.height/2]},ps=(e,t)=>{let n=Cd(e,t),[i,o,r,s,a,l]=V(e,t),d=D(a,l);if(n.type==="polycurve"){let g=n.data.map(w=>Tt(w,10)),x=[];if(Bt(e)&&!e.polygon||H(e))for(let w of g){let y=0;for(;y<w.length-1;)x.push(ge(D(w[y][0],w[y][1]),D(w[y+1][0],w[y+1][1]))),y++}else{let w=g.flat(),y=0;for(;y<w.length-1;)x.push(ge(D(w[y][0],w[y][1]),D(w[y+1][0],w[y+1][1]))),y++}return x}else{if(n.type==="polyline")return n.data;if(oh(e)){let[E,g]=Jt(e),x=g.map(y=>kd(y,d,e.angle)).flat();return[...Od(E,d,e.angle),...x]}else if(e.type==="diamond"){let[E,g]=en(e),x=g.map(y=>kd(y,d,e.angle)).flat();return[...Od(E,d,e.angle),...x]}else if(n.type==="polygon"){if(ee(e)){let x=Ae(e,t);if(x&&K(x))return[ge(D(i,o),D(r,o)),ge(D(r,o),D(r,s)),ge(D(r,s),D(i,s)),ge(D(i,s),D(i,o))]}let E=n.data,g=[];for(let x=0;x<E.length-1;x++)g.push(ge(E[x],E[x+1]));return g}else if(n.type==="ellipse")return rh(e)}let[c,u,m,p,,,f,h]=[[i,o],[r,o],[i,s],[r,s],[a,o],[a,s],[i,l],[r,l]].map(E=>oe(E,d,e.angle));return[ge(c,u),ge(m,p),ge(c,m),ge(u,p),ge(c,h),ge(m,h),ge(u,f),ge(p,f)]},oh=e=>e!=null&&(e.type==="rectangle"||e.type==="image"||e.type==="iframe"||e.type==="embeddable"||e.type==="frame"||e.type==="magicframe"||e.type==="text"&&!e.containerId),Od=(e,t,n)=>e.map(i=>ge(oe(i[0],t,n),oe(i[1],t,n))),kd=(e,t,n)=>{let i=Tt(e,10),o=0,r=[];for(;o<i.length-1;)r.push(ge(oe(D(i[o][0],i[o][1]),t,n),oe(D(i[o+1][0],i[o+1][1]),t,n))),o++;return r},rh=e=>{let t=D(e.x+e.width/2,e.y+e.height/2),n=e.width/2,i=e.height/2,o=[],r=[],s=90,a=Math.PI*2/s;for(let l=0;l<s;l++){let d=l*a,c=t[0]+n*Math.cos(d),u=t[1]+i*Math.sin(d);r.push(oe(D(c,u),t,e.angle))}for(let l=0;l<r.length-1;l++)o.push(ge(r[l],r[l+1]));return o.push(ge(r[r.length-1],r[0])),o},$1=e=>[e.x,e.y,e.x+e.width,e.y+e.height,e.x+e.width/2,e.y+e.height/2],_n=e=>{let t=Math.floor(e.width/2)+1,n=0,i=e.width,o=Math.floor(e.height/2)+1,r=t,s=e.height;return[t,n,i,o,r,s,0,o]},Fd=(e,t,n,i,o)=>{let r=1-e;return Math.pow(r,3)*t+3*Math.pow(r,2)*e*n+3*r*Math.pow(e,2)*i+Math.pow(e,3)*o},Rd=(e,t,n,i)=>{let o=t-e,r=n-t,s=i-n,a=3*o-6*r+3*s,l=6*r-6*o,d=3*o,c=l*l-4*a*d;if(!(c>=0))return!1;let m=null,p=null,f=1/0,h=1/0;return a===0?f=h=-d/l:(f=(-l+Math.sqrt(c))/(2*a),h=(-l-Math.sqrt(c))/(2*a)),f>=0&&f<=1&&(m=Fd(f,e,t,n,i)),h>=0&&h<=1&&(p=Fd(h,e,t,n,i)),[m,p]},Po=(e,t,n,i)=>{let o=Rd(e[0],t[0],n[0],i[0]),r=Rd(e[1],t[1],n[1],i[1]),s=Math.min(e[0],i[0]),a=Math.max(e[0],i[0]);if(o){let c=o.filter(u=>u!==null);s=Math.min(s,...c),a=Math.max(a,...c)}let l=Math.min(e[1],i[1]),d=Math.max(e[1],i[1]);if(r){let c=r.filter(u=>u!==null);l=Math.min(l,...c),d=Math.max(d,...c)}return[s,l,a,d]},Li=(e,t)=>{let n=D(0,0),{minX:i,minY:o,maxX:r,maxY:s}=e.reduce((a,{op:l,data:d})=>{if(l==="move"){let c=zd(d);Ps(c!=null,"Op data is not a point"),n=c}else if(l==="bcurveTo"){let c=D(d[0],d[1]),u=D(d[2],d[3]),m=D(d[4],d[5]),p=t?t(c):c,f=t?t(u):u,h=t?t(m):m,E=t?t(n):n;n=m;let[g,x,w,y]=Po(E,p,f,h);a.minX=Math.min(a.minX,g),a.minY=Math.min(a.minY,x),a.maxX=Math.max(a.maxX,w),a.maxY=Math.max(a.maxY,y)}return a},{minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0});return[i,o,r,s]},Ss=e=>{let t=1/0,n=1/0,i=-1/0,o=-1/0;for(let[r,s]of e)t=Math.min(t,r),n=Math.min(n,s),i=Math.max(i,r),o=Math.max(o,s);return[t,n,i,o]},sh=e=>{let[t,n,i,o]=Ss(e.points),r=t+e.x,s=n+e.y,a=i+e.x,l=o+e.y;return[r,s,a,l,(r+a)/2,(s+l)/2]},ah=e=>{switch(e){case"arrow":return 25;case"diamond":case"diamond_outline":return 12;case"crowfoot_many":case"crowfoot_one":case"crowfoot_one_or_many":return 20;default:return 15}},lh=e=>{switch(e){case"bar":return 90;case"arrow":return 20;default:return 25}},bs=(e,t,n,i)=>{if(t.length<1)return null;let o=vt(t[0]);if(o.length<1)return null;let r=n==="start"?1:o.length-1,s=o[r].data;Ps(s.length===6,"Op data length is not 6");let a=D(s[4],s[5]),l=D(s[2],s[3]),d=D(s[0],s[1]),c=o[r-1],u=D(0,0);if(c.op==="move"){let N=zd(c.data);Ps(N!=null,"Op data is not a point"),u=N}else c.op==="bcurveTo"&&(u=D(c.data[4],c.data[5]));let m=(N,Z)=>Math.pow(1-N,3)*a[Z]+3*N*Math.pow(1-N,2)*l[Z]+3*Math.pow(N,2)*(1-N)*d[Z]+u[Z]*Math.pow(N,3),[p,f]=n==="start"?u:a,[h,E]=[m(.3,0),m(.3,1)],g=Math.hypot(p-h,f-E),x=(p-h)/g,w=(f-E)/g,y=ah(i),b=0;{let[N,Z]=n==="end"?e.points[e.points.length-1]:e.points[0],[L,M]=e.points.length>1?n==="end"?e.points[e.points.length-2]:e.points[1]:[0,0];b=Math.hypot(N-L,Z-M)}let S=Math.min(y,b*(i==="diamond"||i==="diamond_outline"?.25:.5)),T=p-x*S,A=f-w*S;if(i==="dot"||i==="circle"||i==="circle_outline"){let N=Math.hypot(A-f,T-p)+e.strokeWidth-2;return[p,f,N]}let F=lh(i);if(i==="crowfoot_many"||i==="crowfoot_one_or_many"){let[N,Z]=oe(D(p,f),D(T,A),ys(-F)),[L,M]=oe(D(p,f),D(T,A),ys(F));return[T,A,N,Z,L,M]}let[B,k]=oe(D(T,A),D(p,f),-F*Math.PI/180),[C,X]=oe(D(T,A),D(p,f),ys(F));if(i==="diamond"||i==="diamond_outline"){let N,Z;if(n==="start"){let[L,M]=e.points.length>1?e.points[1]:[0,0];[N,Z]=oe(D(p+S*2,f),D(p,f),Math.atan2(M-f,L-p))}else{let[L,M]=e.points.length>1?e.points[e.points.length-2]:[0,0];[N,Z]=oe(D(p-S*2,f),D(p,f),Math.atan2(f-M,p-L))}return[p,f,B,k,N,Z,C,X]}return[p,f,B,k,C,X]},dh=e=>{let t=An.generator(),n=ze(e),i=e.roundness?"curve":n.fill?"polygon":"linearPath";return t[i](e.points,n)},ch=(e,t,n,i)=>{let o=$(e,i);if(e.points.length<2){let[u,m]=e.points[0],[p,f]=oe(D(e.x+u,e.y+m),D(t,n),e.angle),h=[p,f,p,f];if(o){let E=O.getMinMaxXYWithBoundText(e,i,[p,f,p,f],o);h=[E[0],E[1],E[2],E[3]]}return h}let s=Ze.get(e,null)?.[0]??dh(e),a=vt(s),d=Li(a,([u,m])=>oe(D(e.x+u,e.y+m),D(t,n),e.angle)),c=[d[0],d[1],d[2],d[3]];if(o){let u=O.getMinMaxXYWithBoundText(e,i,c,o);c=[u[0],u[1],u[2],u[3]]}return c},le=(e,t,n=!1)=>Is.getBounds(e,t,n),Ge=(e,t)=>{if(!nh(e))return[0,0,0,0];let n=1/0,i=-1/0,o=1/0,r=-1/0,s=t||Nd(e);return e.forEach(a=>{let[l,d,c,u]=le(a,s);n=Math.min(n,l),o=Math.min(o,d),i=Math.max(i,c),r=Math.max(r,u)}),[n,o,i,r]},Z1=(e,t)=>{let[n,i,o,r]=Ge(e);return[n+t.x,i+t.y,o+t.x,r+t.y]},Qt=(e,t,n,i)=>{if(!(K(e)||Ie(e)))return[e.x,e.y,e.x+t,e.y+n];let o=Gd(0,t,Gd(1,n,e.points,i),i),r;if(Ie(e))r=Ss(o);else{let c=An.generator(),u=e.roundness?c.curve(o,ze(e)):c.linearPath(o,ze(e)),m=vt(u);r=Li(m)}let[s,a,l,d]=r;return[s+e.x,a+e.y,l+e.x,d+e.y]},as=(e,t)=>{let n=An.generator(),i=e.roundness==null?n.linearPath(t,ze(e)):n.curve(t,ze(e)),o=vt(i),[r,s,a,l]=Li(o);return[r+e.x,s+e.y,a+e.x,l+e.y]},q1=(e,t)=>{if(!e.length)return[0,0,0,0];let n=1/0,i=e[0],o=Nd(e);return e.forEach(r=>{let[s,a,l,d]=le(r,o),c=ih(D((s+l)/2,(a+d)/2),D(t.x,t.y));c<n&&(n=c,i=r)}),le(i,o)},Wt=e=>{let[t,n,i,o]=Ge(e);return{minX:t,minY:n,maxX:i,maxY:o,width:i-t,height:o-n,midX:(t+i)/2,midY:(n+o)/2}},K1=({scrollX:e,scrollY:t,width:n,height:i,zoom:o})=>[-e,-t,-e+n/o.value,-t+i/o.value],gt=e=>D(e[0]+(e[2]-e[0])/2,e[1]+(e[3]-e[1])/2),et=(e,t,n)=>{let i={minX:e.x,minY:e.y,maxX:e.x+e.width,maxY:e.y+e.height,midX:e.x+e.width/2,midY:e.y+e.height/2},o=se(e,t),[r,s]=oe(D(i.minX,i.minY),o,e.angle),[a,l]=oe(D(i.maxX,i.minY),o,e.angle),[d,c]=oe(D(i.maxX,i.maxY),o,e.angle),[u,m]=oe(D(i.minX,i.maxY),o,e.angle),p=[Math.min(r,a,d,u),Math.min(s,l,c,m),Math.max(r,a,d,u),Math.max(s,l,c,m)];if(n){let[f,h,E,g]=n;return[p[0]-g,p[1]-f,p[2]+h,p[3]+E]}return p},sn=(e,t)=>e[0]>t[0]&&e[0]<t[2]&&e[1]>t[1]&&e[1]<t[3],Ln=(e,t)=>{if(e==null||t==null)return!1;let[n,i,o,r]=e,[s,a,l,d]=t;return n<l&&o>s&&i<d&&r>a},se=(e,t,n=0,i=0)=>{if(K(e)){let[s,a,l,d]=V(e,t),[c,u]=D((s+l)/2,(a+d)/2);return D(c+n,u+i)}let[o,r]=gt(le(e,t));return D(o+n,r+i)};var fh=.1,_d=e=>K(e)||Ie(e)?e.points.length<2||e.points.length===2&&H(e)&&ph(e.points[0],e.points[e.points.length-1],fh):e.width===0&&e.height===0,fd=(e,t,n,i,o)=>{let[r,s,a,l]=le(e,o),d=jo({clientX:i.offsetLeft,clientY:i.offsetTop},i),c=jo({clientX:i.offsetLeft+t,clientY:i.offsetTop+n},i);return d.x<=a&&d.y<=l&&c.x>=r&&c.y>=s},rP=(e,t,n,i,o,r)=>{let[s,a,l,d]=Ge(e,o),c=jo({clientX:i.offsetLeft+(r?.left||0),clientY:i.offsetTop+(r?.top||0)},i),u=jo({clientX:i.offsetLeft+t-(r?.right||0),clientY:i.offsetTop+n-(r?.bottom||0)},i);return s>=c.x&&a>=c.y&&l<=u.x&&d<=u.y},As=(e,t,n)=>{let i=Math.abs(t),o=Math.abs(n);if(e==="line"||e==="arrow"||e==="freedraw"){let r=Math.round(Math.atan(o/i)/jt)*jt;r===0?n=0:r===Math.PI/2?t=0:n=i*Math.tan(r)*Math.sign(n)||n}else e!=="selection"&&(n=i*Math.sign(n));return{width:t,height:n}},Kl=(e,t,n,i,o)=>{let r=n-e,s=i-t,a=Math.atan2(s,r),l=Math.round(a/jt)*jt;if(o){let d=Math.floor(o/jt)*jt;uh(a,d,d+jt)&&(mh(a,o)<jt/6?l=o:Hd(a)>Hd(o)?l=d+jt:l=d)}if(l===0)s=0;else if(l===Math.PI/2)r=0;else{let d=Math.tan(l),c=-1,u=t-d*e,m=-1/d,p=-1,f=i-m*n,h=(c*f-p*u)/(d*p-m*c),E=(u*m-f*d)/(d*p-m*c);r=h-e,s=E-t}return{width:r,height:s}},sP=e=>{let t={width:e.width,height:e.height,x:e.x,y:e.y};if(e.width<0){let n=Math.abs(e.width);t.width=n,t.x=e.x-n}if(e.height<0){let n=Math.abs(e.height);t.height=n,t.y=e.y-n}return t};P();var mP=(e,t,n,i)=>{let o=No(e,n.getNonDeletedElementsMap(),i),r=Wt(e);return o.flatMap(s=>{let a=hh(s,r,t);return s.map(l=>{let d=n.mutateElement(l,{x:l.x+a.x,y:l.y+a.y});return ve(l,n,{simultaneouslyUpdated:s,indirectArrowUpdate:!0}),d})})},hh=(e,t,{axis:n,position:i})=>{let o=Wt(e),[r,s]=n==="x"?["minX","maxX"]:["minY","maxY"],a={x:0,y:0};return i==="start"?{...a,[n]:t[r]-o[r]}:i==="end"?{...a,[n]:t[s]-o[s]}:{...a,[n]:(t[r]+t[s])/2-(o[r]+o[s])/2}};P();import{arrayToMap as dE,arrayToObject as Xt,assertNever as xc,isDevEnv as wn,isShallowEqual as wc,isTestEnv as bn,randomInteger as gc}from"@excalidraw/common";P();import{assertNever as Mh,COLOR_PALETTE as Th,isDevEnv as vh,isTestEnv as Dh,randomId as Bh,Emitter as Wd,toIterable as Qn}from"@excalidraw/common";P();import{ORIG_ID as wh,randomId as Yd,randomInteger as bh,arrayToMap as yh,castArray as Ms,findLastIndex as ki,getUpdatedTimestamp as Ph,isTestEnv as Ih}from"@excalidraw/common";P();import{arrayToMapWithIndex as Eh}from"@excalidraw/common";var gh=e=>{let t=e.slice(),n=new Set,i=r=>{let s=r[0]?.groupIds?.join(""),a=[r[0]],l=[];for(let d of r.slice(1))d.groupIds?.join("")===s?a.push(d):l.push(d);return l.length?[...a,...i(l)]:a},o=new Map;return t.forEach((r,s)=>{if(!o.has(r.id))if(r.groupIds?.length){let a=r.groupIds[r.groupIds.length-1],l=t.slice(s).filter(d=>{let c=d?.groupIds?.some(u=>u===a);return c&&o.set(d.id,!0),c});for(let d of i(l))n.add(d)}else n.add(r)}),n.size!==e.length?(console.error("normalizeGroupElementOrder: lost some elements... bailing!"),e):[...n]},xh=e=>{let t=Eh(e),n=e.slice(),i=new Set;return n.forEach((o,r)=>{o&&(o.boundElements?.length?(i.add(o),n[r]=null,o.boundElements.forEach(s=>{let a=t.get(s.id);a&&s.type==="text"&&(i.add(a[0]),n[a[1]]=null)})):o.type==="text"&&o.containerId&&t.get(o.containerId)?.[0].boundElements?.find(a=>a.id===o.id)||(i.add(o),n[r]=null))}),i.size!==e.length?(console.error("normalizeBoundElementsOrder: lost some elements... bailing!"),e):[...i]},Ud=e=>xh(gh(e));var Sh=(e,t,n,i)=>{let o=vs(n);return Ih()&&Ah(o,n.id),o.id=Yd(),o.updated=Ph(),i&&(o.seed=bh(),Dl(o)),o.groupIds=md(o.groupIds,e,r=>(t.has(r)||t.set(r,Yd()),t.get(r))),o},MP=e=>{let{elements:t}=e,n="appState"in e?e.appState:{editingGroupId:null,selectedGroupIds:{}},i=new Map,o=new Map,r=[],s=[],a=new Map,l=new Map,d=new Map,c=yh(t),u=e.type==="in-place"?e.idsOfElementsToDuplicate:new Map(t.map(E=>[E.id,E]));if(e.type==="in-place")for(let E of Object.keys(e.appState.selectedGroupIds))t.filter(g=>g.groupIds?.includes(E)).forEach(g=>u.set(g.id,g));t=Ud(t);let m=t.slice(),p=E=>{let x=Ms(E).reduce((w,y)=>{if(i.has(y.id))return w;i.set(y.id,!0);let b=Sh(n.editingGroupId,o,y,e.randomizeSeed);return i.set(b.id,!0),d.set(b.id,b),a.set(y.id,b.id),l.set(b.id,y),s.push(y),r.push(b),w.push(b),w},[]);return Array.isArray(E)?x:x[0]||null},f=(E,g)=>{if(g){if(E>m.length-1){m.push(...Ms(g));return}m.splice(E+1,0,...Ms(g))}},h=new Set(t.filter(E=>u.has(E.id)&&q(E)).map(E=>E.id));for(let E of t){if(i.has(E.id)||!u.has(E.id))continue;let g=cs(n,E);if(g){let x=Ce(t,g).flatMap(y=>q(y)?[...pn(t,y.id),y]:[y]),w=ki(m,y=>y.groupIds?.includes(g));f(w,p(x));continue}if(!(E.frameId&&h.has(E.frameId))){if(q(E)){let x=E.id,w=pn(t,x),y=ki(m,b=>b.frameId===x||b.id===x);f(y,p([...w,E]));continue}if(ht(E)){let x=$(E,c),w=ki(m,y=>y.id===E.id||"containerId"in y&&y.containerId===E.id);x?f(w,p([E,x])):f(w,p(E));continue}if(ue(E)){let x=Ae(E,c),w=ki(m,y=>y.id===E.id||y.id===x?.id);x?f(w,p([x,E])):f(w,p(E));continue}f(ki(m,x=>x.id===E.id),p(E))}}if(Rl(r,a,d),hd(m,s,a),e.overrides)for(let E of r){let g=l.get(E.id);g&&Object.assign(E,e.overrides({duplicateElement:E,origElement:g,origIdToDuplicateId:a}))}return{duplicatedElements:r,duplicateElementsMap:d,elementsWithDuplicates:m,origIdToDuplicateId:a}},Ts=(e,t=0)=>{if(e==null||typeof e!="object")return e;let n=Object.prototype.toString.call(e);if(n==="[object Object]"){let i=typeof e.constructor=="function"?Object.create(Object.getPrototypeOf(e)):{};for(let o in e)if(e.hasOwnProperty(o)){if(t===0&&(o==="shape"||o==="canvas"))continue;i[o]=Ts(e[o],t+1)}return i}if(Array.isArray(e)){let i=e.length,o=new Array(i);for(;i--;)o[i]=Ts(e[i],t+1);return o}return v.DEV&&n!=="[object Object]"&&n!=="[object Array]"&&n.startsWith("[object ")&&console.warn(`_deepCloneElement: unexpected object type ${n}. This value will not be cloned!`),e},vs=e=>Ts(e),Ah=(e,t)=>{Object.defineProperty(e,wh,{value:t,writable:!1,enumerable:!1})};var He={IMMEDIATELY:"IMMEDIATELY",NEVER:"NEVER",EVENTUALLY:"EVENTUALLY"},jd=class{constructor(t){this.app=t}onDurableIncrementEmitter=new Wd;onStoreIncrementEmitter=new Wd;scheduledMacroActions=new Set;scheduledMicroActions=[];_snapshot=xn.empty();get snapshot(){return this._snapshot}set snapshot(t){this._snapshot=t}scheduleAction(t){this.scheduledMacroActions.add(t),this.satisfiesScheduledActionsInvariant()}scheduleCapture(){this.scheduleAction(He.IMMEDIATELY)}scheduleMicroAction(t){let{action:n}=t,i;if("change"in t)i=t.change;else{let r=xn.create(this.app.scene.getElementsMapIncludingDeleted(),this.app.state),s=r.maybeClone(n,t.elements?$d(t.elements):void 0,t.appState);i=Fi.create(r,s)}let o="delta"in t?t.delta:void 0;this.scheduledMicroActions.push(()=>this.processAction({action:n,change:i,delta:o}))}commit(t,n){this.flushMicroActions();try{let i=this.getScheduledMacroAction();this.processAction({action:i,elements:t,appState:n})}finally{this.satisfiesScheduledActionsInvariant(),this.scheduledMacroActions=new Set}}clear(){this.snapshot=xn.empty(),this.scheduledMacroActions=new Set}emitDurableIncrement(t,n=void 0,i=void 0){let o=this.snapshot,r,s;if(n?r=n:r=Fi.create(o,t),i?s=i:s=Ls.calculate(o,t),!s.isEmpty()){let a=new Ds(r,s);this.onDurableIncrementEmitter.trigger(a),this.onStoreIncrementEmitter.trigger(a)}}emitEphemeralIncrement(t,n=void 0){let i;if(n)i=n;else{let r=this.snapshot;i=Fi.create(r,t)}let o=new Bs(i);this.onStoreIncrementEmitter.trigger(o)}applyChangeToSnapshot(t){let n=this.snapshot,i=this.snapshot.applyChange(t);return n===i?null:i}maybeCloneSnapshot(t,n,i){if(!n&&!i)return null;let o=this.snapshot,r=this.snapshot.maybeClone(t,n,i);return o===r?null:r}flushMicroActions(){for(let t of this.scheduledMicroActions)try{t()}catch(n){console.error("Failed to execute scheduled micro action",n)}this.scheduledMicroActions=[]}processAction(t){let{action:n}=t;if(n===He.EVENTUALLY&&!this.onStoreIncrementEmitter.subscribers.length)return;let i;if("change"in t?i=this.applyChangeToSnapshot(t.change):i=this.maybeCloneSnapshot(n,t.elements,t.appState),!i)return;let o="change"in t?t.change:void 0,r="delta"in t?t.delta:void 0;try{switch(n){case He.IMMEDIATELY:this.emitDurableIncrement(i,o,r);break;case He.NEVER:case He.EVENTUALLY:this.emitEphemeralIncrement(i,o);break;default:Mh(n,"Unknown store action")}}finally{switch(n){case He.IMMEDIATELY:case He.NEVER:this.snapshot=i;break}}}getScheduledMacroAction(){let t;return this.scheduledMacroActions.has(He.IMMEDIATELY)?t=He.IMMEDIATELY:this.scheduledMacroActions.has(He.NEVER)?t=He.NEVER:t=He.EVENTUALLY,t}satisfiesScheduledActionsInvariant(){if(!(this.scheduledMacroActions.size>=0&&this.scheduledMacroActions.size<=Object.keys(He).length)){let t=`There can be at most three store actions scheduled at the same time, but there are "${this.scheduledMacroActions.size}".`;if(console.error(t,this.scheduledMacroActions.values()),Dh()||vh())throw new Error(t)}}},Fi=class e{constructor(t,n){this.elements=t;this.appState=n}static create(t,n){let i=n.getChangedElements(t),o=n.getChangedAppState(t);return new e(i,o)}},Xo=class{constructor(t,n){this.type=t;this.change=n}static isDurable(t){return t.type==="durable"}static isEphemeral(t){return t.type==="ephemeral"}},Ds=class extends Xo{constructor(n,i){super("durable",n);this.change=n;this.delta=i}},Bs=class extends Xo{constructor(n){super("ephemeral",n);this.change=n}},Ls=class e{constructor(t,n,i){this.id=t;this.elements=n;this.appState=i}static create(t,n,i={id:Bh()}){return new this(i.id,t,n)}static calculate(t,n){let i=n.metadata.didElementsChange?gn.calculate(t.elements,n.elements):gn.empty(),o=n.metadata.didAppStateChange?En.calculate(t.appState,n.appState):En.empty();return this.create(i,o)}static restore(t){let{id:n,elements:i,appState:o}=t;return new this(n,gn.restore(i),En.restore(o))}static load({id:t,elements:{added:n,removed:i,updated:o},appState:{delta:r}}){let s=gn.create(n,i,o),a=En.create(r);return new this(t,s,a)}static squash(...t){let n=e.empty();for(let i of t)n.elements.squash(i.elements),n.appState.squash(i.appState);return n}static inverse(t){return this.create(t.elements.inverse(),t.appState.inverse())}static applyTo(t,n,i,o){let[r,s]=t.elements.applyTo(n,xn.empty().elements,o),[a,l]=t.appState.applyTo(i,r);return[r,a,s||l]}static applyLatestChanges(t,n,i,o){return this.create(t.elements.applyLatestChanges(n,i,o),t.appState,{id:t.id})}static empty(){return e.create(gn.empty(),En.empty())}isEmpty(){return this.elements.isEmpty()&&this.appState.isEmpty()}},xn=class e{constructor(t,n,i={didElementsChange:!1,didAppStateChange:!1,isEmpty:!1}){this.elements=t;this.appState=n;this.metadata=i}_lastChangedElementsHash=0;_lastChangedAppStateHash=0;static create(t,n,i={didElementsChange:!1,didAppStateChange:!1}){return new e(t,Xd(n)?n:Jn(n),i)}static empty(){return new e(new Map,Lh(),{didElementsChange:!1,didAppStateChange:!1,isEmpty:!0})}getChangedElements(t){let n={};for(let i of Qn(t.elements))this.elements.get(i.id)||(n[i.id]=De(i,{isDeleted:!0}));for(let i of Qn(this.elements))t.elements.get(i.id)!==i&&(n[i.id]=i);return n}getChangedAppState(t){return W.getRightDifferences(t.appState,this.appState).reduce((n,i)=>Object.assign(n,{[i]:this.appState[i]}),{})}isEmpty(){return this.metadata.isEmpty}applyChange(t){let n=new Map(this.elements);for(let[o,r]of Object.entries(t.elements))n.set(o,r);let i=Jn({...this.appState,...t.appState});return e.create(n,i,{didElementsChange:Object.keys(t.elements).length>0,didAppStateChange:Object.keys(t.appState).length>0})}maybeClone(t,n,i){let o={shouldCompareHashes:!1};t===He.EVENTUALLY&&(o.shouldCompareHashes=!0);let r=this.maybeCreateElementsSnapshot(n,o),s=this.maybeCreateAppStateSnapshot(i,o),a=!1,l=!1;return this.elements!==r&&(a=!0),this.appState!==s&&(l=!0),!a&&!l?this:new e(r,s,{didElementsChange:a,didAppStateChange:l})}maybeCreateAppStateSnapshot(t,n={shouldCompareHashes:!1}){if(!t)return this.appState;let i=Xd(t)?t:Jn(t);return this.detectChangedAppState(i,n)?i:this.appState}maybeCreateElementsSnapshot(t,n={shouldCompareHashes:!1}){if(!t)return this.elements;let i=this.detectChangedElements(t,n);return i?.size?this.createElementsSnapshot(i):this.elements}detectChangedAppState(t,n={shouldCompareHashes:!1}){if(this.appState===t)return;let i=W.isRightDifferent(this.appState,t);if(!i)return;let o=qd(JSON.stringify(t));if(!(n.shouldCompareHashes&&this._lastChangedAppStateHash===o))return this._lastChangedAppStateHash=o,i}detectChangedElements(t,n={shouldCompareHashes:!1}){if(this.elements===t)return;let i=new Map;for(let r of Qn(this.elements))t.get(r.id)||i.set(r.id,De(r,{isDeleted:!0}));for(let r of Qn(t)){let s=this.elements.get(r.id);if(!s||s.version<r.version){if(xe(r)&&!Mn(r))continue;i.set(r.id,r)}}if(!i.size)return;let o=Zd(i);if(!(n.shouldCompareHashes&&this._lastChangedElementsHash===o))return this._lastChangedElementsHash=o,i}createElementsSnapshot(t){let n=new Map;for(let i of Qn(this.elements))n.set(i.id,i);for(let i of Qn(t))n.set(i.id,vs(i));return n}},Vd="__observedAppState",Lh=()=>({name:null,editingGroupId:null,viewBackgroundColor:Th.white,selectedElementIds:{},selectedGroupIds:{},selectedLinearElement:null,croppingElementId:null,activeLockedId:null,lockedMultiSelections:{}}),Jn=e=>{let t={name:e.name,editingGroupId:e.editingGroupId,viewBackgroundColor:e.viewBackgroundColor,selectedElementIds:e.selectedElementIds,selectedGroupIds:e.selectedGroupIds,croppingElementId:e.croppingElementId,activeLockedId:e.activeLockedId,lockedMultiSelections:e.lockedMultiSelections,selectedLinearElement:e.selectedLinearElement?{elementId:e.selectedLinearElement.elementId,isEditing:!!e.selectedLinearElement.isEditing}:null};return Reflect.defineProperty(t,Vd,{value:!0,enumerable:!1}),t},Xd=e=>!!Reflect.get(e,Vd);P();P();var Jd="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";function ti(e,t,n){let i=n[0];if(t!=null&&e>=t)throw new Error(e+" >= "+t);if(e.slice(-1)===i||t&&t.slice(-1)===i)throw new Error("trailing zero");if(t){let s=0;for(;(e[s]||i)===t[s];)s++;if(s>0)return t.slice(0,s)+ti(e.slice(s),t.slice(s),n)}let o=e?n.indexOf(e[0]):0,r=t!=null?n.indexOf(t[0]):n.length;if(r-o>1){let s=Math.round(.5*(o+r));return n[s]}else return t&&t.length>1?t.slice(0,1):n[o]+ti(e.slice(1),null,n)}function ec(e){if(e.length!==tc(e[0]))throw new Error("invalid integer part of order key: "+e)}function tc(e){if(e>="a"&&e<="z")return e.charCodeAt(0)-97+2;if(e>="A"&&e<="Z")return 90-e.charCodeAt(0)+2;throw new Error("invalid order key head: "+e)}function Ri(e){let t=tc(e[0]);if(t>e.length)throw new Error("invalid order key: "+e);return e.slice(0,t)}function Kd(e,t){if(e==="A"+t[0].repeat(26))throw new Error("invalid order key: "+e);let n=Ri(e);if(e.slice(n.length).slice(-1)===t[0])throw new Error("invalid order key: "+e)}function Qd(e,t){ec(e);let[n,...i]=e.split(""),o=!0;for(let r=i.length-1;o&&r>=0;r--){let s=t.indexOf(i[r])+1;s===t.length?i[r]=t[0]:(i[r]=t[s],o=!1)}if(o){if(n==="Z")return"a"+t[0];if(n==="z")return null;let r=String.fromCharCode(n.charCodeAt(0)+1);return r>"a"?i.push(t[0]):i.pop(),r+i.join("")}else return n+i.join("")}function Ch(e,t){ec(e);let[n,...i]=e.split(""),o=!0;for(let r=i.length-1;o&&r>=0;r--){let s=t.indexOf(i[r])-1;s===-1?i[r]=t.slice(-1):(i[r]=t[s],o=!1)}if(o){if(n==="a")return"Z"+t.slice(-1);if(n==="A")return null;let r=String.fromCharCode(n.charCodeAt(0)-1);return r<"Z"?i.push(t.slice(-1)):i.pop(),r+i.join("")}else return n+i.join("")}function ei(e,t,n=Jd){if(e!=null&&Kd(e,n),t!=null&&Kd(t,n),e!=null&&t!=null&&e>=t)throw new Error(e+" >= "+t);if(e==null){if(t==null)return"a"+n[0];let l=Ri(t),d=t.slice(l.length);if(l==="A"+n[0].repeat(26))return l+ti("",d,n);if(l<t)return l;let c=Ch(l,n);if(c==null)throw new Error("cannot decrement any more");return c}if(t==null){let l=Ri(e),d=e.slice(l.length),c=Qd(l,n);return c??l+ti(d,null,n)}let i=Ri(e),o=e.slice(i.length),r=Ri(t),s=t.slice(r.length);if(i===r)return i+ti(o,s,n);let a=Qd(i,n);if(a==null)throw new Error("cannot increment any more");return a<t?a:i+ti(o,null,n)}function Vo(e,t,n,i=Jd){if(n===0)return[];if(n===1)return[ei(e,t,i)];if(t==null){let s=ei(e,t,i),a=[s];for(let l=0;l<n-1;l++)s=ei(s,t,i),a.push(s);return a}if(e==null){let s=ei(e,t,i),a=[s];for(let l=0;l<n-1;l++)s=ei(e,s,i),a.push(s);return a.reverse(),a}let o=Math.floor(n/2),r=ei(e,t,i);return[...Vo(e,r,o,i),r,...Vo(r,t,n-o-1,i)]}import{arrayToMap as $o}from"@excalidraw/common";var Cs=class extends Error{code="ELEMENT_HAS_INVALID_INDEX"},Gh=(e,{shouldThrow:t=!1,includeBoundTextValidation:n=!1,ignoreLogs:i,reconciliationContext:o})=>{let r=[],s=l=>`${l?.index}:${l?.id}:${l?.type}:${l?.isDeleted}:${l?.version}:${l?.versionNonce}`,a=e.map(l=>l.index);for(let[l,d]of a.entries()){let c=a[l-1],u=a[l+1];if(Gs(d,c,u)||r.push(`Fractional indices invariant has been compromised: "${s(e[l-1])}", "${s(e[l])}", "${s(e[l+1])}"`),n&&ht(e[l])){let m=e[l],p=$(m,$o(e));p&&p.index<=m.index&&r.push(`Fractional indices invariant for bound elements has been compromised: "${s(p)}", "${s(m)}"`)}}if(r.length){let l=new Cs,d=[];if(o&&(d.push("Additional reconciliation context:"),d.push(o.localElements.map(c=>s(c))),d.push(o.remoteElements.map(c=>s(c)))),i||console.error(r.join(`

`),l.stack,e.map(c=>s(c)),...d),t)throw l}},ic=e=>e.sort((t,n)=>nc(t)&&nc(n)?t.index<n.index?-1:t.index>n.index?1:t.id<n.id?-1:1:1),Ni=(e,t)=>{try{let n=$o(e),i=Oh(e,t),o=ks(e,i),r=e.map(s=>{let a=o.get(s);return a?{...s,index:a.index}:s});Gh(r,{includeBoundTextValidation:!1,shouldThrow:!0,ignoreLogs:!0});for(let[s,{index:a}]of o)be(s,n,{index:a})}catch{Os(e)}return e},Os=e=>{let t=$o(e),n=oc(e),i=ks(e,n);for(let[o,{index:r}]of i)be(o,t,{index:r});return e},$d=e=>{let t=$o(e),n=oc(e),i=ks(e,n);for(let[o,{index:r}]of i)t.set(o.id,De(o,{index:r}));return t},Oh=(e,t)=>{let n=[],i=0;for(;i<e.length;)if(t.has(e[i].id)){let o=[i-1,i];for(;++i<e.length&&t.has(e[i].id);)o.push(i);o.push(i),n.push(o)}else i++;return n},oc=e=>{let t=[],n,i,o=-1,r=0,s=d=>{let c=e[o]?e[o].index:void 0,u=e[d-1]?.index;return!c&&u||c&&u&&u>c?[u,d-1]:[c,o]},a=d=>{let c=e[r]?e[r].index:void 0;if(c&&d<r)return[c,r];let u=r;for(;++u<e.length;){let m=e[u]?.index;if(!c&&m||c&&m&&m>c)return[m,u]}return[void 0,u]},l=0;for(;l<e.length;){let d=e[l].index;if([n,o]=s(l),[i,r]=a(l),Gs(d,n,i))l++;else{let c=[o,l];for(;++l<e.length;){let u=e[l].index,[m,p]=s(l),[f,h]=a(l);if(Gs(u,m,f))break;[n,o]=[m,p],[i,r]=[f,h],c.push(l)}c.push(r),t.push(c)}}return t},Gs=(e,t,n)=>e?t&&n?t<e&&e<n:!t&&n?e<n:t&&!n?t<e:!!e:!1,ks=(e,t)=>{let n=new Map;for(let i of t){let o=i.shift(),r=i.pop(),s=Vo(e[o]?.index,e[r]?.index,i.length);for(let a=0;a<i.length;a++){let l=e[i[a]];n.set(l,{index:s[a]})}}return n},nc=e=>!!e.index;P();var Ec=fu(dc(),1);import{randomInteger as Qh,arrayToMap as cc,toBrandedType as uc,isDevEnv as mc,isTestEnv as pc,toArray as Jh}from"@excalidraw/common";import{isNonDeletedElement as eE}from"@excalidraw/element";import{isFrameLikeElement as tE}from"@excalidraw/element";import{getElementsInGroup as nE}from"@excalidraw/element";import{syncInvalidIndices as iE,syncMovedIndices as fc,validateFractionalIndices as oE}from"@excalidraw/element";import{getSelectedElements as rE}from"@excalidraw/element";import{mutateElement as sE}from"@excalidraw/element";var hc=e=>{let t=new Map,n=[];for(let i of e)i.isDeleted||(n.push(i),t.set(i.id,i));return{elementsMap:t,elements:n}},aE=(0,Ec.default)(e=>{(mc()||pc()||window?.DEBUG_FRACTIONAL_INDICES)&&oE(e,{shouldThrow:mc()||pc(),includeBoundTextValidation:!0})},1e3*60,{leading:!0,trailing:!1}),lE=e=>{let t=["includeBoundTextElement","includeElementsInFrames"],n="";for(let i of t)n+=`${i}:${e[i]?"1":"0"}`;return n},ni=class{callbacks=new Set;nonDeletedElements=[];nonDeletedElementsMap=uc(new Map);elements=[];nonDeletedFramesLikes=[];frames=[];elementsMap=uc(new Map);selectedElementsCache={selectedElementIds:null,elements:null,cache:new Map};sceneNonce;getSceneNonce(){return this.sceneNonce}getNonDeletedElementsMap(){return this.nonDeletedElementsMap}getElementsIncludingDeleted(){return this.elements}getElementsMapIncludingDeleted(){return this.elementsMap}getNonDeletedElements(){return this.nonDeletedElements}getFramesIncludingDeleted(){return this.frames}constructor(t=null,n){t&&this.replaceAllElements(t,n)}getSelectedElements(t){let n=lE(t),i=t?.elements||this.nonDeletedElements;if(this.selectedElementsCache.elements===i&&this.selectedElementsCache.selectedElementIds===t.selectedElementIds){let r=this.selectedElementsCache.cache.get(n);if(r)return r}else t?.elements==null&&this.selectedElementsCache.cache.clear();let o=rE(i,{selectedElementIds:t.selectedElementIds},t);return t?.elements==null&&(this.selectedElementsCache.selectedElementIds=t.selectedElementIds,this.selectedElementsCache.elements=this.nonDeletedElements,this.selectedElementsCache.cache.set(n,o)),o}getNonDeletedFramesLikes(){return this.nonDeletedFramesLikes}getElement(t){return this.elementsMap.get(t)||null}getNonDeletedElement(t){let n=this.getElement(t);return n&&eE(n)?n:null}mapElements(t){let n=!1,i=this.elements.map(o=>{let r=t(o);return r!==o&&(n=!0),r});return n&&this.replaceAllElements(i),n}replaceAllElements(t,n){let i=Jh(t),o=[];n?.skipValidation||aE(i),this.elements=iE(i),this.elementsMap.clear(),this.elements.forEach(s=>{tE(s)&&o.push(s),this.elementsMap.set(s.id,s)});let r=hc(this.elements);this.nonDeletedElements=r.elements,this.nonDeletedElementsMap=r.elementsMap,this.frames=o,this.nonDeletedFramesLikes=hc(this.frames).elements,this.triggerUpdate()}triggerUpdate(){this.sceneNonce=Qh();for(let t of Array.from(this.callbacks))t()}onUpdate(t){if(this.callbacks.has(t))throw new Error;return this.callbacks.add(t),()=>{if(!this.callbacks.has(t))throw new Error;this.callbacks.delete(t)}}destroy(){this.elements=[],this.nonDeletedElements=[],this.nonDeletedFramesLikes=[],this.frames=[],this.elementsMap.clear(),this.selectedElementsCache.selectedElementIds=null,this.selectedElementsCache.elements=null,this.selectedElementsCache.cache.clear(),this.callbacks.clear()}insertElementAtIndex(t,n){if(!Number.isFinite(n)||n<0)throw new Error("insertElementAtIndex can only be called with index >= 0");let i=[...this.elements.slice(0,n),t,...this.elements.slice(n)];fc(i,cc([t])),this.replaceAllElements(i)}insertElementsAtIndex(t,n){if(!t.length)return;if(!Number.isFinite(n)||n<0)throw new Error("insertElementAtIndex can only be called with index >= 0");let i=[...this.elements.slice(0,n),...t,...this.elements.slice(n)];fc(i,cc(t)),this.replaceAllElements(i)}insertElement=t=>{let n=t.frameId?this.getElementIndex(t.frameId):this.elements.length;this.insertElementAtIndex(t,n)};insertElements=t=>{if(!t.length)return;let n=t[0]?.frameId?this.getElementIndex(t[0].frameId):this.elements.length;this.insertElementsAtIndex(t,n)};getElementIndex(t){return this.elements.findIndex(n=>n.id===t)}getContainerElement=t=>t&&t.containerId&&this.getElement(t.containerId)||null;getElementsFromId=t=>{let n=this.getNonDeletedElementsMap(),i=n.get(t);return i?[i]:nE(n,t)};mutateElement(t,n,i={informMutation:!0,isDragging:!1}){let o=this.getNonDeletedElementsMap(),{version:r}=t,{version:s}=sE(t,o,n,i);return this.elementsMap.has(t.id)&&r!==s&&i.informMutation&&this.triggerUpdate(),t}};var W=class e{constructor(t,n){this.deleted=t;this.inserted=n}static create(t,n,i,o){let r=i&&o!=="inserted"?i(t,"deleted"):t,s=i&&o!=="deleted"?i(n,"inserted"):n;return new e(r,s)}static calculate(t,n,i,o){if(t===n)return e.empty();let r={},s={};for(let d of this.getDifferences(t,n))r[d]=t[d],s[d]=n[d];let[a,l]=o?o(r,s):[r,s];return e.create(a,l,i)}static empty(){return new e({},{})}static isEmpty(t){return!Object.keys(t.deleted).length&&!Object.keys(t.inserted).length}static merge(t,n,i=e.empty()){return e.create({...t.deleted,...n.deleted,...i.deleted},{...t.inserted,...n.inserted,...i.inserted})}static mergeObjects(t,n,i={}){let o={...t};for(let r of Object.keys(i))delete o[r];return{...o,...n}}static mergeArrays(t,n,i,o){return Object.values(e.mergeObjects(Xt(t??[],o),Xt(n??[],o),Xt(i??[],o)))}static diffObjects(t,n,i,o){if(!t[i]&&!n[i])return;let r=t[i]!==null&&typeof t[i]=="object",s=n[i]!==null&&typeof n[i]=="object";if(r||s){let a=t[i]??{},l=n[i]??{},d=e.getLeftDifferences(a,l).reduce((u,m)=>(u[m]=o(a[m]),u),{}),c=e.getRightDifferences(a,l).reduce((u,m)=>(u[m]=o(l[m]),u),{});Object.keys(d).length||Object.keys(c).length?(Reflect.set(t,i,d),Reflect.set(n,i,c)):(Reflect.deleteProperty(t,i),Reflect.deleteProperty(n,i))}else t[i]===n[i]&&(Reflect.deleteProperty(t,i),Reflect.deleteProperty(n,i))}static diffArrays(t,n,i,o){if(!(!t[i]&&!n[i])&&(Array.isArray(t[i])||Array.isArray(n[i]))){let r=Array.isArray(t[i])?t[i]:[],s=Array.isArray(n[i])?n[i]:[],a=Xt(e.getLeftDifferences(Xt(r,o),Xt(s,o)),d=>d),l=Xt(e.getRightDifferences(Xt(r,o),Xt(s,o)),d=>d);if(Object.keys(a).length||Object.keys(l).length){let d=r.filter(u=>a[o?o(u):String(u)]),c=s.filter(u=>l[o?o(u):String(u)]);Reflect.set(t,i,d),Reflect.set(n,i,c)}else Reflect.deleteProperty(t,i),Reflect.deleteProperty(n,i)}}static isLeftDifferent(t,n,i=!1){return!!this.distinctKeysIterator("left",t,n,i).next().value}static isRightDifferent(t,n,i=!1){return!!this.distinctKeysIterator("right",t,n,i).next().value}static isInnerDifferent(t,n,i=!1){return!!!!this.distinctKeysIterator("inner",t,n,i).next().value}static isDifferent(t,n,i=!1){return!!!!this.distinctKeysIterator("full",t,n,i).next().value}static getLeftDifferences(t,n,i=!1){return Array.from(this.distinctKeysIterator("left",t,n,i)).sort()}static getRightDifferences(t,n,i=!1){return Array.from(this.distinctKeysIterator("right",t,n,i)).sort()}static getInnerDifferences(t,n,i=!1){return Array.from(this.distinctKeysIterator("inner",t,n,i)).sort()}static getDifferences(t,n,i=!1){return Array.from(this.distinctKeysIterator("full",t,n,i)).sort()}static*distinctKeysIterator(t,n,i,o=!1){if(n===i)return;let r=[];t==="left"?r=Object.keys(n):t==="right"?r=Object.keys(i):t==="inner"?r=Object.keys(n).filter(s=>s in i):t==="full"?r=Array.from(new Set([...Object.keys(n),...Object.keys(i)])):xc(t,`Unknown distinctKeysIterator's join param "${t}"`,!0);for(let s of r){let a=n[s],l=i[s];if(a!==l){if(!o&&typeof a=="object"&&typeof l=="object"&&a!==null&&l!==null&&wc(a,l))continue;yield s}}}},En=class e{constructor(t){this.delta=t}static create(t){return new e(t)}static calculate(t,n){let i=W.calculate(t,n,e.orderAppStateKeys,e.postProcess);return new e(i)}static restore(t){let{delta:n}=t;return new e(n)}static empty(){return new e(W.create({},{}))}inverse(){let t=W.create(this.delta.inserted,this.delta.deleted);return new e(t)}squash(t){if(t.isEmpty())return this;let n=W.mergeObjects(this.delta.deleted.selectedElementIds??{},t.delta.deleted.selectedElementIds??{}),i=W.mergeObjects(this.delta.inserted.selectedElementIds??{},t.delta.inserted.selectedElementIds??{}),o=W.mergeObjects(this.delta.deleted.selectedGroupIds??{},t.delta.deleted.selectedGroupIds??{}),r=W.mergeObjects(this.delta.inserted.selectedGroupIds??{},t.delta.inserted.selectedGroupIds??{}),s=W.mergeObjects(this.delta.deleted.lockedMultiSelections??{},t.delta.deleted.lockedMultiSelections??{}),a=W.mergeObjects(this.delta.inserted.lockedMultiSelections??{},t.delta.inserted.lockedMultiSelections??{}),l={},d={};return(Object.keys(n).length||Object.keys(i).length)&&(d.selectedElementIds=n,l.selectedElementIds=i),(Object.keys(o).length||Object.keys(r).length)&&(d.selectedGroupIds=o,l.selectedGroupIds=r),(Object.keys(s).length||Object.keys(a).length)&&(d.lockedMultiSelections=s,l.lockedMultiSelections=a),this.delta=W.merge(this.delta,t.delta,W.create(d,l)),this}applyTo(t,n){try{let{selectedElementIds:i={},selectedGroupIds:o={},lockedMultiSelections:r={}}=this.delta.deleted,{selectedElementIds:s={},selectedGroupIds:a={},lockedMultiSelections:l={},selectedLinearElement:d,...c}=this.delta.inserted,u=W.mergeObjects(t.selectedElementIds,s,i),m=W.mergeObjects(t.selectedGroupIds,a,o),p=W.mergeObjects(t.lockedMultiSelections,l,r),f=d&&n.has(d.elementId)?new O(n.get(d.elementId),n,d.isEditing):null,h={...t,...c,selectedElementIds:u,selectedGroupIds:m,lockedMultiSelections:p,selectedLinearElement:typeof d<"u"?f:t.selectedLinearElement},E=this.filterInvisibleChanges(t,h,n);return[h,E]}catch(i){if(console.error("Couldn't apply appstate change",i),bn()||wn())throw i;return[t,!1]}}isEmpty(){return W.isEmpty(this.delta)}filterInvisibleChanges(t,n,i){let o=Jn(t),r=Jn(n),s=W.isRightDifferent(e.stripElementsProps(o),e.stripElementsProps(r)),a=W.isRightDifferent(e.stripStandaloneProps(o),e.stripStandaloneProps(r));if(!s&&!a)return!1;let l={value:s};if(a){let d=W.getRightDifferences(e.stripStandaloneProps(o),e.stripStandaloneProps(r)),c=new Set;(d.includes("editingGroupId")||d.includes("selectedGroupIds"))&&(c=dd(i));for(let u of d)switch(u){case"selectedElementIds":n[u]=e.filterSelectedElements(n[u],i,l);break;case"selectedGroupIds":n[u]=e.filterSelectedGroups(n[u],c,l);break;case"croppingElementId":{let x=n[u];if(!x)l.value=!0;else{let w=i.get(x);w&&!w.isDeleted?l.value=!0:n[u]=null}break}case"editingGroupId":let m=n[u];m?c.has(m)?l.value=!0:n[u]=null:l.value=!0;break;case"selectedLinearElement":let p=n[u];if(!p)l.value=!0;else{let x=i.get(p.elementId);x&&!x.isDeleted?l.value=!0:n[u]=null}break;case"lockedMultiSelections":let f=t[u]||{},h=n[u]||{};wc(f,h)||(l.value=!0);break;case"activeLockedId":let E=t[u]||null,g=n[u]||null;E!==g&&(l.value=!0);break;default:xc(u,`Unknown ObservedElementsAppState's key "${u}"`,!0)}}return l.value}static filterSelectedElements(t,n,i){let o=Object.keys(t);if(!o.length)return i.value=!0,t;let r={...t};for(let s of o){let a=n.get(s);a&&!a.isDeleted?i.value=!0:delete r[s]}return r}static filterSelectedGroups(t,n,i){if(!Object.keys(t).length)return i.value=!0,t;let r={...t};for(let s of Object.keys(r))n.has(s)?i.value=!0:delete r[s];return r}static stripElementsProps(t){let{editingGroupId:n,selectedGroupIds:i,selectedElementIds:o,selectedLinearElement:r,croppingElementId:s,lockedMultiSelections:a,activeLockedId:l,...d}=t;return d}static stripStandaloneProps(t){let{name:n,viewBackgroundColor:i,...o}=t;return o}static postProcess(t,n){try{W.diffObjects(t,n,"selectedElementIds",i=>!0),W.diffObjects(t,n,"selectedGroupIds",i=>i??!1),W.diffObjects(t,n,"lockedMultiSelections",i=>i??{})}catch(i){if(console.error("Couldn't postprocess appstate change deltas."),bn()||wn())throw i}finally{return[t,n]}}static orderAppStateKeys(t){let n={};for(let i of Object.keys(t).sort())n[i]=t[i];return n}},gn=class e{constructor(t,n,i){this.added=t;this.removed=n;this.updated=i}static create(t,n,i,o={shouldRedistribute:!1}){let r;if(o.shouldRedistribute){let s={},a={},l={},d=[...Object.entries(t),...Object.entries(n),...Object.entries(i)];for(let[c,u]of d)this.satisfiesAddition(u)?s[c]=u:this.satisfiesRemoval(u)?a[c]=u:l[c]=u;r=new e(s,a,l)}else r=new e(t,n,i);return(bn()||wn())&&(e.validate(r,"added",this.satisfiesAddition),e.validate(r,"removed",this.satisfiesRemoval),e.validate(r,"updated",this.satisfiesUpdate)),r}static restore(t){let{added:n,removed:i,updated:o}=t;return e.create(n,i,o)}static satisfiesAddition=({deleted:t,inserted:n})=>t.isDeleted===!0&&!n.isDeleted;static satisfiesRemoval=({deleted:t,inserted:n})=>!t.isDeleted&&n.isDeleted===!0;static satisfiesUpdate=({deleted:t,inserted:n})=>!!t.isDeleted==!!n.isDeleted;static satisfiesCommmonInvariants=({deleted:t,inserted:n})=>!!(Number.isInteger(t.version)&&Number.isInteger(n.version)&&t.version>=0&&n.version>=0&&t.version!==n.version);static satisfiesUniqueInvariants=(t,n)=>{let{added:i,removed:o,updated:r}=t;return[i[n],o[n],r[n]].filter(Boolean).length===1};static validate(t,n,i){for(let[o,r]of Object.entries(t[n]))if(!this.satisfiesCommmonInvariants(r)||!this.satisfiesUniqueInvariants(t,o)||!i(r))throw console.error(`Broken invariant for "${n}" delta, element "${o}", delta:`,r),new Error(`ElementsDelta invariant broken for element "${o}".`)}static calculate(t,n){if(t===n)return e.empty();let i={},o={},r={};for(let s of t.values())if(!n.get(s.id)){let l={...s},d={isDeleted:!0,version:s.version+1,versionNonce:gc()},c=W.create(l,d,e.stripIrrelevantProps);s.isDeleted?r[s.id]=c:o[s.id]=c}for(let s of n.values()){let a=t.get(s.id);if(!a){let l={isDeleted:!0,version:s.version-1,versionNonce:gc()},d={...s},c=W.create(l,d,e.stripIrrelevantProps);s.isDeleted?r[s.id]=c:i[s.id]=c;continue}if(a.versionNonce!==s.versionNonce){let l=W.calculate(a,s,e.stripIrrelevantProps,e.postProcess);if(typeof a.isDeleted=="boolean"&&typeof s.isDeleted=="boolean"&&a.isDeleted!==s.isDeleted){a.isDeleted&&!s.isDeleted?i[s.id]=l:o[s.id]=l;continue}r[s.id]=l}}return e.create(i,o,r)}static empty(){return e.create({},{},{})}inverse(){let t=r=>{let s={};for(let[a,{inserted:l,deleted:d}]of Object.entries(r))s[a]=W.create({...l},{...d});return s},n=t(this.added),i=t(this.removed),o=t(this.updated);return e.create(i,n,o)}isEmpty(){return Object.keys(this.added).length===0&&Object.keys(this.removed).length===0&&Object.keys(this.updated).length===0}applyLatestChanges(t,n,i){let o=(d,c)=>(u,m)=>{let p;switch(m){case"deleted":p=d;break;case"inserted":p=c;break}if(!p)return console.error("Element not found when trying to apply latest changes"),u;let f={};for(let h of Object.keys(u))switch(h){case"boundElements":f[h]=u[h];break;default:f[h]=p[h]}return f},r=d=>{let c={};for(let[u,m]of Object.entries(d)){let p=t.get(u),f=n.get(u),h=null;p||f?h=W.create(m.deleted,m.inserted,o(p,f),i):h=m,W.isInnerDifferent(h.deleted,h.inserted)&&(c[u]=h)}return c},s=r(this.added),a=r(this.removed),l=r(this.updated);return e.create(s,a,l,{shouldRedistribute:!0})}applyTo(t,n=xn.empty().elements,i){let o=new Map(t),r,s={containsVisibleDifference:!1,containsZindexDifference:!1,applyDirection:void 0};try{let a=e.createApplier(t,o,n,s,i),l=a(this.added),d=a(this.removed),c=a(this.updated),u=this.resolveConflicts(t,o,s.applyDirection);r=new Map([...l,...d,...c,...u])}catch(a){if(console.error("Couldn't apply elements delta",a),bn()||wn())throw a;return[t,!0]}try{o=e.reorderElements(o,r,s),e.redrawElements(o,r)}catch(a){if(console.error("Couldn't mutate elements after applying elements change",a),bn()||wn())throw a}finally{return[o,s.containsVisibleDifference]}}squash(t){if(t.isEmpty())return this;let{added:n,removed:i,updated:o}=t,r=(s,a)=>{let l=W.mergeArrays(s.deleted.boundElements??[],a.deleted.boundElements??[],void 0,c=>c.id)??[],d=W.mergeArrays(s.inserted.boundElements??[],a.inserted.boundElements??[],void 0,c=>c.id)??[];if(!(!l.length&&!d.length))return W.create({boundElements:l},{boundElements:d})};for(let[s,a]of Object.entries(n)){let l=this.added[s]??this.removed[s]??this.updated[s];if(!l)this.added[s]=a;else{let d=r(l,a);delete this.removed[s],delete this.updated[s],this.added[s]=W.merge(l,a,d)}}for(let[s,a]of Object.entries(i)){let l=this.added[s]??this.removed[s]??this.updated[s];if(!l)this.removed[s]=a;else{let d=r(l,a);delete this.added[s],delete this.updated[s],this.removed[s]=W.merge(l,a,d)}}for(let[s,a]of Object.entries(o)){let l=this.added[s]??this.removed[s]??this.updated[s];if(!l)this.updated[s]=a;else{let d=r(l,a),c=W.merge(l,a,d);l===this.added[s]?this.added[s]=c:l===this.removed[s]?this.removed[s]=c:this.updated[s]=c}}return(bn()||wn())&&(e.validate(this,"added",e.satisfiesAddition),e.validate(this,"removed",e.satisfiesRemoval),e.validate(this,"updated",e.satisfiesUpdate)),this}static createApplier=(t,n,i,o,r)=>s=>{let a=e.createGetter(n,i,o);return Object.entries(s).reduce((l,[d,c])=>{let u=a(d,c.inserted);if(u){let m=e.applyDelta(u,c,o,r);if(n.set(m.id,m),l.set(m.id,m),!o.applyDirection){let p=t.get(d);p&&(o.applyDirection=p.version>m.version?"backward":"forward")}}return l},new Map)};static createGetter=(t,n,i)=>(o,r)=>{let s=t.get(o);return s||(s=n.get(o),s?(i.containsZindexDifference=!0,(!r.isDeleted||r.isDeleted&&!s.isDeleted)&&(i.containsVisibleDifference=!0)):s=De({id:o,version:1},{...r})),s};static applyDelta(t,n,i,o){let r={};for(let s of Object.keys(n.inserted)){if(s==="boundElements"||o?.excludedProperties?.has(s))continue;let a=n.inserted[s];Reflect.set(r,s,a)}if(n.deleted.boundElements?.length||n.inserted.boundElements?.length){let s=W.mergeArrays(t.boundElements,n.inserted.boundElements,n.deleted.boundElements,a=>a.id);Object.assign(r,{boundElements:s})}if(!i.containsVisibleDifference){let{index:s,...a}=r,l=e.checkForVisibleDifference(t,a);i.containsVisibleDifference=l}return i.containsZindexDifference||(i.containsZindexDifference=n.deleted.index!==n.inserted.index),De(t,r,!0)}static checkForVisibleDifference(t,n){return t.isDeleted&&n.isDeleted!==!1?!1:t.isDeleted&&n.isDeleted===!1||t.isDeleted===!1&&n.isDeleted?!0:W.isRightDifferent(t,n)}resolveConflicts(t,n,i="forward"){let o=new Map,r=(a,l)=>{let d=n.get(a.id);if(!d)return;let c=t.get(a.id),u=i==="forward"?d.version+1:d.version-1,m=l,p;c===d?p=De(d,{...m,version:u},!0):p=be(d,n,{...m,version:c?.version!==d.version?d.version:u}),o.set(p.id,p),n.set(p.id,p)};for(let a of Object.keys(this.removed))e.unbindAffected(t,n,a,r);for(let a of Object.keys(this.added))e.rebindAffected(t,n,a,r);for(let[a]of Array.from(Object.entries(this.updated)).filter(([l,d])=>Object.keys({...d.deleted,...d.inserted}).find(c=>Nl.has(c)))){let l=n.get(a);!l||l.isDeleted||e.rebindAffected(t,n,a,r)}let s=new Map(Array.from(t).filter(([a])=>o.has(a)));return this.squash(e.calculate(s,o)),o}static unbindAffected(t,n,i,o){let r=()=>t.get(i),s=()=>n.get(i);cn.unbindAffected(n,r(),o),cn.unbindAffected(n,s(),o),un.unbindAffected(n,r(),o),un.unbindAffected(n,s(),o)}static rebindAffected(t,n,i,o){let r=()=>t.get(i),s=()=>n.get(i);cn.unbindAffected(n,r(),o),cn.rebindAffected(n,s(),o),un.unbindAffected(n,r(),(a,l)=>{ee(a)&&o(a,l)}),un.rebindAffected(n,s(),o)}static redrawElements(t,n){try{let i=new ni(t,{skipValidation:!0});e.redrawTextBoundingBoxes(i,n),e.redrawBoundArrows(i,n)}catch(i){if(console.error("Couldn't redraw elements",i),bn()||wn())throw i}finally{return t}}static redrawTextBoundingBoxes(t,n){let i=t.getNonDeletedElementsMap(),o=new Map;for(let r of n.values()){if(ue(r)){let{containerId:s}=r,a=s?i.get(s):void 0;a&&o.set(a.id,{container:a,boundText:r})}if(ht(r)){let s=Ft(r),a=s?i.get(s):void 0;a&&o.set(r.id,{container:r,boundText:a})}}for(let{container:r,boundText:s}of o.values())r.isDeleted||s.isDeleted||xo(s,r,t)}static redrawBoundArrows(t,n){for(let i of n.values())!i.isDeleted&&ce(i)&&ve(i,t,{changedElements:n})}static reorderElements(t,n,i){if(!i.containsZindexDifference)return t;let o=Array.from(t.values()),r=ic([...o]),s=W.getRightDifferences(o,r,!0).reduce((a,l)=>{let d=o[Number(l)];return d&&n.has(d.id)&&a.set(d.id,d),a},new Map);return!i.containsVisibleDifference&&s.size&&(i.containsVisibleDifference=!0),dE(Ni(r,s))}static postProcess(t,n){try{W.diffArrays(t,n,"boundElements",r=>r.id);let i=t.points??[],o=n.points??[];W.isDifferent(i,o)||(Reflect.deleteProperty(t,"points"),Reflect.deleteProperty(n,"points"))}catch(i){if(console.error("Couldn't postprocess elements delta."),bn()||wn())throw i}finally{return[t,n]}}static stripIrrelevantProps(t){let{id:n,updated:i,...o}=t;return o}};P();var xI=(e,t,n,i,o)=>{let[r,s,a,l]=n.axis==="x"?["minX","midX","maxX","width"]:["minY","midY","maxY","height"],d=Wt(e),c=No(e,t,i).map(f=>[f,Wt(f)]).sort((f,h)=>f[1][s]-h[1][s]),u=0;for(let f of c)u+=f[1][l];let m=(d[l]-u)/(c.length-1);if(m<0){let f=c.findIndex(x=>x[1][r]===d[r]),h=c.findIndex(x=>x[1][a]===d[a]),E=(c[h][1][s]-c[f][1][s])/(c.length-1),g=c[f][1][s];return c.flatMap(([x,w],y)=>{let b={x:0,y:0};return y!==f&&y!==h&&(g+=E,b[n.axis]=g-w[s]),x.map(I=>{let S=o.mutateElement(I,{x:I.x+b.x,y:I.y+b.y});return ve(I,o,{simultaneouslyUpdated:x}),S})})}let p=d[r];return c.flatMap(([f,h])=>{let E={x:0,y:0};return E[n.axis]=p-h[r],p+=m,p+=h[l],f.map(g=>{let x=o.mutateElement(g,{x:g.x+E.x,y:g.y+E.y});return ve(g,o,{simultaneouslyUpdated:f}),x})})};P();import{TEXT_AUTOWRAP_THRESHOLD as cE,getGridPoint as uE,getFontString as mE,DRAGGING_THRESHOLD as pE}from"@excalidraw/common";var vI=(e,t,n,i,o,r)=>{if(t.length===1&&_(t[0])&&(t[0].startBinding||t[0].endBinding))return;let s=t.filter(m=>{if(_(m)&&m.startBinding&&m.endBinding){let p=t.find(h=>h.id===m.startBinding?.elementId),f=t.find(h=>h.id===m.endBinding?.elementId);return p&&f}return!0}),a=new Set(s),l=s.filter(m=>q(m)).map(m=>m.id);if(l.length>0)for(let m of i.getNonDeletedElements())m.frameId!==null&&l.includes(m.frameId)&&a.add(m);let d=[];for(let m of a){let p=e.originalElements.get(m.id);if(!p)return;d.push(p)}let c=fE(Ge(d),n,o,r),u=new Set(Array.from(a,m=>m.id));a.forEach(m=>{let p=!H(m),f=p||(m.startBinding?u.has(m.startBinding.elementId):!1),h=p||(m.endBinding?u.has(m.endBinding.elementId):!1);if(H(m)){if(a.size>1||Math.max(Math.abs(c.x),Math.abs(c.y))>pE||!m.startBinding&&!m.endBinding){Rs(e,m,i,c);let E=m.startBinding&&!f,g=m.endBinding&&!h;(E||g)&&(E&&Te(m,"start",i),g&&Te(m,"end",i))}}else{Rs(e,m,i,c);let E=$(m,i.getNonDeletedElementsMap());E&&Rs(e,E,i,c),ve(m,i,{simultaneouslyUpdated:Array.from(a)})}})},fE=(e,t,n,i)=>{let[o,r]=e,s=o+t.x+n.x,a=r+t.y+n.y;if(n.x===0||n.y===0){let[l,d]=uE(o+t.x,r+t.y,i);n.x===0&&(s=l),n.y===0&&(a=d)}return{x:s-o,y:a-r}},Rs=(e,t,n,i)=>{let o=e.originalElements.get(t.id)??t,r=o.x+i.x,s=o.y+i.y;n.mutateElement(t,{x:r,y:s})},DI=(e,t,n)=>{let[i,o]=Ge(e);return[t-i,n-o]},BI=({newElement:e,elementType:t,originX:n,originY:i,x:o,y:r,width:s,height:a,shouldMaintainAspectRatio:l,shouldResizeFromCenter:d,zoom:c,scene:u,widthAspectRatio:m=null,originOffset:p=null,informMutation:f=!0})=>{l&&e.type!=="selection"&&(m?a=s/m:(Math.abs(r-i)>Math.abs(o-n)?{width:s,height:a}=As(t,a,o<n?-s:s):{width:s,height:a}=As(t,s,r<i?-a:a),a<0&&(a=-a)));let h=o<n?n-s:n,E=r<i?i-a:i;d&&(s+=s,a+=a,h=n-s/2,E=i-a/2);let g=null;if(ee(e)){a=e.height;let x=fo(mE({fontSize:e.fontSize,fontFamily:e.fontFamily}),e.lineHeight);s=Math.max(s,x),Math.abs(o-n)>cE/c&&(g={autoResize:!1}),E=i,d&&(h=n-s/2)}if(s!==0&&a!==0){let x=null;xe(e)&&(x={initialWidth:s,initialHeight:a}),u.mutateElement(e,{x:h+(p?.x??0),y:E+(p?.y??0),width:s,height:a,...g,...x},{informMutation:f,isDragging:!1})}};P();import{ELEMENT_LINK_KEY as qo,normalizeLink as bc}from"@excalidraw/common";var kI=(e,t)=>{let n=window.location.href;try{let i=new URL(n);return i.searchParams.set(qo,e),bc(i.toString())}catch(i){console.error(i)}return bc(n)},FI=(e,t)=>{if(e.length>0&&hE(e)){if(e.length===1)return{id:e[0].id,type:"element"};if(e.length>1){let n=Object.keys(t.selectedGroupIds)[0];return n?{id:n,type:"group"}:{id:e[0].groupIds[0],type:"group"}}}return null},hE=e=>!!(e.length===1||e.length>1&&cd(e)),RI=e=>{try{let t=new URL(e);return t.searchParams.has(qo)&&t.host===window.location.host}catch{return!1}},NI=e=>{try{let{searchParams:t}=new URL(e);if(t.has(qo))return t.get(qo)}catch{}return null};P();import{FONT_FAMILY as TE,VERTICAL_ALIGN as vE,escapeDoubleQuotes as Ns,getFontString as DE}from"@excalidraw/common";P();import{DEFAULT_ELEMENT_PROPS as yn,DEFAULT_FONT_FAMILY as EE,DEFAULT_FONT_SIZE as gE,DEFAULT_TEXT_ALIGN as xE,DEFAULT_VERTICAL_ALIGN as wE,VERTICAL_ALIGN as bE,randomInteger as yE,randomId as PE,getFontString as Ko,getUpdatedTimestamp as IE,getLineHeight as SE}from"@excalidraw/common";var ut=(e,{x:t,y:n,strokeColor:i=yn.strokeColor,backgroundColor:o=yn.backgroundColor,fillStyle:r=yn.fillStyle,strokeWidth:s=yn.strokeWidth,strokeStyle:a=yn.strokeStyle,roughness:l=yn.roughness,opacity:d=yn.opacity,width:c=0,height:u=0,angle:m=0,groupIds:p=[],frameId:f=null,index:h=null,roundness:E=null,boundElements:g=null,link:x=null,locked:w=yn.locked,...y})=>((t<-1e6||t>1e6||n<-1e6||n>1e6||c<-1e6||c>1e6||u<-1e6||u>1e6)&&console.error("New element size or position is too large",{x:t,y:n,width:c,height:u,points:y.points}),{id:y.id||PE(),type:e,x:t,y:n,width:c,height:u,angle:m,strokeColor:i,backgroundColor:o,fillStyle:r,strokeWidth:s,strokeStyle:a,roughness:l,opacity:d,groupIds:p,frameId:f,index:h,roundness:E,seed:y.seed??yE(),version:y.version||1,versionNonce:y.versionNonce??0,isDeleted:!1,boundElements:g,updated:IE(),link:x,locked:w,customData:y.customData}),Fn=e=>ut(e.type,e),$I=e=>ut("embeddable",e),ZI=e=>({...ut("iframe",e)}),yc=e=>De({...ut("frame",e),type:"frame",name:e?.name||null},{}),Pc=e=>De({...ut("magicframe",e),type:"magicframe",name:e?.name||null},{}),Ic=(e,t)=>({x:e.textAlign==="center"?t.width/2:e.textAlign==="right"?t.width:0,y:e.verticalAlign==="middle"?t.height/2:0}),Rn=e=>{let t=e.fontFamily||EE,n=e.fontSize||gE,i=e.lineHeight||SE(t),o=wi(e.text),r=We(o,Ko({fontFamily:t,fontSize:n}),i),s=e.textAlign||xE,a=e.verticalAlign||wE,l=Ic({textAlign:s,verticalAlign:a},r),d={...ut("text",e),text:o,fontSize:n,fontFamily:t,textAlign:s,verticalAlign:a,x:e.x-l.x,y:e.y-l.y,width:r.width,height:r.height,containerId:e.containerId||null,originalText:e.originalText??o,autoResize:e.autoResize??!0,lineHeight:i};return De(d,{})},AE=(e,t,n)=>{let{width:i,height:o}=We(n,Ko(e),e.lineHeight);e.autoResize||(i=e.width);let{textAlign:r,verticalAlign:s}=e,a,l;if(r==="center"&&s===bE.MIDDLE&&!e.containerId&&e.autoResize){let d=We(e.text,Ko(e),e.lineHeight),c=Ic(e,{width:i-d.width,height:o-d.height});a=e.x-c.x,l=e.y-c.y}else{let[d,c,u,m]=V(e,t),[p,f,h,E]=Qt(e,i,o,!1),g=(d-p)/2,x=(c-f)/2,w=(u-h)/2,y=(m-E)/2;[a,l]=ME({s:!0,e:r==="center"||r==="left",w:r==="center"||r==="right"},e.x,e.y,e.angle,g,x,w,y)}return{width:i,height:o,x:Number.isFinite(a)?a:e.x,y:Number.isFinite(l)?l:e.y}},ME=(e,t,n,i,o,r,s,a)=>{let l=Math.cos(i),d=Math.sin(i);return e.e&&e.w?t+=o+s:e.e?(t+=o*(1+l),n+=o*d,t+=s*(1-l),n+=s*-d):e.w&&(t+=o*(1-l),n+=o*-d,t+=s*(1+l),n+=s*d),e.n&&e.s?n+=r+a:e.n?(t+=r*d,n+=r*(1-l),t+=a*-d,n+=a*(1+l)):e.s&&(t+=r*-d,n+=r*(1+l),t+=a*d,n+=a*(1-l)),[t,n]},qI=(e,t,n,i=e.text)=>{if(e.isDeleted)return;(t||!e.autoResize)&&(i=kt(i,Ko(e),t?at(t,e):e.width));let o=AE(e,n,i);return{text:i,...o}},KI=e=>({...ut(e.type,e),points:e.points||[],pressures:e.pressures||[],simulatePressure:e.simulatePressure}),Sc=e=>{let t={...ut(e.type,e),points:e.points||[],startBinding:null,endBinding:null,startArrowhead:null,endArrowhead:null};return Bt(t)?{...t,polygon:e.polygon??!1}:t},Qo=e=>e.elbowed?{...ut(e.type,e),points:e.points||[],startBinding:null,endBinding:null,startArrowhead:e.startArrowhead||null,endArrowhead:e.endArrowhead||null,elbowed:!0,fixedSegments:e.fixedSegments||[],startIsSpecial:!1,endIsSpecial:!1}:{...ut(e.type,e),points:e.points||[],startBinding:null,endBinding:null,startArrowhead:e.startArrowhead||null,endArrowhead:e.endArrowhead||null,elbowed:!1},Ac=e=>({...ut("image",e),strokeColor:"transparent",status:e.status??"pending",fileId:e.fileId??null,scale:e.scale??[1,1],crop:e.crop??null});var It=new Map,BE=/^(?:http(?:s)?:\/\/)?(?:www\.)?youtu(?:be\.com|\.be)\/(embed\/|watch\?v=|shorts\/|playlist\?list=|embed\/videoseries\?list=)?([a-zA-Z0-9_-]+)/,LE=/^(?:http(?:s)?:\/\/)?(?:(?:w){3}\.)?(?:player\.)?vimeo\.com\/(?:video\/)?([^?\s]+)(?:\?.*)?$/,CE=/^https:\/\/(?:www\.)?figma\.com/,Mc=/^https:\/\/gist\.github\.com\/([\w_-]+)\/([\w_-]+)/,GE=/^<script[\s\S]*?\ssrc=["'](https:\/\/gist\.github\.com\/.*?)\.js["']/i,OE=/^(?:https?:\/\/)?forms\.microsoft\.com\//,Tc=/(?:https?:\/\/)?(?:(?:w){3}\.)?(?:twitter|x)\.com\/[^/]+\/status\/(\d+)/,kE=/^<blockquote[\s\S]*?\shref=["'](https?:\/\/(?:twitter|x)\.com\/[^"']*)/i,FE=/^https:\/\/(?:www\.)?val\.town\/(v|embed)\/[a-zA-Z_$][0-9a-zA-Z_$]+\.[a-zA-Z_$][0-9a-zA-Z_$]+/,RE=/^<(?:iframe|blockquote)[\s\S]*?\s(?:src|href)=["']([^"']*)["'][\s\S]*?>$/i,vc=/giphy.com\/(?:clips|embed|gifs)\/[a-zA-Z0-9]*?-?([a-zA-Z0-9]+)(?:[^a-zA-Z0-9]|$)/,Dc=/^(?:http(?:s)?:\/\/)?(?:www\.)?reddit\.com\/r\/([a-zA-Z0-9_]+)\/comments\/([a-zA-Z0-9_]+)\/([a-zA-Z0-9_]+)\/?(?:\?[^#\s]*)?(?:#[^\s]*)?$/,NE=/^<blockquote[\s\S]*?\shref=["'](https?:\/\/(?:www\.)?reddit\.com\/[^"']*)/i,zE=e=>{let t;try{let s=new URL(e.startsWith("http")?e:`https://${e}`);t=s.searchParams.get("t")||s.searchParams.get("start")}catch{t=e.match(/[?&#](?:t|start)=([^&#\s]+)/)?.[1]}if(!t)return 0;if(/^\d+$/.test(t))return parseInt(t,10);let n=t.match(/^(?:(\d+)h)?(?:(\d+)m)?(?:(\d+)s)?$/);if(!n)return 0;let[,i="0",o="0",r="0"]=n;return parseInt(i)*3600+parseInt(o)*60+parseInt(r)},Hs=new Set(["youtube.com","youtu.be","vimeo.com","player.vimeo.com","figma.com","link.excalidraw.com","gist.github.com","twitter.com","x.com","*.simplepdf.eu","stackblitz.com","val.town","giphy.com","reddit.com","forms.microsoft.com"]),Bc=new Set(["youtube.com","youtu.be","vimeo.com","player.vimeo.com","figma.com","twitter.com","x.com","*.simplepdf.eu","stackblitz.com","reddit.com","forms.microsoft.com"]),zs=e=>`<html><body>${e}</body></html>`,oS=e=>{if(!e)return null;if(It.has(e))return It.get(e);let t=e,n=Bc.has(_s(e,Bc)||""),i="generic",o={w:560,h:840},r=e.match(BE);if(r?.[2]){let d=zE(t),c=d>0?`&start=${d}`:"",u=e.includes("shorts");switch(i="video",r[1]){case"embed/":case"watch?v=":case"shorts/":e=`https://www.youtube.com/embed/${r[2]}?enablejsapi=1${c}`;break;case"playlist?list=":case"embed/videoseries?list=":e=`https://www.youtube.com/embed/videoseries?list=${r[2]}&enablejsapi=1${c}`;break;default:e=`https://www.youtube.com/embed/${r[2]}?enablejsapi=1${c}`;break}return o=u?{w:315,h:560}:{w:560,h:315},It.set(t,{link:e,intrinsicSize:o,type:i,sandbox:{allowSameOrigin:n}}),{link:e,intrinsicSize:o,type:i,sandbox:{allowSameOrigin:n}}}let s=e.match(LE);if(s?.[1]){let d=s?.[1],c=/^\d+$/.test(d)?void 0:new URIError("Invalid embed link format");return i="video",e=`https://player.vimeo.com/video/${d}?api=1`,o={w:560,h:315},It.set(t,{link:e,intrinsicSize:o,type:i,sandbox:{allowSameOrigin:n}}),{link:e,intrinsicSize:o,type:i,error:c,sandbox:{allowSameOrigin:n}}}if(e.match(CE))return i="generic",e=`https://www.figma.com/embed?embed_host=share&url=${encodeURIComponent(e)}`,o={w:550,h:550},It.set(t,{link:e,intrinsicSize:o,type:i,sandbox:{allowSameOrigin:n}}),{link:e,intrinsicSize:o,type:i,sandbox:{allowSameOrigin:n}};let l=e.match(FE);if(l)return e=l[1]==="embed"?l[0]:l[0].replace("/v","/embed"),It.set(t,{link:e,intrinsicSize:o,type:i,sandbox:{allowSameOrigin:n}}),{link:e,intrinsicSize:o,type:i,sandbox:{allowSameOrigin:n}};if(OE.test(e)&&!e.includes("embed=true")&&(e+=e.includes("?")?"&embed=true":"?embed=true"),Tc.test(e)){let d=e.match(Tc)[1],c=Ns(`https://twitter.com/x/status/${d}`),u={type:"document",srcdoc:m=>zs(`<blockquote class="twitter-tweet" data-dnt="true" data-theme="${m}"><a href="${c}"></a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"><\/script>`),intrinsicSize:{w:480,h:480},sandbox:{allowSameOrigin:n}};return It.set(t,u),u}if(Dc.test(e)){let[,d,c,u]=e.match(Dc),m=Ns(`https://reddit.com/r/${d}/comments/${c}/${u}`),p={type:"document",srcdoc:f=>zs(`<blockquote class="reddit-embed-bq" data-embed-theme="${f}"><a href="${m}"></a><br></blockquote><script async="" src="https://embed.reddit.com/widgets.js" charset="UTF-8"><\/script>`),intrinsicSize:{w:480,h:480},sandbox:{allowSameOrigin:n}};return It.set(t,p),p}if(Mc.test(e)){let[,d,c]=e.match(Mc),u=Ns(`https://gist.github.com/${d}/${c}`),m={type:"document",srcdoc:()=>zs(`
          <script src="${u}.js"><\/script>
          <style type="text/css">
            * { margin: 0px; }
            table, .gist { height: 100%; }
            .gist .gist-file { height: calc(100vh - 2px); padding: 0px; display: grid; grid-template-rows: 1fr auto; }
          </style>
        `),intrinsicSize:{w:550,h:720},sandbox:{allowSameOrigin:n}};return It.set(e,m),m}return It.set(e,{link:e,intrinsicSize:o,type:i,sandbox:{allowSameOrigin:n}}),{link:e,intrinsicSize:o,type:i,sandbox:{allowSameOrigin:n}}},rS=e=>{let t;ao(e)?t="IFrame element":t=!e.link||e?.link===""?"Empty Web-Embed":e.link;let n=Math.max(Math.min(e.width/2,e.width/t.length),e.width/30),i=TE.Helvetica,o=DE({fontSize:n,fontFamily:i});return Rn({x:e.x+e.width/2,y:e.y+e.height/2,strokeColor:e.strokeColor!=="transparent"?e.strokeColor:"black",backgroundColor:"transparent",fontFamily:i,fontSize:n,text:kt(t,o,e.width-20),textAlign:"center",verticalAlign:vE.MIDDLE,angle:e.angle??0})},_s=(e,t)=>{try{let{hostname:n}=new URL(e),i=n.replace(/^www\./,"");if(t instanceof Set){if(Hs.has(i))return i;let r=i.replace(/^([^.]+)/,"*");return Hs.has(r)?r:null}let o=t.replace(/^www\./,"");if(i===o)return o}catch{}return null},sS=e=>{let t=e.match(kE);if(t&&t.length===2)return t[1];let n=e.match(NE);if(n&&n.length===2)return n[1];let i=e.match(GE);if(i&&i.length===2)return i[1];if(vc.test(e))return`https://giphy.com/embed/${vc.exec(e)[1]}`;let o=e.match(RE);return o&&o.length===2?o[1]:e},aS=(e,t)=>{if(!e)return!1;if(t!=null)if(typeof t=="function"){let n=t(e);if(typeof n=="boolean")return n}else{if(typeof t=="boolean")return t;if(t instanceof RegExp)return t.test(e);if(Array.isArray(t)){for(let n of t)if(n instanceof RegExp){if(e.match(n))return!0}else if(_s(e,n))return!0;return!1}}return!!_s(e,Hs)};P();import{KEYS as Jo,invariant as er,toBrandedType as HE}from"@excalidraw/common";import{pointFrom as Lc}from"@excalidraw/math";var ii=100,Nn=100,yS=e=>{switch(e){case Jo.ARROW_UP:return"up";case Jo.ARROW_DOWN:return"down";case Jo.ARROW_RIGHT:return"right";case Jo.ARROW_LEFT:return"left";default:return"right"}},Oc=(e,t,n,i)=>{let o=[...n.values()].reduce((r,s)=>{let a;if(_(s)&&(a=s[e==="predecessors"?"startBinding":"endBinding"])&&s[e==="predecessors"?"endBinding":"startBinding"]?.elementId===t.id){let l=n.get(a.elementId);if(!l)return r;er(ce(l),"not an ExcalidrawBindableElement");let d=e==="predecessors"?s.points[s.points.length-1]:[0,0],c=Ii(t,et(t,n),[d[0]+s.x,d[1]+s.y]);r.push({relative:l,heading:c})}return r},[]);switch(i){case"up":return o.filter(r=>fe(r.heading,Ve)).map(r=>r.relative);case"down":return o.filter(r=>fe(r.heading,we)).map(r=>r.relative);case"right":return o.filter(r=>fe(r.heading,he)).map(r=>r.relative);case"left":return o.filter(r=>fe(r.heading,Re)).map(r=>r.relative)}},Us=(e,t,n)=>Oc("successors",e,t,n),Ys=(e,t,n)=>Oc("predecessors",e,t,n),_E=(e,t,n)=>{let i=Nn+e.width;if(n==="up"||n==="down"){let a=ii+e.height,l=e.x,d=e.x+e.width;if(t.every(c=>c.x+c.width<l||c.x>d))return{x:0,y:a*(n==="up"?-1:1)}}else if(n==="right"||n==="left"){let a=e.y,l=e.y+e.height;if(t.every(d=>d.y+d.height<a||d.y>l))return{x:(Nn+e.width)*(n==="left"?-1:1),y:0}}if(n==="up"||n==="down"){let a=ii+e.height,l=(t.length===0,a),d=t.length===0?0:(t.length+1)%2===0?(t.length+1)/2*i:t.length/2*i*-1;return n==="up"?{x:d,y:l*-1}:{x:d,y:l}}let o=ii+e.height,r=(t.length===0,Nn+e.width),s=t.length===0?0:(t.length+1)%2===0?(t.length+1)/2*o:t.length/2*o*-1;return n==="left"?{x:r*-1,y:s}:{x:r,y:s}},UE=(e,t,n,i)=>{let o=i.getNonDeletedElementsMap(),r=Us(e,o,n),s=Ys(e,o,n),a=_E(e,[...r,...s],n),l=Fn({type:e.type,x:e.x+a.x,y:e.y+a.y,width:e.width,height:e.height,roundness:e.roundness,roughness:e.roughness,backgroundColor:e.backgroundColor,strokeColor:e.strokeColor,strokeWidth:e.strokeWidth,opacity:e.opacity,fillStyle:e.fillStyle,strokeStyle:e.strokeStyle});er(Ir(l),"not an ExcalidrawFlowchartNodeElement");let d=kc(e,l,n,t,i);return{nextNode:l,bindingArrow:d}},YE=(e,t,n,i,o)=>{let r=[];for(let s=0;s<o;s++){let a,l;if(n==="left"||n==="right"){let u=ii*(o-1)+o*e.height,m=e.y+e.height/2-u/2,p=Nn+e.width;n==="left"&&(p*=-1),a=e.x+p;let f=(ii+e.height)*s;l=m+f}else{let u=Nn*(o-1)+o*e.width,m=e.x+e.width/2-u/2,p=ii+e.height;n==="up"&&(p*=-1),l=e.y+p;let f=(Nn+e.width)*s;a=m+f}let d=Fn({type:e.type,x:a,y:l,width:e.width,height:e.height,roundness:e.roundness,roughness:e.roughness,backgroundColor:e.backgroundColor,strokeColor:e.strokeColor,strokeWidth:e.strokeWidth,opacity:e.opacity,fillStyle:e.fillStyle,strokeStyle:e.strokeStyle});er(Ir(d),"not an ExcalidrawFlowchartNodeElement");let c=kc(e,d,n,t,i);r.push(d),r.push(c)}return r},kc=(e,t,n,i,o)=>{let r,s;switch(n){case"up":{r=e.x+e.width/2,s=e.y-6;break}case"down":{r=e.x+e.width/2,s=e.y+e.height+6;break}case"right":{r=e.x+e.width+6,s=e.y+e.height/2;break}case"left":{r=e.x-6,s=e.y+e.height/2;break}}let l,d;switch(n){case"up":{l=t.x+t.width/2-r,d=t.y+t.height-s+6;break}case"down":{l=t.x+t.width/2-r,d=t.y-s-6;break}case"right":{l=t.x-r-6,d=t.y-s+t.height/2;break}case"left":{l=t.x+t.width-r+6,d=t.y-s+t.height/2;break}}let c=Qo({type:"arrow",x:r,y:s,startArrowhead:null,endArrowhead:i.currentItemEndArrowhead,strokeColor:e.strokeColor,strokeStyle:e.strokeStyle,strokeWidth:e.strokeWidth,opacity:e.opacity,roughness:e.roughness,points:[Lc(0,0),Lc(l,d)],elbowed:!0}),u=o.getNonDeletedElementsMap();bt(c,e,"orbit","start",o),bt(c,t,"orbit","end",o);let m=new Map;m.set(e.id,e),m.set(t.id,t),m.set(c.id,c),O.movePoints(c,o,new Map([[1,{point:c.points[1]}]]));let p=Wn(c,HE(new Map([...u.entries(),[e.id,e],[t.id,t],[c.id,c]])),{points:c.points});return{...c,...p}},Cc=class{isExploring=!1;sameLevelNodes=[];sameLevelIndex=0;direction=null;visitedNodes=new Set;clear(){this.isExploring=!1,this.sameLevelNodes=[],this.sameLevelIndex=0,this.direction=null,this.visitedNodes.clear()}exploreByDirection(t,n,i){if(!ce(t))return null;if(i!==this.direction&&this.clear(),this.visitedNodes.has(t.id)||this.visitedNodes.add(t.id),this.isExploring&&i===this.direction&&this.sameLevelNodes.length>1)return this.sameLevelIndex=(this.sameLevelIndex+1)%this.sameLevelNodes.length,this.sameLevelNodes[this.sameLevelIndex].id;let o=[...Us(t,n,i),...Ys(t,n,i)];if(o.length>0)return this.sameLevelIndex=0,this.isExploring=!0,this.sameLevelNodes=o,this.direction=i,this.visitedNodes.add(o[0].id),o[0].id;if(i===this.direction||!this.isExploring){this.isExploring||this.visitedNodes.add(t.id);let s=["up","right","down","left"].filter(a=>a!==i).map(a=>[...Us(t,n,a),...Ys(t,n,a)]).flat().filter(a=>!this.visitedNodes.has(a.id));for(let a of s)if(!this.visitedNodes.has(a.id))return this.visitedNodes.add(a.id),this.isExploring=!0,this.direction=i,a.id}return null}},Gc=class{isCreatingChart=!1;numberOfNodes=0;direction="right";pendingNodes=null;createNodes(t,n,i,o){let r=o.getNonDeletedElementsMap();if(i!==this.direction){let{nextNode:s,bindingArrow:a}=UE(t,n,i,o);this.numberOfNodes=1,this.isCreatingChart=!0,this.direction=i,this.pendingNodes=[s,a]}else{this.numberOfNodes+=1;let s=YE(t,n,i,o,this.numberOfNodes);this.isCreatingChart=!0,this.direction=i,this.pendingNodes=s}if(t.frameId){let s=r.get(t.frameId);er(s&&co(s),"not an ExcalidrawFrameElement"),s&&this.pendingNodes.every(a=>fn([a],s,r)||mn(a,s,r))&&(this.pendingNodes=this.pendingNodes.map(a=>be(a,r,{frameId:t.frameId})))}}clear(){this.isCreatingChart=!1,this.pendingNodes=null,this.direction=null,this.numberOfNodes=0}},PS=(e,t)=>{for(let[,n]of t)if(n.type==="arrow"&&(n.startBinding?.elementId===e.id||n.endBinding?.elementId===e.id))return!0;return!1};P();import{pointDistance as zi,pointFrom as js}from"@excalidraw/math";import{invariant as Xc}from"@excalidraw/common";P();import{arrayToMap as Rc,findIndex as Nc,findLastIndex as zc}from"@excalidraw/common";var Ws=(e,t)=>e.frameId===t||e.id===t,Hc=(e,t,n)=>{let i=[],o=[],r=null,s=-1,a=Rc(n||yt(e,t,{includeBoundTextElement:!0,includeElementsInFrames:!0}));for(;++s<e.length;){let l=e[s];a.get(l.id)?(o.length&&(i=i.concat(o),o=[]),i.push(s),r=s+1):l.isDeleted&&r===s?(r=s+1,o.push(s)):o=[]}return i},WE=e=>{let t=0;return e.reduce((n,i,o)=>(o>0&&e[o-1]!==i-1&&(t=++t),(n[t]||(n[t]=[])).push(i),n),[])},Fc=(e,t,n,i)=>{if("containerId"in e&&e.containerId){let o=i.getElement(e.containerId);if(o)return n==="left"?Math.min(t.indexOf(o),t.indexOf(e)):Math.max(t.indexOf(o),t.indexOf(e))}else{let o=e.boundElements?.find(r=>r.type!=="arrow")?.id;if(o){let r=i.getElement(o);if(r)return n==="left"?Math.min(t.indexOf(r),t.indexOf(e)):Math.max(t.indexOf(r),t.indexOf(e))}}},jE=(e,t)=>{let n=-1,i=-1;return e.forEach((o,r)=>{Ws(o,t)&&(n===-1&&(n=r),i=r)}),n===-1?[]:e.slice(n,i+1)},_c=(e,t,n,i,o,r)=>{let s=r||Rt(e,n,i);if(!s)return n;let a=$(s,i),l=ee(s)?Ae(s,i):null,d=[s.id,a?.id,l?.id].filter(m=>!!m),c=n.findIndex(m=>d.includes(m.id)),u=n.findIndex(m=>m.id===t.id);if(u!==-1&&c!==-1&&u<c){let m=Array.from(n),p=m.splice(u,1)[0];m.splice(c,0,p),o.replaceAllElements(m)}return n},XE=(e,t,n,i,o,r)=>{let s=t[n],a=m=>m.isDeleted?!1:o?m.frameId===o:e.editingGroupId?m.groupIds.includes(e.editingGroupId):!0,l=i==="left"?zc(t,m=>a(m),Math.max(0,n-1)):Nc(t,m=>a(m),n+1),d=t[l];if(!d)return-1;if(e.editingGroupId){if(s?.groupIds.join("")===d?.groupIds.join(""))return Fc(d,t,i,r)??l;if(!d?.groupIds.includes(e.editingGroupId))return-1}if(!o&&(d.frameId||q(d))){let m=jE(t,d.frameId||d.id);return i==="left"?t.indexOf(m[0]):t.indexOf(m[m.length-1])}if(!d.groupIds.length)return Fc(d,t,i,r)??l;let c=e.editingGroupId?d.groupIds[d.groupIds.indexOf(e.editingGroupId)-1]:d.groupIds[d.groupIds.length-1],u=Ce(t,c);return u.length?i==="left"?t.indexOf(u[0]):t.indexOf(u[u.length-1]):l},Uc=(e,t)=>t.reduce((n,i)=>{let o=e[i];return n.set(o.id,o),n},new Map),Yc=(e,t,n,i)=>{let o=Hc(e,t),r=Uc(e,o),s=WE(o);n==="right"&&(s=s.reverse());let a=new Set(o.filter(l=>q(e[l])).map(l=>e[l].id));return s.forEach((l,d)=>{let c=l[0],u=l[l.length-1],m=n==="left"?c:u,p=l.some(w=>{let y=e[w];return y.frameId&&a.has(y.frameId)})?null:e[m]?.frameId,f=XE(t,e,m,n,p,i);if(f===-1||m===f)return;let h=n==="left"?e.slice(0,f):e.slice(0,c),E=e.slice(c,u+1),g=n==="left"?e.slice(f,c):e.slice(u+1,f+1),x=n==="left"?e.slice(u+1):e.slice(f+1);e=n==="left"?[...h,...E,...g,...x]:[...h,...g,...E,...x]}),Ni(e,r),e},Wc=(e,t,n,i,o)=>{let r=Hc(e,t,o),s=Uc(e,r),a=[],l,d;if(n==="left"){if(i)l=Nc(e,f=>Ws(f,i));else if(t.editingGroupId){let f=Ce(e,t.editingGroupId);if(!f.length)return e;l=e.indexOf(f[0])}else l=0;d=r[r.length-1]}else{if(i)d=zc(e,f=>Ws(f,i));else if(t.editingGroupId){let f=Ce(e,t.editingGroupId);if(!f.length)return e;d=e.indexOf(f[f.length-1])}else d=e.length-1;l=r[0]}l===-1&&(l=0);for(let f=l;f<d+1;f++)r.includes(f)||a.push(e[f]);let c=Array.from(s.values()),u=e.slice(0,l),m=e.slice(d+1),p=n==="left"?[...u,...c,...a,...m]:[...u,...a,...c,...m];return Ni(p,s),p};function jc(e,t,n,i){let o=Rc(yt(e,t,{includeBoundTextElement:!0,includeElementsInFrames:!0})),r={regularElements:[],frameChildren:new Map},s=new Set;for(let d of e)o.has(d.id)&&q(d)&&s.add(d.id);for(let d of e)if(o.has(d.id))if(q(d)||d.frameId&&s.has(d.frameId))r.regularElements.push(d);else if(!d.frameId)r.regularElements.push(d);else{let c=r.frameChildren.get(d.frameId)||[];c.push(d),r.frameChildren.set(d.frameId,c)}let a=e,l=Array.from(r.frameChildren.entries());for(let[d,c]of l)a=i(e,t,n,d,c);return i(a,t,n,null,r.regularElements)}var CS=(e,t,n)=>Yc(e,t,"left",n),GS=(e,t,n)=>Yc(e,t,"right",n),OS=(e,t)=>jc(e,t,"left",Wc),kS=(e,t)=>jc(e,t,"right",Wc);var tr=(e,t,n,i,o,r=!1)=>{if(_(t)||!wt(o)||t.points.length!==2||t.startBinding&&t.endBinding)return!1;if(!r){let s=t.startBinding?.elementId===n.id?0:t.points.length-1,a=O.getPointAtIndexGlobalCoordinates(t,s,i);if(zi(e,a)<Oo*1.5/o.zoom.value)return!1}return tn({element:n,elementsMap:i,point:e,threshold:Xe(n,t),overrideShouldTestInside:!0})},VE=(e,t,n,i,o,r,s)=>{let a=new Map,l=n?"startBinding":"endBinding",d=n?"endBinding":"startBinding",c=e[l],u=e[d];if(c&&t){let m=t&&u&&c.elementId===u.elementId;s||m?c={...c,mode:"inside"}:c={...c,mode:"orbit"};let p=n?0:e.points.length-1,f=dt(e,l,c,t,i);f&&a.set(p,{point:f})}if(u&&u.mode==="orbit"){let m=i.get(u.elementId);if(m&&ce(m)&&wt(r)){let p=t&&u.elementId===t.id;s||p?u={...u,mode:"inside"}:u={...u,mode:"orbit"};let f=n?e.points.length-1:0,h=dt(e,d,u,m,i);h&&a.set(f,{point:h})}}a.size>0&&O.movePoints(e,o,a,{[l]:c,[d]:u})},Vc=(e,t,n,i,o,r,s)=>{let a=O.getElement(e.elementId,t);if(!a||!Se(a)||_(a)||!e.hoveredFocusPointBinding||!e.draggedFocusPointBinding)return;let l=e.draggedFocusPointBinding==="start",d=l?a.startBinding:a.endBinding,{x:c,y:u}=e.pointerOffset,m=js(n.x-c,n.y-u),p=l?"startBinding":"endBinding",f=El(m,a,i.getNonDeletedElements(),t,Et(o.zoom));if(f&&wt(o)){a[p]&&f.id!==d?.elementId&&Te(a,e.draggedFocusPointBinding,i);let h=s&&a[p]?.mode==="orbit"?"inside":!s&&a[p]?.mode==="inside"?"orbit":null;(!a[p]||h)&&bt(a,f,h||"orbit",e.draggedFocusPointBinding,i,m),i.mutateElement(a,{[p]:{...a[p],elementId:f.id,mode:h||a[p]?.mode||"orbit",...Zn(a,f,e.draggedFocusPointBinding,t,m)}})}else{let h=new Map,E=l?0:a.points.length-1;h.set(E,{point:O.createPointAt(a,t,m[0],m[1],r)}),O.movePoints(a,i,h),a[p]&&Te(a,l?"start":"end",i)}VE(a,f,l,t,i,o,s),f&&wt(o)&&_c(m,a,i.getElementsIncludingDeleted(),t,i,f)},jS=(e,t,n,i)=>{let o=js(t.origin.x,t.origin.y),r=Oo*1.5/i.zoom.value;if(e.startBinding?.elementId){let s=n.get(e.startBinding.elementId);if(s&&ce(s)&&!s.isDeleted){let a=$e(e.startBinding.fixedPoint,s,n);if(tr(a,e,s,n,i)&&zi(o,a)<=r)return{hitFocusPoint:"start",pointerOffset:{x:o[0]-a[0],y:o[1]-a[1]}}}}if(e.endBinding?.elementId){let s=n.get(e.endBinding.elementId);if(s&&ce(s)&&!s.isDeleted){let a=$e(e.endBinding.fixedPoint,s,n);if(tr(a,e,s,n,i)&&zi(o,a)<=r)return{hitFocusPoint:"end",pointerOffset:{x:o[0]-a[0],y:o[1]-a[1]}}}}return{hitFocusPoint:null,pointerOffset:{x:0,y:0}}},XS=(e,t)=>{Xc(e.draggedFocusPointBinding,"Must have a dragged focus point at pointer release");let n=O.getElement(e.elementId,t.getNonDeletedElementsMap());Xc(n,"Arrow must be in the scene");let i=e.draggedFocusPointBinding==="start"?"startBinding":"endBinding",o=e.draggedFocusPointBinding==="start"?"endBinding":"startBinding",r=n[i]?.elementId,s=n[o]?.elementId,a=r&&t.getNonDeletedElements().find(d=>d.id!==r&&d.id!==s&&ce(d)&&d.boundElements?.find(({id:c})=>c===n.id));a&&t.mutateElement(a,{boundElements:a.boundElements?.filter(({id:d})=>d!==n.id)});let l=r&&t.getNonDeletedElementsMap().get(r);l&&t.mutateElement(l,{boundElements:[...(l.boundElements||[])?.filter(({id:d})=>d!==n.id),{id:n.id,type:"arrow"}]})},VS=(e,t,n,i,o)=>{let r=i.getNonDeletedElementsMap(),s=js(t,n),a=Oo*1.5/o.zoom.value;if(e.startBinding?.elementId){let l=r.get(e.startBinding.elementId);if(l&&ce(l)&&!l.isDeleted){let d=$e(e.startBinding.fixedPoint,l,r);if(tr(d,e,l,r,o)&&zi(s,d)<=a)return"start"}}if(e.endBinding?.elementId){let l=r.get(e.endBinding.elementId);if(l&&ce(l)&&!l.isDeleted){let d=$e(e.endBinding.fixedPoint,l,r);if(tr(d,e,l,r,o)&&zi(s,d)<=a)return"end"}}return null};P();import{MIME_TYPES as $c,SVG_NS as $E}from"@excalidraw/common";var ZE=e=>new Promise((t,n)=>{let i=new Image;i.onload=()=>{t(i)},i.onerror=o=>{n(o)},i.src=e}),QS=async({fileIds:e,files:t,imageCache:n})=>{let i=new Map,o=new Map;return await Promise.all(e.reduce((r,s)=>{let a=t[s];return a&&!i.has(s)?(i.set(s,!0),r.concat((async()=>{try{if(a.mimeType===$c.binary)throw new Error("Only images can be added to ImageCache");let l=ZE(a.dataURL),d={image:l,mimeType:a.mimeType};n.set(s,d);let c=await l;n.set(s,{...d,image:c})}catch{o.set(s,!0)}})())):r},[])),{imageCache:n,updatedFiles:i,erroredFiles:o}},JS=e=>e.filter(t=>Mn(t)),qE=e=>e?.nodeName.toLowerCase()==="svg",eA=e=>{let t=new DOMParser().parseFromString(e,$c.svg),n=t.querySelector("svg");if(t.querySelector("parsererror")||!qE(n))throw new Error("Invalid SVG");{n.hasAttribute("xmlns")||n.setAttribute("xmlns",$E);let o=n.getAttribute("width"),r=n.getAttribute("height");(o?.includes("%")||o==="auto")&&(o=null),(r?.includes("%")||r==="auto")&&(r=null);let s=n.getAttribute("viewBox");if(!o||!r){if(o=o||"50",r=r||"50",s){let a=s.match(/\d+ +\d+ +(\d+(?:\.\d+)?) +(\d+(?:\.\d+)?)/);a&&([,o,r]=a)}n.setAttribute("width",o),n.setAttribute("height",r)}return s||n.setAttribute("viewBox",`0 0 ${o} ${r}`),n.outerHTML}};P();var rA=(e,t,n,i=50)=>{if(!e||e.length===0)return[];let o=[],r=Array.isArray(e[0])?e:e.map(p=>[p]),s=r.length,a=Math.max(1,Math.ceil(Math.sqrt(s))),l=[];for(let p=0;p<s;p+=a)l.push(r.slice(p,p+a));let d=0,c=l.map(p=>{let f=0,h=0,E=p.map(g=>{let[x,w,y,b]=Ge(g);return{elements:g,bounds:[x,w,y,b],width:y-x,height:b-w}});return E.forEach((g,x)=>{f+=g.width,x<E.length-1&&(f+=i),g.height>h&&(h=g.height)}),d+=h,{unitBounds:E,width:f,maxHeight:h}}),u=d+Math.max(0,l.length-1)*i,m=n-u/2;return c.forEach(p=>{let{unitBounds:f,width:h,maxHeight:E}=p,g=t-h/2;f.forEach(x=>{let[w,y]=x.bounds,b=g-w,I=m-y;x.elements.forEach(S=>{o.push(De(S,{x:S.x+b,y:S.y+I}))}),g+=x.width+i}),m+=E+i}),o};P();import{pointCenter as KE,normalizeRadians as ir,pointFrom as ie,pointRotateRads as mt}from"@excalidraw/math";import{MIN_FONT_SIZE as Vs,SHIFT_LOCKING_ANGLE as or,rescalePoints as Zc,getFontString as nr}from"@excalidraw/common";var xA=(e,t,n,i,o,r,s,a,l,d,c)=>{let u=i.getNonDeletedElementsMap();if(n.length===1){let[m]=n;if(t==="rotation")_(m)||(QE(m,i,a,l,o),ve(m,i));else if(t){let p=n[0].id,f=u.get(p),h=e.get(p);if(f&&h){let{nextWidth:E,nextHeight:g}=ig(f,h,t,a,l,{shouldMaintainAspectRatio:s,shouldResizeFromCenter:r});ng(E,g,f,h,e,i,t,{shouldMaintainAspectRatio:s,shouldResizeFromCenter:r})}}return ee(m)&&ve(m,i),!0}else if(n.length>1){if(t==="rotation")return eg(e,n,i,a,l,o,d,c),!0;if(t){let{nextWidth:m,nextHeight:p,flipByX:f,flipByY:h,originalBoundingBox:E}=og(n,e,u,t,a,l,{shouldMaintainAspectRatio:s,shouldResizeFromCenter:r});return rg(n,u,t,i,e,{shouldResizeFromCenter:r,shouldMaintainAspectRatio:s,flipByX:f,flipByY:h,nextWidth:m,nextHeight:p,originalBoundingBox:E}),!0}}return!1},QE=(e,t,n,i,o)=>{let[r,s,a,l]=V(e,t.getNonDeletedElementsMap()),d=(r+a)/2,c=(s+l)/2,u;q(e)?u=0:(u=5*Math.PI/2+Math.atan2(i-c,n-d),o&&(u=u+or/2,u=u-u%or),u=ir(u));let m=Ft(e),p={angle:u};if(Se(e)&&(p={...p},e.startBinding&&Te(e,"start",t),e.endBinding&&Te(e,"end",t)),t.mutateElement(e,p),m){let f=t.getElement(m);if(f&&!H(e)){let{x:h,y:E}=bi(e,f,t.getNonDeletedElementsMap());t.mutateElement(f,{angle:u,x:h,y:E})}}},qc=(e,t,n,i)=>K(e)||Ie(e)?{points:Zc(0,t,Zc(1,n,e.points,i),i)}:{},$s=(e,t,n)=>{let i=e.width;if(ue(e)){let s=Ae(e,t);s&&(i=at(s,e))}let r=e.fontSize*(n/i);return r<Vs?null:{size:r}},JE=(e,t,n,i,o,r,s)=>{let a=n.getNonDeletedElementsMap(),l=t.width*(s/t.height),d=$s(t,a,l);if(d!==null){if(i.includes("n")||i.includes("s")){let c=ie(e.x,e.y),u=Xs(c,e.width,e.height,l,s,e.angle,i,!1,o);n.mutateElement(t,{fontSize:d.size,width:l,height:s,x:u.x,y:u.y});return}if(i==="e"||i==="w"){let c=fo(nr({fontSize:t.fontSize,fontFamily:t.fontFamily}),t.lineHeight),u=Math.max(c,r),m=kt(t.originalText,nr(t),Math.abs(u)),p=We(m,nr(t),t.lineHeight),f=p.height,h=ie(e.x,e.y),E=Xs(h,e.width,e.height,u,f,t.angle,i,!1,o),g={width:Math.abs(u),height:Math.abs(p.height),x:E.x,y:E.y,text:m,autoResize:!1};n.mutateElement(t,g)}}},eg=(e,t,n,i,o,r,s,a)=>{let l=n.getNonDeletedElementsMap(),d=5*Math.PI/2+Math.atan2(o-a,i-s);r&&(d+=or/2,d-=d%or);let c=new Map(t.map(u=>[u.id,u]));for(let u of t)if(!q(u)){let[m,p,f,h]=V(u,l),E=(m+f)/2,g=(p+h)/2,x=e.get(u.id)?.angle??u.angle,[w,y]=mt(ie(E,g),ie(s,a),d+x-u.angle),b=_(u)?{points:zl(u,l)}:{x:u.x+(w-E),y:u.y+(y-g),angle:ir(d+x)};n.mutateElement(u,b),ve(u,n,{simultaneouslyUpdated:t}),Se(u)&&(u.startBinding&&(c.has(u.startBinding.elementId)||Te(u,"start",n)),u.endBinding&&(c.has(u.endBinding.elementId)||Te(u,"end",n)));let I=$(u,l);if(I&&!H(u)){let{x:S,y:T}=bi(u,I,l);n.mutateElement(I,{x:S,y:T,angle:ir(d+x)})}}n.triggerUpdate()},wA=(e,t,n,i,o)=>{let[r,s,a,l]=t.length===1?V(t[0],n):Ge(t),d=(r+a)/2,c=(s+l)/2,u=t.length===1?t[0].angle:0;switch([i,o]=mt(ie(i,o),ie(d,c),-u),e){case"n":return mt(ie(i-(r+a)/2,o-s),ie(0,0),u);case"s":return mt(ie(i-(r+a)/2,o-l),ie(0,0),u);case"w":return mt(ie(i-r,o-(s+l)/2),ie(0,0),u);case"e":return mt(ie(i-a,o-(s+l)/2),ie(0,0),u);case"nw":return mt(ie(i-r,o-s),ie(0,0),u);case"ne":return mt(ie(i-a,o-s),ie(0,0),u);case"sw":return mt(ie(i-r,o-l),ie(0,0),u);case"se":return mt(ie(i-a,o-l),ie(0,0),u);default:return[0,0]}},bA=(e,t)=>{let[,[n,i]]=t.points;return e==="nw"&&(n<0||i<0)||e==="ne"&&n>=0||e==="sw"&&n<=0||e==="se"&&(n>0||i>0)?"end":"origin"},tg=(e,t,n)=>{if(n)return"center";if(t)switch(e){case"n":return"south-side";case"e":return"west-side";case"s":return"north-side";case"w":return"east-side";case"ne":return"bottom-left";case"nw":return"bottom-right";case"se":return"top-left";case"sw":return"top-right"}return["e","se","s"].includes(e)?"top-left":["n","nw","w"].includes(e)?"bottom-right":e==="ne"?"bottom-left":"top-right"},Xs=(e,t,n,i,o,r,s,a,l)=>{let d=tg(s,a,l),[c,u]=e;switch(d){case"top-left":return{x:c+(t-i)/2+(i-t)/2*Math.cos(r)+(n-o)/2*Math.sin(r),y:u+(n-o)/2+(i-t)/2*Math.sin(r)+(o-n)/2*Math.cos(r)};case"top-right":return{x:c+(t-i)/2*(Math.cos(r)+1)+(n-o)/2*Math.sin(r),y:u+(n-o)/2+(t-i)/2*Math.sin(r)+(o-n)/2*Math.cos(r)};case"bottom-left":return{x:c+(t-i)/2*(1-Math.cos(r))+(o-n)/2*Math.sin(r),y:u+(n-o)/2*(Math.cos(r)+1)+(i-t)/2*Math.sin(r)};case"bottom-right":return{x:c+(t-i)/2*(Math.cos(r)+1)+(o-n)/2*Math.sin(r),y:u+(n-o)/2*(Math.cos(r)+1)+(t-i)/2*Math.sin(r)};case"center":return{x:c-(i-t)/2,y:u-(o-n)/2};case"east-side":return{x:c+(t-i)/2*(Math.cos(r)+1),y:u+(t-i)/2*Math.sin(r)+(n-o)/2};case"west-side":return{x:c+(t-i)/2*(1-Math.cos(r)),y:u+(i-t)/2*Math.sin(r)+(n-o)/2};case"north-side":return{x:c+(t-i)/2+(n-o)/2*Math.sin(r),y:u+(o-n)/2*(Math.cos(r)-1)};case"south-side":return{x:c+(t-i)/2+(o-n)/2*Math.sin(r),y:u+(n-o)/2*(Math.cos(r)+1)}}},ng=(e,t,n,i,o,r,s,{shouldInformMutation:a=!0,shouldMaintainAspectRatio:l=!1,shouldResizeFromCenter:d=!1}={})=>{if(ee(n)&&ee(i))return JE(i,n,r,s,d,e,t);let c={},u=r.getNonDeletedElementsMap(),m=$(n,u);if(m){let E=o.get(m.id);if(E&&(c={fontSize:E.fontSize}),l){let g={...n,width:e,height:t},x=$s(m,u,at(g,m));if(x===null)return;c={fontSize:x.size}}else{let g=Ja(nr(m),m.lineHeight),x=el(m.fontSize,m.lineHeight);e=Math.max(e,g),t=Math.max(t,x)}}let p=qc(i,e,t,!0),f=ie(i.x,i.y);if(K(i)){let[E,g]=le(i,o);f=ie(E,g)}let h=Xs(f,i.width,i.height,e,t,i.angle,s,l,d);if(K(i)&&p.points){let E=i.x-f[0],g=i.y-f[1];h.x+=E,h.y+=g;let x=p.points[0][0],w=p.points[0][1];h.x+=x,h.y+=w,p.points=p.points.map(y=>ie(y[0]-x,y[1]-w))}if(e<0&&(h.x=h.x+e),t<0&&(h.y=h.y+t),"scale"in n&&"scale"in i&&r.mutateElement(n,{scale:[(Math.sign(e)||i.scale[0])*i.scale[0],(Math.sign(t)||i.scale[1])*i.scale[1]]}),H(n)&&m&&l){let E=e/n.width*m.fontSize;if(E<Vs)return;c.fontSize=E}if(e!==0&&t!==0&&Number.isFinite(h.x)&&Number.isFinite(h.y)){let E={...h,width:Math.abs(e),height:Math.abs(t),...p};Se(n)&&(n.startBinding&&(E={...E},n.startBinding&&Te(n,"start",r)),n.endBinding&&(E={...E,endBinding:null})),r.mutateElement(n,E,{informMutation:a,isDragging:!1}),m&&c!=null&&r.mutateElement(m,{fontSize:c.fontSize}),Bn(n,r,s,l),ve(n,r)}},ig=(e,t,n,i,o,{shouldMaintainAspectRatio:r=!1,shouldResizeFromCenter:s=!1}={})=>{let[a,l,d,c]=Qt(t,t.width,t.height,!0),u=ie(a,l),m=ie(d,c),p=KE(u,m),f=mt(ie(i,o),p,-t.angle),[h,E,g,x]=Qt(e,e.width,e.height,!0),w=g-h,y=x-E,b=m[0]-u[0],I=m[1]-u[1],S=b/w,T=I/y;n.includes("e")&&(S=(f[0]-u[0])/w),n.includes("s")&&(T=(f[1]-u[1])/y),n.includes("w")&&(S=(m[0]-f[0])/w),n.includes("n")&&(T=(m[1]-f[1])/y);let A=e.width*S,F=e.height*T;if(s&&(A=2*A-t.width,F=2*F-t.height),r){let B=Math.abs(A)/t.width,k=Math.abs(F)/t.height;if(n.length===1&&(F*=B,A*=k),n.length===2){let C=Math.max(B,k);A=t.width*C*Math.sign(A),F=t.height*C*Math.sign(F)}}return{nextWidth:A,nextHeight:F}},og=(e,t,n,i,o,r,{shouldMaintainAspectRatio:s=!1,shouldResizeFromCenter:a=!1}={})=>{let l=e.map(C=>t.get(C.id)),d=l.reduce((C,X)=>{if(!K(X))return C;let N=Ft(X);if(!N)return C;let Z=t.get(N)??null;return ue(Z)?[...C,{...Z,...O.getBoundTextElementPosition(X,Z,n)}]:C},[]),c=Wt(l.map(C=>C).concat(d)),{minX:u,minY:m,maxX:p,maxY:f,midX:h,midY:E}=c,g=p-u,x=f-m,w={ne:[u,f],se:[u,m],sw:[p,m],nw:[p,f],e:[u,m+x/2],w:[p,m+x/2],n:[u+g/2,f],s:[u+g/2,m]},[y,b]=a?[h,E]:w[i],I=a?2:1,S=Math.max(Math.abs(o-y)/g||0,Math.abs(r-b)/x||0)*I,T=i.includes("e")||i.includes("w")?Math.abs(o-y)*I:g,A=i.includes("n")||i.includes("s")?Math.abs(r-b)*I:x;s&&(T=g*S*Math.sign(o-y),A=x*S*Math.sign(r-b));let F={ne:[o<y,r>b],se:[o<y,r<b],sw:[o>y,r<b],nw:[o>y,r>b],e:[o<y,!1],w:[o>y,!1],n:[!1,r>b],s:[!1,r<b]},[B,k]=F[i].map(C=>C);return{originalBoundingBox:c,nextWidth:T,nextHeight:A,flipByX:B,flipByY:k}},rg=(e,t,n,i,o,{shouldMaintainAspectRatio:r=!1,shouldResizeFromCenter:s=!1,flipByX:a=!1,flipByY:l=!1,nextHeight:d,nextWidth:c,originalBoundingBox:u}={})=>{if(c===void 0&&d===void 0&&a===void 0&&l===void 0||d===0||c===0)return;o||(o=t);let m=e.reduce((I,S)=>{let T=o.get(S.id);return T&&I.push({orig:T,latest:S}),I},[]),p;if(u)p=u;else{let I=m.reduce((S,{orig:T})=>{if(!K(T))return S;let A=Ft(T);if(!A)return S;let F=o.get(A)??null;return ue(F)?[...S,{...F,...O.getBoundTextElementPosition(T,F,t)}]:S},[]);p=Wt(m.map(({orig:S})=>S).concat(I))}let{minX:f,minY:h,maxX:E,maxY:g,midX:x,midY:w}=p,y=E-f,b=g-h;if(c===void 0&&d===void 0&&(c=y,d=b),r&&(c===void 0?c=d*(y/b):d===void 0?d=c*(b/y):Math.abs(c/d-y/b)>.001&&(c=d*(y/b))),c&&d){let I=n.includes("e")||n.includes("w")?Math.abs(c)/y:1,S=n.includes("n")||n.includes("s")?Math.abs(d)/b:1,T;n.length===1?T=n.includes("e")||n.includes("w")?I:S:T=Math.max(Math.abs(c)/y||0,Math.abs(d)/b||0);let A={ne:[f,g],se:[f,h],sw:[E,h],nw:[E,g],e:[f,h+b/2],w:[E,h+b/2],n:[f+y/2,g],s:[f+y/2,h]},[F,B]=s?[x,w]:A[n],k=r||m.some(M=>M.latest.angle!==0||ee(M.latest)||ud(M.latest));k&&(I=T,S=T);let[C,X]=[a?-1:1,l?-1:1],N=[];for(let{orig:M,latest:U}of m){if(ee(M)&&ue(M))continue;let Y=M.width*I,St=M.height*S,pt=ir(M.angle*C*X),Hi=K(M)||Ie(M),dr=M.x-F,_i=M.y-B,oi=a&&!Hi?Y:0,cr=l&&!Hi?St:0,Ui=F+C*(dr*I+oi),Yi=B+X*(_i*S+cr),_e=qc(M,Y*C,St*X,!1),qe={x:Ui,y:Yi,width:Y,height:St,angle:pt,..._e};if(_(M)&&(M.startBinding&&(qe.startBinding={...M.startBinding,fixedPoint:[a?-M.startBinding.fixedPoint[0]+1:M.startBinding.fixedPoint[0],l?-M.startBinding.fixedPoint[1]+1:M.startBinding.fixedPoint[1]]}),M.endBinding&&(qe.endBinding={...M.endBinding,fixedPoint:[a?-M.endBinding.fixedPoint[0]+1:M.endBinding.fixedPoint[0],l?-M.endBinding.fixedPoint[1]+1:M.endBinding.fixedPoint[1]]}),M.fixedSegments&&_e.points&&(qe.fixedSegments=M.fixedSegments.map(At=>({...At,start:_e.points[At.index-1],end:_e.points[At.index]})))),xe(M)&&(qe.scale=[M.scale[0]*C,M.scale[1]*X]),ee(M)){let At=$s(M,t,Y);if(!At)return;qe.fontSize=At.size}let $t=o.get(Ft(M)??"");if($t)if(k){let At=$t.fontSize*T;if(At<Vs)return;qe.boundTextFontSize=At}else qe.boundTextFontSize=$t.fontSize;N.push({element:U,update:qe})}let Z=N.map(({element:M})=>M),L=new Map(N.map(({element:M})=>[M.id,M]));for(let{element:M,update:{boundTextFontSize:U,...Y}}of N){let{angle:St}=Y;i.mutateElement(M,Y),ve(M,i,{simultaneouslyUpdated:Z}),Se(M)&&(M.startBinding&&(L.has(M.startBinding.elementId)||Te(M,"start",i)),M.endBinding&&(L.has(M.endBinding.elementId)||Te(M,"end",i)));let pt=$(M,t);pt&&U&&(i.mutateElement(pt,{fontSize:U,angle:K(M)?void 0:St}),Bn(M,i,n,!0))}i.triggerUpdate()}};P();import{pointFrom as nt,pointOnLineSegment as nu,pointRotateRads as sr}from"@excalidraw/math";import{SIDE_RESIZING_THRESHOLD as ea}from"@excalidraw/common";P();import{DEFAULT_TRANSFORM_HANDLE_SPACING as qs}from"@excalidraw/common";import{pointFrom as Kc,pointRotateRads as sg}from"@excalidraw/math";var Qc={mouse:11,pen:18,touch:30},ag=16,eu={e:!0,s:!0,n:!0,w:!0},TA={e:!0,s:!0,n:!0,w:!0},vA={e:!0,s:!0,n:!0,w:!0,rotation:!0},Jc={e:!0,s:!0,n:!0,w:!0,nw:!0,se:!0},Zs={e:!0,s:!0,n:!0,w:!0},Vt=(e,t,n,i,o,r,s)=>{let[a,l]=sg(Kc(e+n/2,t+i/2),Kc(o,r),s);return[a-n/2,l-i/2,n,i]},rr=e=>!(e.formFactor==="phone"&&e.userAgent.isMobileDevice),Ks=e=>rr(e)?eu:{},Qs=([e,t,n,i,o,r],s,a,l,d={},c=4,u=qs)=>{let m=Qc[l],p=m/a.value,f=m/a.value,h=m/a.value,E=m/a.value,g=n-e,x=i-t,w=c/a.value,y=(m-u*2)/(2*a.value),b={nw:d.nw?void 0:Vt(e-w-h+y,t-w-E+y,p,f,o,r,s),ne:d.ne?void 0:Vt(n+w-y,t-w-E+y,p,f,o,r,s),sw:d.sw?void 0:Vt(e-w-h+y,i+w-y,p,f,o,r,s),se:d.se?void 0:Vt(n+w-y,i+w-y,p,f,o,r,s),rotation:d.rotation?void 0:Vt(e+g/2-p/2,t-w-E+y-ag/a.value,p,f,o,r,s)},I=5*Qc.mouse/a.value;return Math.abs(g)>I&&(d.n||(b.n=Vt(e+g/2-p/2,t-w-E+y,p,f,o,r,s)),d.s||(b.s=Vt(e+g/2-p/2,i+w-y,p,f,o,r,s))),Math.abs(x)>I&&(d.w||(b.w=Vt(e-w-h+y,t+x/2-f/2,p,f,o,r,s)),d.e||(b.e=Vt(n+w-y,t+x/2-f/2,p,f,o,r,s))),b},tu=(e,t,n,i="mouse",o=eu)=>{if(e.locked||_(e))return{};if(e.type==="freedraw"||K(e)){if(e.points.length===2){let[,s]=e.points;s[0]===0||s[1]===0?o=Zs:s[0]>0&&s[1]<0?o=Jc:s[0]>0&&s[1]>0?o=Zs:s[0]<0&&s[1]>0?o=Jc:s[0]<0&&s[1]<0&&(o=Zs)}}else q(e)&&(o={...o,rotation:!0});let r=K(e)?qs+8:xe(e)?0:qs;return Qs(V(e,n,!0),e.angle,t,i,o,r,xe(e)?0:void 0)},DA=(e,t,n)=>{if(t.selectedLinearElement?.isEditing||t.selectedLinearElement?.isDragging)return!1;if(e.length>1)return!0;let i=e[0];return _(i)?!1:K(i)?i.points.length>2&&!n.userAgent.isMobileDevice:!0};var ta=(e,t,n)=>t>=e[0]&&t<=e[0]+e[2]&&n>=e[1]&&n<=e[1]+e[3],lg=(e,t,n,i,o,r,s,a)=>{if(!n.selectedElementIds[e.id])return!1;let{rotation:l,...d}=tu(e,r,t,s,Ks(a));if(l&&ta(l,i,o))return"rotation";let c=Object.keys(d).filter(u=>{let m=d[u];return m?ta(m,i,o):!1});if(c.length>0)return c[0];if(rr(a)){let[u,m,p,f,h,E]=V(e,t);if(!(K(e)&&e.points.length<=2)){let g=xe(e)?0:ea/r.value,x=ea/r.value,w=iu(nt(u-g,m-g),nt(p+g,f+g),nt(h,E),e.angle);for(let[y,b]of Object.entries(w))if(nu(nt(i,o),b,x))return y}}return!1},RA=(e,t,n,i,o,r,s,a)=>e.reduce((l,d)=>{if(l)return l;let c=lg(d,s,t,n,i,o,r,a);return c?{element:d,transformHandleType:c}:null},null),NA=([e,t,n,i],o,r,s,a,l)=>{let d=Qs([e,t,n,i,(e+n)/2,(t+i)/2],0,s,a,Ks(l)),c=Object.keys(d).find(u=>{let m=d[u];return m&&ta(m,o,r)});if(c)return c;if(rr(l)){let u=(e+n)/2,m=(t+i)/2,p=ea/s.value,f=iu(nt(e-p,t-p),nt(n+p,i+p),nt(u,m),0);for(let[h,E]of Object.entries(f))if(nu(nt(o,r),E,p))return h}return!1},Js=["ns","nesw","ew","nwse"],dg=(e,t)=>{let n=Js.indexOf(e);if(n>=0){let i=Math.round(t/(Math.PI/4));e=Js[(n+i)%Js.length]}return e},zA=e=>{let{element:t,transformHandleType:n}=e,i=t&&Math.sign(t.height)*Math.sign(t.width)===-1,o=null;switch(n){case"n":case"s":o="ns";break;case"w":case"e":o="ew";break;case"nw":case"se":i?o="nesw":o="nwse";break;case"ne":case"sw":i?o="nwse":o="nesw";break;case"rotation":return"grab"}return o&&t&&(o=dg(o,t.angle)),o?`${o}-resize`:""},iu=([e,t],[n,i],o,r)=>{let s=sr(nt(e,t),o,r),a=sr(nt(n,t),o,r),l=sr(nt(e,i),o,r),d=sr(nt(n,i),o,r);return{n:[s,a],e:[a,d],s:[d,l],w:[l,s]}};P();var YA=(e,t)=>!!(!e.viewModeEnabled&&e.openDialog?.name!=="elementLinkSelector"&&(e.activeTool.type!=="custom"&&(e.editingTextElement||e.activeTool.type!=="selection"&&e.activeTool.type!=="lasso"&&e.activeTool.type!=="eraser"&&e.activeTool.type!=="hand"&&e.activeTool.type!=="laser")||yt(t,e).length));P();import{pointFrom as ar}from"@excalidraw/math";import{DEFAULT_BOUND_TEXT_STROKE_COLOR as cg,DEFAULT_FONT_FAMILY as ug,DEFAULT_FONT_SIZE as mg,TEXT_ALIGN as pg,VERTICAL_ALIGN as fg,getSizeFromPoints as hg,randomId as Eg,arrayToMap as gg,assertNever as na,cloneJSON as ru,getFontString as xg,isDevEnv as wg,toBrandedType as bg,getLineHeight as yg}from"@excalidraw/common";var lr={width:100,height:0},Pn=100,Pg=(e,t,n)=>{let i=Rn({x:0,y:0,textAlign:pg.CENTER,verticalAlign:fg.MIDDLE,...t,containerId:e.id,strokeColor:t.strokeColor??cg});return Object.assign(e,{boundElements:(e.boundElements||[]).concat({type:"text",id:i.id})}),xo(i,e,n),[e,i]},ou=(e,t,n,i,o)=>{let r,s;if(Object.assign(e,{startBinding:e?.startBinding||null,endBinding:e.endBinding||null}),t){let c=t?.width??Pn,u=t?.height??Pn,m;t.id&&(m=i.getElement(t.id),m||console.error(`No element for start binding with id ${t.id} found`));let p=t.x||e.x-c,f=t.y||e.y-u/2,h=m?m.type:t.type;if(h){if(h==="text"){let E="";m&&m.type==="text"?E=m.text:t.type==="text"&&(E=t.text),E||console.error(`No text found for start binding text element for ${e.id}`),r=Rn({x:p,y:f,type:"text",...m,...t,text:E}),Object.assign(r,{x:t.x||e.x-r.width,y:t.y||e.y-r.height/2})}else switch(h){case"rectangle":case"ellipse":case"diamond":{r=Fn({x:p,y:f,width:c,height:u,...m,...t,type:h});break}default:na(e,`Unhandled element start type "${t.type}"`,!0)}bt(e,r,"orbit","start",o)}}if(n){let c=n?.height??Pn,u=n?.width??Pn,m;n.id&&(m=i.getElement(n.id),m||console.error(`No element for end binding with id ${n.id} found`));let p=n.x||e.x+e.width,f=n.y||e.y-c/2,h=m?m.type:n.type;if(h){if(h==="text"){let E="";m&&m.type==="text"?E=m.text:n.type==="text"&&(E=n.text),E||console.error(`No text found for end binding text element for ${e.id}`),s=Rn({x:p,y:f,type:"text",...m,...n,text:E}),Object.assign(s,{y:n.y||e.y-s.height/2})}else switch(h){case"rectangle":case"ellipse":case"diamond":{s=Fn({x:p,y:f,width:u,height:c,...m,...n,type:h});break}default:na(e,`Unhandled element end type "${h}"`,!0)}bt(e,s,"orbit","end",o)}}if(e.points.length<2)return{linearElement:e,startBoundElement:r,endBoundElement:s};let a=e.points.length-1,l=.5,d=ru(e.points);return e.points[a][0]>e.points[a-1][0]&&(d[0][0]=l,d[a][0]-=l),e.points[a][0]<e.points[a-1][0]&&(d[0][0]=-l,d[a][0]+=l),e.points[a][1]>e.points[a-1][1]&&(d[0][1]=l,d[a][1]-=l),e.points[a][1]<e.points[a-1][1]&&(d[0][1]=-l,d[a][1]+=l),Object.assign(e,O.getNormalizeElementPointsAndCoords({...e,points:d})),{linearElement:e,startBoundElement:r,endBoundElement:s}},ia=class{excalidrawElements=new Map;add=t=>{t&&this.excalidrawElements.set(t.id,t)};getElements=()=>Os(Array.from(this.excalidrawElements.values()));getElementsMap=()=>bg(gg(this.getElements()));getElement=t=>this.excalidrawElements.get(t)},iM=(e,t)=>{if(!e)return[];let n=ru(e),i=new ia,o=new Map,r=new Map;for(let l of n){let d,c=l.id;switch(t?.regenerateIds!==!1&&Object.assign(l,{id:Eg()}),l.type){case"rectangle":case"ellipse":case"diamond":{let m=l?.label?.text&&l.width===void 0?0:l?.width||Pn,p=l?.label?.text&&l.height===void 0?0:l?.height||Pn;d=Fn({...l,width:m,height:p});break}case"line":{let m=l.width||lr.width,p=l.height||lr.height;d=Sc({width:m,height:p,points:[ar(0,0),ar(m,p)],...l});break}case"arrow":{let m=l.width||lr.width,p=l.height||lr.height;d=Qo({width:m,height:p,endArrowhead:"arrow",points:[ar(0,0),ar(m,p)],...l,type:"arrow"}),Object.assign(d,hg(d.points));break}case"text":{let m=l?.fontFamily||ug,p=l?.fontSize||mg,f=l?.lineHeight||yg(m),h=l.text??"",E=wi(h),g=We(E,xg({fontFamily:m,fontSize:p}),f);d=Rn({width:g.width,height:g.height,fontFamily:m,fontSize:p,...l});break}case"image":{d=Ac({width:l?.width||Pn,height:l?.height||Pn,...l});break}case"frame":{d=yc({x:0,y:0,...l});break}case"magicframe":{d=Pc({x:0,y:0,...l});break}case"freedraw":case"iframe":case"embeddable":{d=l;break}default:d=l,na(l,`Unhandled element type "${l.type}"`,!0)}i.getElement(d.id)?console.error(`Duplicate id found for ${d.id}`):(i.add(d),o.set(d.id,l),c&&r.set(c,d.id))}let s=i.getElementsMap(),a=new ni(s);for(let[l,d]of o){let c=i.getElement(l);switch(d.type){case"rectangle":case"ellipse":case"diamond":case"arrow":{if(d.label?.text){let[u,m]=Pg(c,d?.label,a);if(i.add(u),i.add(m),H(u)){let p=d.type==="arrow"?d?.start:void 0,f=d.type==="arrow"?d?.end:void 0;if(p&&p.id){let x=r.get(p.id);x&&Object.assign(p,{id:x})}if(f&&f.id){let x=r.get(f.id);x&&Object.assign(f,{id:x})}let{linearElement:h,startBoundElement:E,endBoundElement:g}=ou(u,p,f,i,a);u=h,i.add(h),i.add(E),i.add(g)}}else switch(d.type){case"arrow":{let{start:u,end:m}=d;if(u&&u.id){let E=r.get(u.id);Object.assign(u,{id:E})}if(m&&m.id){let E=r.get(m.id);Object.assign(m,{id:E})}let{linearElement:p,startBoundElement:f,endBoundElement:h}=ou(c,u,m,i,a);i.add(p),i.add(f),i.add(h);break}}break}}}for(let[l,d]of o){if(d.type!=="frame"&&d.type!=="magicframe")continue;let c=i.getElement(l);if(!c)throw new Error(`Excalidraw element with id ${l} doesn't exist`);let u=[];d.children.forEach(b=>{let I=r.get(b);if(!I)throw new Error(`Element with ${b} wasn't mapped correctly`);let S=i.getElement(I);if(!S)throw new Error(`Frame element with id ${I} doesn't exist`);Object.assign(S,{frameId:c.id}),S?.boundElements?.forEach(T=>{let A=i.getElement(T.id);if(!A)throw new Error(`Bound element with id ${T.id} doesn't exist`);Object.assign(A,{frameId:c.id}),u.push(A)}),u.push(S)});let[m,p,f,h]=Ge(u),E=10;m=m-E,p=p-E,f=f+E,h=h+E;let g=c?.x||m,x=c?.y||p,w=c?.width||f-m,y=c?.height||h-p;Object.assign(c,{x:g,y:x,width:w,height:y}),wg()&&d.children.length&&(c?.x||c?.y||c?.width||c?.height)&&console.info("User provided frame attributes are being considered, if you find this inaccurate, please remove any of the attributes - x, y, width and height so frame coordinates and dimensions are calculated automatically")}return i.getElements()};P();var lM=({app:e,event:t})=>{let n=e.state;if(n.selectedLinearElement&&e.lastPointerMoveCoords){if(n.selectedLinearElement.draggedFocusPointBinding)return Vc(n.selectedLinearElement,e.scene.getNonDeletedElementsMap(),e.lastPointerMoveCoords,e.scene,n,e.getEffectiveGridSize(),t.altKey),!0;if(n.selectedLinearElement.hoverPointIndex!==null&&e.lastPointerMoveEvent&&n.selectedLinearElement.initialState.lastClickedPoint>=0&&n.selectedLinearElement.isDragging)return O.handlePointDragging(e.lastPointerMoveEvent,e,e.lastPointerMoveCoords.x,e.lastPointerMoveCoords.y,n.selectedLinearElement),!0}return!1};var pM=e=>e.reduce((t,n)=>t+n.version,0),Zd=e=>{let t=5381;for(let n of Ig(e))t=(t<<5)+t+n.versionNonce;return t>>>0},qd=e=>{let t=5381;for(let n=0;n<e.length;n++){let i=e.charCodeAt(n);t=(t<<5)+t+i}return t>>>0},fM=e=>e.filter(t=>!t.isDeleted&&!_d(t)),hM=e=>e.filter(t=>!t.isDeleted),EM=e=>!e.isDeleted;export{En as AppStateDelta,Ol as BASE_BINDING_GAP,Cn as BASE_BINDING_GAP_ELBOW,ne as BASE_PADDING,un as BindableElement,cn as BoundElement,He as CaptureUpdateAction,s1 as DEFAULT_LINK_SIZE,eu as DEFAULT_OMIT_SIDES,W as Delta,Ds as DurableIncrement,Is as ElementBounds,gn as ElementsDelta,Bs as EphemeralIncrement,Oo as FOCUS_POINT_SIZE,Gc as FlowChartCreator,Cc as FlowChartNavigator,we as HEADING_DOWN,Re as HEADING_LEFT,he as HEADING_RIGHT,Ve as HEADING_UP,fh as INVISIBLY_SMALL_ELEMENT_SIZE,Cs as InvalidFractionalIndexError,O as LinearElementEditor,Pe as MINIMAL_CROP_SIZE,vA as OMIT_SIDES_FOR_FRAME,TA as OMIT_SIDES_FOR_MULTIPLE_ELEMENTS,ni as Scene,Ze as ShapeCache,jd as Store,Fi as StoreChange,Ls as StoreDelta,Xo as StoreIncrement,xn as StoreSnapshot,et as aabbForElement,Af as addElementsToFrame,YE as addNewNodes,i0 as addToGroup,mP as alignElements,zp as avoidRectangularCorner,bt as bindBindingElement,hd as bindElementsToFramesAfterDuplication,Gp as bindOrUnbindBindingElement,Iy as bindOrUnbindBindingElements,Lo as bindPointToSnapToElementOutline,Nl as bindingProperties,Dl as bumpVersion,_p as calculateFixedPointForElbowArrowBinding,Zn as calculateFixedPointForNonElbowArrowBinding,vw as canApplyRoundnessTypeToElement,Ua as canBecomePolygon,Ad as canChangeRoundness,hE as canCreateLinkFromElements,x1 as canHaveArrowheads,rr as canResizeFromSides,Un as charWidth,fe as compareHeading,bi as computeBoundTextPosition,kr as computeContainerDimensionForBoundText,nb as containsCJK,iM as convertToExcalidrawElements,rS as createPlaceholderEmbeddableLabel,zs as createSrcDoc,ww as cropElement,en as deconstructDiamondElement,uo as deconstructLinearOrFreeDrawElement,Jt as deconstructRectanguloidElement,vs as deepCopyElement,kI as defaultGetElementLinkFromSelection,Zw as detectLineHeight,on as distanceToElement,xI as distributeElements,Ln as doBoundsIntersect,BI as dragNewElement,vI as dragSelectedElements,Sh as duplicateElement,MP as duplicateElements,n0 as editGroupForSelectedElement,se as elementCenterPoint,mn as elementOverlapsWithFrame,Gi as elementWithCanvasCache,fn as elementsAreInFrameBounds,cd as elementsAreInSameGroup,aS as embeddableURLValidator,pd as excludeElementsInFramesFromSelection,z0 as filterElementsEligibleAsFrameChildren,Ay as fixBindingsAfterDeletion,Rl as fixDuplicatedBindingsAfterDuplication,jr as flipHeading,j0 as frameAndChildrenSelectedTogether,Za as generateLinearCollisionShape,ze as generateRoughOptions,yo as getAllHoveredElementAtPoint,el as getApproxMinLineHeight,Ja as getApproxMinLineWidth,zl as getArrowLocalFixedPoints,lh as getArrowheadAngle,bs as getArrowheadPoints,ah as getArrowheadSize,Xe as getBindingGap,My as getBindingSideMidPoint,os as getBindingStrategyForDraggingBindingElementEndpoints,$ as getBoundTextElement,Ft as getBoundTextElementId,fb as getBoundTextElementPosition,yi as getBoundTextMaxHeight,at as getBoundTextMaxWidth,Ss as getBoundsFromPoints,gt as getCenterForBounds,q1 as getClosestElementBounds,Wt as getCommonBoundingBox,Ge as getCommonBounds,mb as getContainerCenter,Nr as getContainerCoords,Ae as getContainerElement,Ut as getContainingFrame,Ct as getCornerRadius,Po as getCubicBezierCurveBound,zA as getCursorForResizingElement,Bf as getDefaultFrameName,Dw as getDefaultRoundnessTypeForElement,$a as getDiamondBaseCorners,_n as getDiamondPoints,DI as getDragOffsetXY,Z1 as getDraggedElementsBounds,V as getElementAbsoluteCoords,le as getElementBounds,ps as getElementLineSegments,as as getElementPointsCoords,Cd as getElementShape,RA as getElementWithTransformHandleType,Ed as getElementsCompletelyInFrame,Ce as getElementsInGroup,N0 as getElementsInNewFrame,R0 as getElementsInResizingFrame,L0 as getElementsIntersectingFrame,W0 as getElementsOverlappingFrame,us as getElementsWithinSelection,oS as getEmbedLink,bw as getFlipAdjustedCropPosition,pn as getFrameChildren,If as getFrameLikeElements,Y0 as getFrameLikeTitle,c1 as getFreedrawOutlineAsSegments,Jf as getFreedrawOutlinePoints,$e as getGlobalFixedPointForBindableElement,Up as getGlobalFixedPoints,vl as getHeadingForElbowArrowSnap,Rt as getHoveredElementForBinding,El as getHoveredElementForFocusPoint,JS as getInitializedImageElements,ho as getLineHeightInPx,nn as getLineWidth,Bw as getLinearElementSubType,yS as getLinkDirectionFromKey,FI as getLinkIdAndTypeFromSelection,Kl as getLockedLinearCursorAlignSize,Pm as getMaxCharWidth,r0 as getMaximumGroups,Kw as getMinCharWidth,Li as getMinMaxXYFromCurvePathOps,fo as getMinTextElementWidth,md as getNewGroupIdsForDuplication,hM as getNonDeletedElements,dd as getNonDeletedGroupIds,sP as getNormalizedDimensions,Jn as getObservedAppState,Ks as getOmitSidesForEditorInterface,Ww as getOriginalContainerHeightFromCache,As as getPerfectElementSize,Ys as getPredecessors,$1 as getRectangleBoxAbsoluteCoords,Uf as getRenderOpacity,bA as getResizeArrowDirection,wA as getResizeOffsetXY,Qt as getResizedElementAbsoluteCoords,F0 as getRootElements,pM as getSceneVersion,yt as getSelectedElements,No as getSelectedElementsByGroup,cs as getSelectedGroupForElement,xf as getSelectedGroupIdForElement,Ef as getSelectedGroupIds,x0 as getSelectionStateForElements,hm as getSnapOutlineMidPoint,g0 as getTargetElements,Tf as getTargetFrame,pb as getTextElementAngle,xb as getTextFromElements,ym as getTextHeight,tl as getTextWidth,NA as getTransformHandleTypeFromCoords,tu as getTransformHandles,Qs as getTransformHandlesFromCoords,ka as getUncroppedImageElement,Pr as getUncroppedWidthAndHeight,h0 as getVisibleAndNonSelectedElements,fM as getVisibleElements,K1 as getVisibleSceneBounds,k0 as groupByFrameLikes,G0 as groupsAreAtLeastIntersectingTheFrame,O0 as groupsAreCompletelyOutOfFrame,Bn as handleBindTextResize,Vc as handleFocusPointDrag,VS as handleFocusPointHover,jS as handleFocusPointPointerDown,XS as handleFocusPointPointerUp,p1 as hasBackground,ht as hasBoundTextElement,DA as hasBoundingBox,f1 as hasStrokeColor,E1 as hasStrokeStyle,h1 as hasStrokeWidth,Zd as hashElementsVersion,qd as hashString,Fe as headingForPoint,Ii as headingForPointFromElement,lt as headingForPointIsHorizontal,Ne as headingIsHorizontal,Wb as headingIsVertical,tp as hitElementBoundText,ep as hitElementBoundingBox,Nb as hitElementBoundingBoxOnly,tn as hitElementItself,rn as intersectElementWithLineSegment,Tw as isArrowBoundToElement,H as isArrowElement,ce as isBindableElement,Yr as isBindableElementInsideOtherBindable,Se as isBindingElement,om as isBindingElementType,wt as isBindingEnabled,ue as isBoundToContainer,C0 as isCursorInFrame,nm as isCurvedArrow,_ as isElbowArrow,rP as isElementCompletelyInViewport,fs as isElementContainingFrame,xd as isElementInFrame,gf as isElementInGroup,fd as isElementInViewport,Kn as isElementIntersectingFrame,RI as isElementLink,Ra as isEmbeddableElement,Mw as isExcalidrawElement,Ir as isFlowchartNodeElement,tr as isFocusPointVisible,co as isFrameElement,q as isFrameLikeElement,Ie as isFreeDrawElement,em as isFreeDrawElementType,qE as isHTMLSVGElement,ao as isIframeElement,lo as isIframeLikeElement,xe as isImageElement,ud as isInGroup,Mn as isInitializedImageElement,_d as isInvisiblySmallElement,Bt as isLineElement,K as isLinearElement,im as isLinearElementType,Na as isMagicFrameElement,$w as isMeasureTextSupported,PS as isNodeInFlowchart,EM as isNonDeletedElement,vn as isPathALoop,Gt as isPointInElement,Ei as isRectangularElement,za as isRectanguloidElement,hf as isSelectedViaGroup,tm as isSharpArrow,Aw as isSimpleArrow,E0 as isSomeElementSelected,rm as isTextBindableContainer,ee as isTextElement,Ha as isUsingAdaptiveRadius,_a as isUsingProportionalRadius,Lw as isValidPolygon,gb as isValidTextContainer,ZE as loadHTMLImageElement,ds as makeNextSelectedElementIds,Et as maxBindingDistance_simple,lM as maybeHandleArrowPointlikeDrag,sS as maybeParseEmbedSrc,$s as measureFontSizeFromWidth,We as measureText,OS as moveAllLeft,kS as moveAllRight,_c as moveArrowAboveBindable,CS as moveOneLeft,GS as moveOneRight,be as mutateElement,Qo as newArrowElement,Fn as newElement,De as newElementWith,$I as newEmbeddableElement,yc as newFrameElement,KI as newFreeDrawElement,ZI as newIframeElement,Ac as newImageElement,Sc as newLinearElement,Pc as newMagicFrameElement,Rn as newTextElement,Ud as normalizeElementOrder,Di as normalizeFixedPoint,eA as normalizeSVG,wi as normalizeText,zo as omitGroupsContainingFrameLikes,Sf as omitPartialGroups,ic as orderByFractionalIndex,xi as originalContainerCache,NI as parseElementLinkFromURL,Dm as parseTokens,sn as pointInsideBounds,rA as positionElementsOnGrid,Dr as projectFixedPointOntoDiagonal,xo as redrawTextBoundingBox,qI as refreshTextDimensions,Mf as removeAllElementsFromFrame,gd as removeElementsFromFrame,o0 as removeFromSelectedGroups,d1 as renderElement,l1 as renderFrameBackground,a1 as renderSelectionElement,H0 as replaceAllElementsInFrame,qc as rescalePointsInElement,Ka as resetOriginalContainerCache,rg as resizeMultipleElements,ng as resizeSingleElement,JE as resizeSingleTextElement,lg as resizeTest,ff as selectGroup,ad as selectGroupsForSelectedElements,ld as selectGroupsFromGivenElements,qw as setCustomTextMetricsProvider,hb as shouldAllowVerticalAlign,U0 as shouldApplyFrameClip,Py as shouldEnableBindingForPointerEvent,bo as shouldTestInside,YA as showSelectedShapeActions,rs as snapToMid,Eb as suppportsHorizontalAlign,Os as syncInvalidIndices,$d as syncInvalidIndicesImmutable,Ni as syncMovedIndices,ql as toggleLinePolygonState,g1 as toolIsArrow,xA as transformElements,Te as unbindBindingElement,Sy as updateBindings,ve as updateBoundElements,dt as updateBoundPoint,Wn as updateElbowArrowPoints,_0 as updateFrameMembershipOfSelectedElements,QS as updateImageCache,qa as updateOriginalContainerCache,Tl as validateElbowPoints,Gh as validateFractionalIndices,Nt as vectorToHeading,kt as wrapText};
